<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReqRight — Free Systems Engineering Tool</title>
<meta name="description" content="ReqRight — Free systems engineering workbench with 6 integrated modules: Requirements, Risks, Decisions, Stakeholders, Interfaces, Use Cases. INCOSE GtWR v4 quality analysis, 42 rules, cross-module traceability, configurable PDF reports. No login. Your data stays on your machine.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#06080f;--bg2:#0a0f1c;--surface:#0f1628;--surfAlt:#131b30;
  --card:#141c32;--cardHov:#1a2440;--border:#1c2744;--borderHi:#2a3a60;
  --text:#e2e8f0;--textMid:#a0aec0;--textDim:#6b7fa0;
  --accent:#38bdf8;--accentDim:#0c4a6e;--success:#10b981;--successDim:#064e3b;
  --warn:#f59e0b;--warnDim:#78350f;--danger:#ef4444;--dangerDim:#7f1d1d;
  --purple:#a78bfa;--purpleDim:#4c1d95;--teal:#2dd4bf;--orange:#fb923c;--pink:#f472b6;
  --bodyBg:linear-gradient(160deg,var(--bg),var(--bg2),#0d1424);
}
/* Light Theme */
:root.light {
  --bg:#f8fafc;--bg2:#f1f5f9;--surface:#ffffff;--surfAlt:#f8fafc;
  --card:#ffffff;--cardHov:#f1f5f9;--border:#e2e8f0;--borderHi:#cbd5e1;
  --text:#1e293b;--textMid:#3f5275;--textDim:#64748b;
  --accent:#0284c7;--accentDim:#e0f2fe;--success:#059669;--successDim:#d1fae5;
  --warn:#d97706;--warnDim:#fef3c7;--danger:#dc2626;--dangerDim:#fee2e2;
  --purple:#7c3aed;--purpleDim:#ede9fe;--teal:#0d9488;--orange:#ea580c;--pink:#db2777;
  --bodyBg:linear-gradient(160deg,#f8fafc,#f1f5f9,#e2e8f0);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bodyBg);color:var(--text);font-family:'DM Sans','Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.6;min-height:100vh;transition:background .3s,color .3s;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px;letter-spacing:.03em;}
button{font-family:inherit;}
select option{background:var(--surface);color:var(--text);}
input:focus,textarea:focus,select:focus{border-color:var(--accent)!important;outline:none;}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

.btn{padding:8px 18px;border-radius:8px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.btn-pri{background:var(--accent);color:var(--bg);}
.btn-pri:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn-sec{background:transparent;border:1px solid var(--border);color:var(--textMid);}
.btn-sec:hover{border-color:var(--borderHi);background:var(--surface);}
.btn-danger{background:transparent;border:1px solid #ef444444;color:var(--danger);}
.btn-ai{background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff;padding:14px 32px;font-size:15px;border-radius:10px;box-shadow:0 4px 20px #a78bfa44;}
.btn-ai:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn-ai:disabled{opacity:.5;cursor:wait;}

.input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:14px;transition:border .15s;}
.label{font-size:12px;color:var(--textMid);font-weight:600;text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:6px;}
.card{background:var(--card);border-radius:14px;padding:24px;border:1px solid var(--border);}
.badge{font-size:11px;padding:3px 9px;border-radius:5px;font-weight:600;white-space:nowrap;display:inline-block;}

.header{padding:0;border-bottom:1px solid var(--border);background:rgba(15,22,40,.88);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100;}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:10px 28px;}
.header-nav{display:flex;padding:0 28px 10px;overflow-x:auto;}
.nav{display:flex;gap:3px;background:var(--surface);border-radius:10px;padding:3px;border:1px solid var(--border);flex-shrink:0;}
.nav button{padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:500;background:transparent;color:var(--textMid);transition:all .15s;}
.nav button:hover{background:var(--card);color:var(--text);}
.nav button.active{font-weight:600;background:var(--accent);color:var(--bg);}
.nav-sep{width:1px;height:24px;background:var(--border);align-self:center;margin:0 6px;flex-shrink:0;}

.grid-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-bottom:28px;}
.stat-card{position:relative;overflow:hidden;padding:20px;}
.stat-card .icon{position:absolute;top:-8px;right:-8px;font-size:56px;opacity:.04;}
.stat-val{font-size:32px;font-weight:700;margin-top:6px;}

.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease;}
.modal{background:var(--card);border-radius:16px;padding:32px;border:1px solid var(--border);box-shadow:0 24px 64px rgba(0,0,0,.6);}

.ai-panel{background:linear-gradient(135deg,#4c1d9544,#0c4a6e44);border-radius:14px;padding:20px;border:1px solid #a78bfa44;margin-bottom:14px;position:relative;overflow:hidden;}
.ai-panel .bg-icon{position:absolute;top:-20px;right:-20px;font-size:120px;opacity:.04;color:var(--purple);}
.success-panel{background:#064e3b33;border-radius:14px;padding:16px;border:1px solid #10b98133;margin-bottom:14px;display:flex;align-items:center;gap:12px;}

.toast{position:fixed;top:20px;right:20px;z-index:9999;padding:12px 24px;border-radius:10px;color:#fff;font-size:14px;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:slideIn .3s ease;display:flex;align-items:center;gap:8px;}

.welcome-overlay{position:fixed;inset:0;z-index:2000;background:rgba(6,8,15,.95);backdrop-filter:blur(30px);display:flex;align-items:center;justify-content:center;animation:fadeIn .4s ease;}
.welcome-card{max-width:640px;text-align:center;padding:48px;}
.welcome-logo{width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;margin:0 auto 24px;box-shadow:0 12px 40px #38bdf833;}

.file-drop{border:2px dashed var(--border);border-radius:14px;padding:40px;text-align:center;cursor:pointer;transition:all .2s;}
.file-drop:hover,.file-drop.dragover{border-color:var(--accent);background:var(--accentDim)22;}

@media(max-width:1024px){.header-top{padding:8px 16px;}.header-nav{padding:0 16px 8px;}.nav{overflow-x:auto;flex-shrink:1;}}
@media(max-width:768px){.header-top{padding:8px 12px;}.header-nav{padding:0 12px 8px;}.nav button{padding:7px 12px;font-size:12px;}}
.risk-card,.dec-card{margin-bottom:12px;transition:border-color .2s;}
.risk-card:hover,.dec-card:hover{border-color:var(--borderHi);}
</style>
</head>
<body>
<div id="app"></div>

<script>
// ═══════════════════════════════════════════════════════════════════
// INCOSE REQUIREMENTS WORKBENCH — COMPLETE STANDALONE APPLICATION
// GtWR v4 · 42 Rules · AI Quality Engine · ReqIF/DOORS Export
// ═══════════════════════════════════════════════════════════════════

const RULES=[
{id:"R1",nm:"Structured Statements",cat:"Accuracy",desc:"Conform to agreed patterns",ck:t=>{const p=/^(When\s|If\s|During\s|The\s|While\s|Upon\s|After\s|Before\s|Given\s)/i.test(t.trim()),s=/\bshall\b/i.test(t);return{pass:p&&s,msg:s?(p?"Good structure":"Start with condition or subject entity"):"Missing 'shall' keyword"}}},
{id:"R2",nm:"Active Voice",cat:"Accuracy",desc:"Use active voice",ck:t=>{const m=/\b(shall be \w+ed|is \w+ed by|are \w+ed by|was \w+ed|were \w+ed|been \w+ed)\b/i.test(t);return{pass:!m,msg:m?"Passive voice — identify responsible entity":"Active voice OK"}}},
{id:"R3",nm:"Subject-Verb",cat:"Accuracy",desc:"Subject appropriate to entity",ck:t=>{const m=/^(The user|Users|A user|Operators?)\s+shall\b/i.test(t.trim());return{pass:!m,msg:m?"Obligation on user — rewrite with system as subject":"Subject-verb OK"}}},
{id:"R4",nm:"Defined Terms",cat:"Accuracy",desc:"All terms in glossary",ck:t=>({pass:true,msg:"Verify terms in glossary",warn:true})},
{id:"R5",nm:"Definite Articles",cat:"Accuracy",desc:"Use 'the' not 'a/an'",ck:t=>{const m=/\b(a |an )(system|module|component|subsystem|interface|unit|device|sensor|controller|processor|server|display|network)\b/i.test(t);return{pass:!m,msg:m?"Use 'the' for specific entities":"Definite articles OK"}}},
{id:"R6",nm:"Units of Measure",cat:"Accuracy",desc:"Consistent units",ck:t=>{const n=/\d+\.?\d*/.test(t),u=/\d+\.?\d*\s*(m|km|kg|g|s|ms|µs|Hz|kHz|MHz|GHz|°C|°F|K|V|mV|A|mA|W|kW|dB|dBm|Mbps|Gbps|mm|cm|µm|nm|bar|Pa|kPa|MPa|psi|lbs|ft|in|mi|knots|NM|%|rpm|rad|deg)\b/i.test(t);return{pass:!n||u,msg:n&&!u?"Number without units":"Units OK"}}},
{id:"R7",nm:"Vague Terms",cat:"Accuracy",desc:"Avoid vague terms",ck:t=>{const vt=["adequate","reasonable","sufficient","appropriate","fast","slow","user-friendly","easy","simple","robust","flexible","scalable","efficient","effective","reliable","safe","secure","quickly","approximately","nearly","roughly","about","good","bad","nice","better","best","worst","minimal","maximal","few","many","several","some","most","often","sometimes","usually","typically","normally","generally","sufficiently","adequately","optimal","improved","enhanced","acceptable","proper","suitable","satisfactory","promptly","timely"];const f=vt.filter(v=>new RegExp("\\b"+v+"\\b","i").test(t));return{pass:f.length===0,msg:f.length>0?'Vague: "'+f.join('", "')+'" — use measurable criteria':"No vague terms"}}},
{id:"R8",nm:"Escape Clauses",cat:"Accuracy",desc:"Avoid escape clauses",ck:t=>{const ec=["where possible","as appropriate","if necessary","as required","to the extent practicable","where applicable","as needed","if feasible","when practical","as far as possible","unless otherwise specified"];const f=ec.filter(e=>t.toLowerCase().includes(e));return{pass:f.length===0,msg:f.length>0?'Escape: "'+f.join('", "')+'"':"No escape clauses"}}},
{id:"R9",nm:"Open-Ended",cat:"Accuracy",desc:"Avoid open-ended clauses",ck:t=>{const oe=["including but not limited to","etc.","etc","and so on","and so forth","such as","for example","e.g.","i.e.","among others","and the like"];const f=oe.filter(e=>t.toLowerCase().includes(e));return{pass:f.length===0,msg:f.length>0?'Open-ended: "'+f.join('", "')+'"':"No open-ended clauses"}}},
{id:"R10",nm:"Superfluous Infinitives",cat:"Concision",desc:"Avoid 'be able to'",ck:t=>{const si=["shall be able to","shall be capable of","shall have the ability to","shall have the capability to","shall provide the ability to"];const f=si.filter(e=>t.toLowerCase().includes(e));return{pass:f.length===0,msg:f.length>0?"Superfluous infinitive — simplify":"No superfluous infinitives"}}},
{id:"R11",nm:"Separate Clauses",cat:"Concision",desc:"Separate conditions",ck:t=>({pass:true,msg:"Verify separate clauses",warn:true})},
{id:"R12",nm:"Grammar",cat:"Non-Ambiguity",desc:"Correct grammar",ck:t=>({pass:true,msg:"Manual grammar review",warn:true})},
{id:"R13",nm:"Spelling",cat:"Non-Ambiguity",desc:"Correct spelling",ck:t=>({pass:true,msg:"Verify spelling",warn:true})},
{id:"R14",nm:"Punctuation",cat:"Non-Ambiguity",desc:"Correct punctuation",ck:t=>{const p=/\.\s*$/.test(t.trim());return{pass:p,msg:p?"OK":"End with period"}}},
{id:"R15",nm:"Logical Expressions",cat:"Non-Ambiguity",desc:"Use [X AND Y]",ck:t=>{const h=/\b(and|or)\b/i.test(t),f=/\[(.*?)\s+(AND|OR|XOR)\s+(.*?)\]/i.test(t);return{pass:!h||f,msg:h&&!f?"Use [X AND Y] notation":"OK",warn:h&&!f}}},
{id:"R16",nm:'Use of "Not"',cat:"Non-Ambiguity",desc:"Avoid 'not'",ck:t=>{const m=/\bshall not\b|\bnot\b/i.test(t);return{pass:!m,msg:m?"Negative — rewrite positively":"Positive phrasing OK"}}},
{id:"R17",nm:"Oblique /",cat:"Non-Ambiguity",desc:"Avoid '/'",ck:t=>{const c=t.replace(/\d+\.?\d*\s*\w+\/\w+/g,"");return{pass:!/\//.test(c),msg:/\//.test(c)?"'/' — use 'and'/'or'":"OK"}}},
{id:"R18",nm:"Single Thought",cat:"Singularity",desc:"One thought per req",ck:t=>{const c=(t.match(/\bshall\b/gi)||[]).length;return{pass:c<=1,msg:c>1?c+" 'shall' — split":"Single thought OK"}}},
{id:"R19",nm:"Combinators",cat:"Singularity",desc:"Avoid clause combinators",ck:t=>{const m=/\b(and shall|or shall|then shall|unless|however|moreover|furthermore|additionally)\b/i.test(t);return{pass:!m,msg:m?"Combinators — split":"OK"}}},
{id:"R20",nm:"Purpose Phrases",cat:"Singularity",desc:"Avoid 'in order to'",ck:t=>{const m=/\b(in order to|so that|for the purpose of|with the aim of|so as to)\b/i.test(t);return{pass:!m,msg:m?"Purpose phrase — move to rationale":"OK"}}},
{id:"R21",nm:"Parentheses",cat:"Singularity",desc:"Avoid parenthetical text",ck:t=>{const m=/\([^)]{10,}\)/.test(t);return{pass:!m,msg:m?"Parenthetical — move to rationale":"OK"}}},
{id:"R22",nm:"Enumeration",cat:"Singularity",desc:"Enumerate explicitly",ck:t=>({pass:true,msg:"Verify enumeration",warn:true})},
{id:"R23",nm:"Diagrams",cat:"Singularity",desc:"Reference diagrams",ck:t=>({pass:true,msg:"Consider diagrams",warn:true})},
{id:"R24",nm:"Pronouns",cat:"Completeness",desc:"Avoid pronouns",ck:t=>{const m=/\b(it|its|they|them|their|theirs|this|that|these|those|he|she|his|her|we|our|you|your)\b/i.test(t);return{pass:!m,msg:m?"Pronouns — use entity names":"OK"}}},
{id:"R25",nm:"Headings",cat:"Completeness",desc:"Self-contained",ck:t=>({pass:true,msg:"Verify self-contained",warn:true})},
{id:"R26",nm:"Absolutes",cat:"Realism",desc:"Avoid absolutes",ck:t=>{const m=/\b(100\s*%|always|never|all\s+times|every\s+time|zero\s+defects|infinite|unlimited)\b/i.test(t);return{pass:!m,msg:m?"Absolute — use achievable target":"OK"}}},
{id:"R27",nm:"Explicit Conditions",cat:"Conditions",desc:"State conditions",ck:t=>{const h=/^(When|If|During|Upon|After|Before|While|Given)\b/i.test(t.trim()),n=/\bshall\b/i.test(t)&&!h;return{pass:!n||t.trim().startsWith("The"),msg:n?"Add conditions (When/If...)":"OK",warn:n}}},
{id:"R28",nm:"Multiple Conditions",cat:"Conditions",desc:"AND/OR conditions",ck:t=>({pass:true,msg:"Verify AND/OR",warn:true})},
{id:"R29",nm:"Classification",cat:"Uniqueness",desc:"Classify by type",ck:t=>({pass:true,msg:"Verify classified",warn:true})},
{id:"R30",nm:"Unique Expression",cat:"Uniqueness",desc:"No duplicates",ck:t=>({pass:true,msg:"Verify unique",warn:true})},
{id:"R31",nm:"Solution Free",cat:"Abstraction",desc:"No implementation",ck:t=>{const m=/\b(shall use|shall implement|shall employ|SQL|MySQL|PostgreSQL|MongoDB|Java|Python|C\+\+|JavaScript|REST\s*API|HTTP|TCP|UDP|AWS|Azure|GCP|Docker|Kubernetes|Linux|Windows|Oracle)\b/i.test(t);return{pass:!m,msg:m?"Implementation detail — what not how":"Solution-free OK"}}},
{id:"R32",nm:"Quantifiers",cat:"Quantifiers",desc:"Use 'each'",ck:t=>{const m=/\b(all|any|both|every)\b/i.test(t);return{pass:!m,msg:m?"Use 'each' for clarity":"OK"}}},
{id:"R33",nm:"Tolerances",cat:"Tolerance",desc:"Define ranges",ck:t=>{const sv=/\b(\d+\.?\d*)\s*(m|km|kg|s|ms|Hz|MHz|GHz|°C|V|A|W|dB|Mbps|mm|cm|%)\b/i.test(t),hr=/[±≤≥<>]|\bto\b|\bthrough\b|\bbetween\b|\brange\b/i.test(t);return{pass:!sv||hr,msg:sv&&!hr?"Single value — add ± tolerance":"OK"}}},
{id:"R34",nm:"Measurable",cat:"Quantification",desc:"Specific targets",ck:t=>{const s=/\bshall\b/i.test(t),m=/\d+/.test(t)||/\b(per|within|at least|no more than|maximum|minimum|greater than|less than)\b/i.test(t);return{pass:!s||m,msg:s&&!m?"Add measurable criteria":"OK",warn:s&&!m}}},
{id:"R35",nm:"Temporal",cat:"Quantification",desc:"Explicit timing",ck:t=>{const m=/\b(eventually|soon|before long|in due time|at some point|later|promptly|immediately|real-time|real time)\b/i.test(t);return{pass:!m,msg:m?"Vague timing — specify":"OK"}}},
{id:"R36",nm:"Consistent Terms",cat:"Uniformity",desc:"Consistent usage",ck:t=>({pass:true,msg:"Verify consistency",warn:true})},
{id:"R37",nm:"Acronyms",cat:"Uniformity",desc:"Define acronyms",ck:t=>{const f=t.match(/\b[A-Z]{2,}\b/g);return{pass:true,msg:f?"Acronyms: "+f.join(", "):"No acronyms",warn:!!f}}},
{id:"R38",nm:"Abbreviations",cat:"Uniformity",desc:"Avoid abbreviations",ck:t=>{const m=/\b(approx|max|min|temp|freq|vol|amt|qty|req|spec|doc|info|config|auth|admin|msg|tbd|tbc|tba)\b/i.test(t);return{pass:!m,msg:m?"Abbreviation — use full word":"OK"}}},
{id:"R39",nm:"Style Guide",cat:"Uniformity",desc:"Follow style",ck:t=>({pass:true,msg:"Verify style",warn:true})},
{id:"R40",nm:"Decimals",cat:"Uniformity",desc:"Consistent decimals",ck:t=>({pass:true,msg:"Verify decimals",warn:true})},
{id:"R41",nm:"Related Reqs",cat:"Modularity",desc:"Group related",ck:t=>({pass:true,msg:"Verify grouping",warn:true})},
{id:"R42",nm:"Structured Sets",cat:"Modularity",desc:"Follow template",ck:t=>({pass:true,msg:"Verify structure",warn:true})}
];

const CATS=[
{nm:"Accuracy",r:"R1–R9",c:"#3b82f6"},{nm:"Concision",r:"R10–R11",c:"#8b5cf6"},
{nm:"Non-Ambiguity",r:"R12–R17",c:"#06b6d4"},{nm:"Singularity",r:"R18–R23",c:"#10b981"},
{nm:"Completeness",r:"R24–R25",c:"#f59e0b"},{nm:"Realism",r:"R26",c:"#ef4444"},
{nm:"Conditions",r:"R27–R28",c:"#6366f1"},{nm:"Uniqueness",r:"R29–R30",c:"#a855f7"},
{nm:"Abstraction",r:"R31",c:"#14b8a6"},{nm:"Quantifiers",r:"R32",c:"#eab308"},
{nm:"Tolerance",r:"R33",c:"#e11d48"},{nm:"Quantification",r:"R34–R35",c:"#2563eb"},
{nm:"Uniformity",r:"R36–R40",c:"#7c3aed"},{nm:"Modularity",r:"R41–R42",c:"#059669"}
];

const REQ_TYPES=["Functional","Performance","Interface","Environmental","Safety","Security","Reliability","Maintainability","Availability","Human Factors","Physical","Constraint","Regulatory","Quality","Design","Operational"];
const V_METHODS=["Test","Analysis","Inspection","Demonstration"];
const REQ_LEVELS=["Stakeholder Need","System Requirement","Subsystem Requirement","Component Requirement"];
const PRIORITIES=["Critical","High","Medium","Low"];
const STATUSES=["Draft","Under Review","Reviewed","Approved","Rejected","Deferred"];
const PATTERNS=[
{nm:"Basic",t:"The [entity] shall [action] [object]."},
{nm:"Conditional",t:"When [condition], the [entity] shall [action] [object]."},
{nm:"Performance",t:"The [entity] shall [action] [object] within [measure ± tolerance]."},
{nm:"Cond+Perf",t:"When [condition], the [entity] shall [action] [object] within [measure ± tolerance]."},
{nm:"While",t:"While [state], the [entity] shall [action] [object] [qualification]."},
{nm:"Interface",t:"The [entity] shall [send/receive] [data] [to/from] the [external entity] via the [interface]."}
];

// ─── DECISION LOG CONSTANTS ──────────────────────────────
const DEC_STATUSES=["Proposed","Approved","Superseded","Rejected","Deferred"];
const DEC_CATEGORIES=["Architectural","Design","Technology","Process","Interface","Safety","Security","Performance","Trade-off","Requirement","Other"];

// ─── RISK REGISTER CONSTANTS ─────────────────────────────
const LIKELIHOOD=["1 - Rare","2 - Unlikely","3 - Possible","4 - Likely","5 - Almost Certain"];
const IMPACT=["1 - Negligible","2 - Minor","3 - Moderate","4 - Major","5 - Severe"];
const RISK_STATUS=["Open","Mitigated","Accepted","Closed"];
const RISK_CATEGORIES=["Technical","Schedule","Cost","Resource","External","Safety","Security"];
const STK_ROLES=["End User","Operator","Maintainer","Sponsor","Regulator","Acquirer","Developer","Tester","Project Manager","System Architect","Domain Expert","Other"];
const STK_INFLUENCE=["Critical","High","Medium","Low"];
const STK_CATEGORIES=["Internal","External","Customer","Supplier","Regulatory","Support"];
const IFC_TYPES=["Data","Electrical","Mechanical","Software","Thermal","Optical","Fluid","Human-Machine","Network","Power","Other"];
const IFC_DIRECTIONS=["Unidirectional →","Bidirectional ↔","Broadcast ⇉"];
const IFC_STATUSES=["Draft","Defined","Agreed","Verified","Deprecated"];
const IFC_PROTOCOLS=["SPI","I2C","UART","USB","Ethernet","TCP/IP","MQTT","HTTP/REST","CAN","Bluetooth","Wi-Fi","Zigbee","Analog","Digital","Custom"];
const UC_TYPES=["Operational","Maintenance","Emergency","Installation","Diagnostic","Training","Degraded Mode"];
const UC_STATUSES=["Draft","Reviewed","Validated","Approved","Deprecated"];
const UC_PRIORITIES=["Critical","High","Medium","Low"];

// ─── REQUIREMENT TEMPLATES ────────────────────────────────
const REQ_TEMPLATES=[
  {cat:"Functional",templates:[
    {name:"Data Processing",text:"The [System_Name] shall process [data_type] within [time_value] [time_unit] of receipt.",type:"Functional",level:"System Requirement",verification:"Test"},
    {name:"User Authentication",text:"The [System_Name] shall authenticate the user identity using [authentication_method] before granting access to [protected_resource].",type:"Functional",level:"System Requirement",verification:"Test"},
    {name:"Data Storage",text:"The [System_Name] shall store [data_type] for a minimum of [duration] in [storage_location].",type:"Functional",level:"System Requirement",verification:"Test"},
    {name:"Notification",text:"The [System_Name] shall notify the [user_role] within [time_value] [time_unit] when [trigger_condition] occurs.",type:"Functional",level:"System Requirement",verification:"Demonstration"},
    {name:"Data Conversion",text:"The [System_Name] shall convert [input_format] to [output_format] with no loss of [quality_attribute].",type:"Functional",level:"Subsystem Requirement",verification:"Test"},
    {name:"State Transition",text:"The [System_Name] shall transition from [state_A] to [state_B] when [trigger_event] is detected.",type:"Functional",level:"System Requirement",verification:"Test"},
  ]},
  {cat:"Performance",templates:[
    {name:"Response Time",text:"The [System_Name] shall respond to [user_action] within [time_value] [time_unit] under [load_condition].",type:"Performance",level:"System Requirement",verification:"Test"},
    {name:"Throughput",text:"The [System_Name] shall process a minimum of [quantity] [item_type] per [time_unit] under normal operating conditions.",type:"Performance",level:"System Requirement",verification:"Test"},
    {name:"Capacity",text:"The [System_Name] shall support a minimum of [quantity] concurrent [user_type] without degradation of [quality_attribute].",type:"Performance",level:"System Requirement",verification:"Test"},
    {name:"Startup Time",text:"The [System_Name] shall be fully operational within [time_value] [time_unit] of power-on.",type:"Performance",level:"System Requirement",verification:"Test"},
    {name:"Latency",text:"The [System_Name] shall transmit [data_type] with a maximum latency of [time_value] [time_unit] between [source] and [destination].",type:"Performance",level:"Subsystem Requirement",verification:"Test"},
  ]},
  {cat:"Interface",templates:[
    {name:"Protocol Compliance",text:"The [System_Name] shall communicate with [External_System] using [protocol_name] version [version_number].",type:"Interface",level:"System Requirement",verification:"Test"},
    {name:"Data Exchange",text:"The [System_Name] shall send [data_type] to [External_System] at a rate of [rate_value] [rate_unit].",type:"Interface",level:"Subsystem Requirement",verification:"Test"},
    {name:"API Endpoint",text:"The [System_Name] shall provide a [REST/SOAP] API for [External_System] to [action] [data_type].",type:"Interface",level:"System Requirement",verification:"Demonstration"},
    {name:"Connector",text:"The [System_Name] shall provide a [connector_type] physical interface for connection to [External_System].",type:"Interface",level:"Component Requirement",verification:"Inspection"},
  ]},
  {cat:"Safety",templates:[
    {name:"Fault Detection",text:"The [System_Name] shall detect [fault_type] within [time_value] [time_unit] of occurrence.",type:"Safety",level:"System Requirement",verification:"Test"},
    {name:"Safe State",text:"The [System_Name] shall transition to a safe state within [time_value] [time_unit] upon detection of [hazard_condition].",type:"Safety",level:"System Requirement",verification:"Test"},
    {name:"Redundancy",text:"The [System_Name] shall provide [redundancy_type] redundancy for [critical_function] to ensure continued operation upon single-point failure.",type:"Safety",level:"System Requirement",verification:"Analysis"},
    {name:"Emergency Shutdown",text:"The [System_Name] shall initiate an emergency shutdown within [time_value] [time_unit] when [emergency_condition] is detected.",type:"Safety",level:"System Requirement",verification:"Demonstration"},
  ]},
  {cat:"Security",templates:[
    {name:"Encryption",text:"The [System_Name] shall encrypt [data_type] using [encryption_standard] with a minimum key length of [key_length] bits.",type:"Security",level:"System Requirement",verification:"Test"},
    {name:"Access Control",text:"The [System_Name] shall restrict access to [resource] to users with [role/permission] authorization.",type:"Security",level:"System Requirement",verification:"Test"},
    {name:"Audit Logging",text:"The [System_Name] shall log all [event_type] events including timestamp, user identity, and action performed.",type:"Security",level:"System Requirement",verification:"Demonstration"},
    {name:"Session Timeout",text:"The [System_Name] shall terminate inactive user sessions after [time_value] [time_unit] of inactivity.",type:"Security",level:"System Requirement",verification:"Test"},
  ]},
  {cat:"Reliability",templates:[
    {name:"MTBF",text:"The [System_Name] shall have a Mean Time Between Failures (MTBF) of no less than [time_value] [time_unit] under [operating_conditions].",type:"Reliability",level:"System Requirement",verification:"Analysis"},
    {name:"Availability",text:"The [System_Name] shall maintain an availability of [percentage]% or higher measured over a [time_period] period.",type:"Reliability",level:"System Requirement",verification:"Analysis"},
    {name:"Error Recovery",text:"The [System_Name] shall recover from [error_type] within [time_value] [time_unit] without loss of [data_type].",type:"Reliability",level:"System Requirement",verification:"Test"},
  ]},
  {cat:"Environmental",templates:[
    {name:"Temperature Range",text:"The [System_Name] shall operate within the temperature range of [min_temp]°C to [max_temp]°C.",type:"Environmental",level:"System Requirement",verification:"Test"},
    {name:"Humidity",text:"The [System_Name] shall operate in relative humidity from [min_humidity]% to [max_humidity]% non-condensing.",type:"Environmental",level:"System Requirement",verification:"Test"},
    {name:"Vibration",text:"The [System_Name] shall withstand vibration levels up to [vibration_value] [vibration_unit] across [frequency_range] Hz.",type:"Environmental",level:"Component Requirement",verification:"Test"},
    {name:"Ingress Protection",text:"The [System_Name] shall provide a minimum ingress protection rating of IP[rating] per IEC 60529.",type:"Environmental",level:"Component Requirement",verification:"Inspection"},
  ]},
  {cat:"Maintainability",templates:[
    {name:"MTTR",text:"The [System_Name] shall have a Mean Time To Repair (MTTR) of no more than [time_value] [time_unit] for [maintenance_type] maintenance.",type:"Maintainability",level:"System Requirement",verification:"Demonstration"},
    {name:"Module Replacement",text:"The [System_Name] shall allow replacement of [module_name] by [skill_level] personnel using [tool_type] tools within [time_value] [time_unit].",type:"Maintainability",level:"Component Requirement",verification:"Demonstration"},
    {name:"Diagnostics",text:"The [System_Name] shall provide built-in diagnostics that identify [fault_type] to the [LRU/module] level.",type:"Maintainability",level:"System Requirement",verification:"Demonstration"},
  ]},
  {cat:"Regulatory",templates:[
    {name:"Standard Compliance",text:"The [System_Name] shall comply with [Standard_Name] version [version] Section [section_number].",type:"Regulatory",level:"System Requirement",verification:"Inspection"},
    {name:"Data Privacy",text:"The [System_Name] shall handle personal data in accordance with [regulation_name] requirements for [data_category].",type:"Regulatory",level:"System Requirement",verification:"Inspection"},
    {name:"Certification",text:"The [System_Name] shall meet the requirements for [certification_body] [certification_type] certification.",type:"Regulatory",level:"System Requirement",verification:"Analysis"},
  ]},
];

// ─── ANALYSIS ──────────────────────────────────────────────
function analyze(text){
  if(!text||!text.trim())return{score:0,results:[],grade:"N/A",passed:0,failed:0,warnings:0};
  const w=S.ruleWeights||{};
  const results=RULES.map(r=>{const res=r.ck(text);return{...r,...res,weight:w[r.id]??1};});
  const passed=results.filter(r=>r.pass&&!r.warn&&(w[r.id]??1)>0).length;
  const failed=results.filter(r=>!r.pass&&(w[r.id]??1)>0).length;
  const warnings=results.filter(r=>r.warn).length;
  // Weighted scoring: sum(weight*pass) / sum(weight) for non-warn rules with weight > 0
  const scorable=results.filter(r=>!r.warn&&(r.weight||0)>0);
  let wPassed=0,wTotal=0;
  scorable.forEach(r=>{wTotal+=r.weight;if(r.pass)wPassed+=r.weight;});
  const score=wTotal>0?Math.round(wPassed/wTotal*100):50;
  let grade="F";
  if(score>=95)grade="A+";else if(score>=90)grade="A";else if(score>=85)grade="B+";
  else if(score>=80)grade="B";else if(score>=75)grade="C+";else if(score>=70)grade="C";else if(score>=60)grade="D";
  return{score,results,grade,passed,failed,warnings};
}

// ─── RULE WEIGHT PRESETS ─────────────────────────────────
const WEIGHT_LABELS={0:"Off",0.5:"Low",1:"Normal",2:"High",3:"Critical"};
const WEIGHT_COLORS={0:"var(--textDim)",0.5:"var(--warn)",1:"var(--text)",2:"var(--accent)",3:"var(--danger)"};
const WEIGHT_PRESETS={
  equal:{name:"Equal (Default)",desc:"All rules weighted equally",weights:Object.fromEntries(RULES.map(r=>[r.id,1]))},
  safety:{name:"Safety-Critical",desc:"Emphasizes accuracy, completeness, measurability",weights:Object.fromEntries(RULES.map(r=>{
    const hi=["R1","R2","R7","R8","R9","R16","R18","R24","R26","R31","R33","R34"];
    const med=["R3","R5","R6","R10","R14","R15","R17","R19","R20","R27","R32","R35"];
    return[r.id,hi.includes(r.id)?3:med.includes(r.id)?2:1];
  }))},
  performance:{name:"Performance-Focused",desc:"Emphasizes measurability, tolerances, quantification",weights:Object.fromEntries(RULES.map(r=>{
    const hi=["R6","R7","R33","R34","R35"];
    const med=["R1","R8","R9","R10","R18","R26","R31","R32"];
    return[r.id,hi.includes(r.id)?3:med.includes(r.id)?2:1];
  }))},
  strict:{name:"Compliance-Strict",desc:"Maximum weight on all automatable rules, warnings ignored",weights:Object.fromEntries(RULES.map(r=>{
    // Rules that are just warnings (always pass with warn:true) get 0
    const warnOnly=["R4","R11","R12","R13","R22","R23","R25","R28","R29","R30","R36","R37","R39","R40","R41","R42"];
    return[r.id,warnOnly.includes(r.id)?0:2];
  }))},
  minimal:{name:"Minimal Check",desc:"Only core rules — shall, vague terms, escape clauses",weights:Object.fromEntries(RULES.map(r=>{
    const on=["R1","R7","R8","R9","R18","R24"];
    return[r.id,on.includes(r.id)?2:0];
  }))}
};

function saveRuleWeights(){localStorage.setItem("reqright_ruleWeights",JSON.stringify(S.ruleWeights));}

// ─── AI REWRITE ──────────────────────────────────────────
function aiRewrite(text,analysis){
  if(!text||!text.trim())return text;
  let t=text.trim();
  const fails=analysis.results.filter(r=>!r.pass);
  const has=id=>fails.find(r=>r.id===id);

  if(has("R2")){
    t=t.replace(/\bshall be processed\b/gi,"shall process");
    t=t.replace(/\bshall be transmitted\b/gi,"shall transmit");
    t=t.replace(/\bshall be stored\b/gi,"shall store");
    t=t.replace(/\bshall be displayed\b/gi,"shall display");
    t=t.replace(/\bshall be logged\b/gi,"shall log");
    t=t.replace(/\bshall be validated\b/gi,"shall validate");
    t=t.replace(/\bshall be encrypted\b/gi,"shall encrypt");
    t=t.replace(/\bshall be computed\b/gi,"shall compute");
    t=t.replace(/\bshall be recorded\b/gi,"shall record");
    t=t.replace(/\bdata shall be encrypted\b/gi,"the Security_Module shall encrypt data");
    t=t.replace(/\bshall be (\w+)ed\b/gi,(m,v)=>"shall "+v);
  }
  if(has("R3")){
    t=t.replace(/^The user shall\b/i,"The system shall");
    t=t.replace(/^Users shall\b/i,"The system shall");
    t=t.replace(/^A user shall\b/i,"The system shall");
    t=t.replace(/^The operator shall\b/i,"The system shall enable the operator to");
  }
  if(has("R5"))t=t.replace(/\b(a|an)\s+(system|module|component|subsystem|interface|unit|device|sensor|controller|processor|server|display|network)\b/gi,(_,a,n)=>"the "+n);
  if(has("R7")){
    const reps={fast:"within [X] seconds",slow:"exceeding [X] seconds",adequate:"meeting [criteria]",reasonable:"within [threshold]",sufficient:"at least [X]","user-friendly":"compliant with [standard]",robust:"with [X]% availability",reliable:"with MTBF ≥ [X] hours",secure:"using [encryption standard]",efficient:"within [X] resource budget",effective:"achieving [X]% [metric]",safe:"meeting [safety standard]",scalable:"supporting [X] to [Y] users",quickly:"within [X] ms",approximately:"[X] ± [Y]",usually:"in ≥ [X]% of scenarios",minimal:"≤ [X]",promptly:"within [X] seconds",timely:"within [X] units"};
    for(const[v,r]of Object.entries(reps))t=t.replace(new RegExp("\\b"+v+"\\b","gi"),r);
  }
  if(has("R8"))t=t.replace(/\b(where possible|as appropriate|if necessary|as required|as needed|if feasible|when practical)\b/gi,"[specify condition]");
  if(has("R9"))t=t.replace(/\b(including but not limited to|etc\.?|and so on|and so forth|among others|and the like)\b/gi,"[list all items]");
  if(has("R10")){
    t=t.replace(/\bshall be able to\b/gi,"shall");
    t=t.replace(/\bshall be capable of\b/gi,"shall");
    t=t.replace(/\bshall have the ability to\b/gi,"shall");
    t=t.replace(/\bshall provide the ability to\b/gi,"shall");
  }
  if(has("R14")&&!/\.\s*$/.test(t))t=t.replace(/\s*$/,".");
  if(has("R16")){
    t=t.replace(/\bshall not exceed\b/gi,"shall be at most");
    t=t.replace(/\bshall not fail\b/gi,"shall maintain operation");
    t=t.replace(/\bshall not allow\b/gi,"shall prevent");
    t=t.replace(/\bshall not consume more than\b/gi,"shall consume at most");
  }
  if(has("R20"))t=t.replace(/\s+(in order to|so that|for the purpose of|so as to)\s+.*/gi,".");
  if(has("R26")){t=t.replace(/\b100\s*%\b/g,"≥ 99.9%");t=t.replace(/\balways\b/gi,"in each operational scenario");t=t.replace(/\bnever\b/gi,"in no defined scenario");}
  if(has("R35")){
    t=t.replace(/\bimmediately\b/gi,"within [X] ms");t=t.replace(/\bpromptly\b/gi,"within [X] seconds");
    t=t.replace(/\breal-time\b/gi,"within [X] ms latency");t=t.replace(/\breal time\b/gi,"within [X] ms latency");
    t=t.replace(/\bsoon\b/gi,"within [X] time units");t=t.replace(/\beventually\b/gi,"within [X] time units");
  }
  if(has("R38")){
    const am={approx:"approximately",max:"maximum",min:"minimum",temp:"temperature",freq:"frequency",config:"configuration",auth:"authentication",admin:"administrator",msg:"message",info:"information",doc:"document",spec:"specification",req:"requirement"};
    for(const[a,f]of Object.entries(am))t=t.replace(new RegExp("\\b"+a+"\\b","gi"),f);
  }
  return t;
}

// ─── DOCUMENT PARSER ──────────────────────────────────────
function parseDoc(text){
  const lines=text.split("\n").map(l=>l.trim()).filter(l=>l);
  const reqs=[];
  for(const line of lines){
    if(!/\bshall\b/i.test(line))continue;
    let cleaned=line.replace(/^(REQ|SYS|SUB|CMP|FR|NFR|PR|IR|SR)?[-_]?\s*\d{1,5}[.:)]\s*/i,"").replace(/^[\u2022\u2023\u25E6\u2043\u2219•\-\*]\s*/,"").trim();
    let type="Functional";
    if(/\b(performance|speed|throughput|latency|capacity|bandwidth)\b/i.test(cleaned))type="Performance";
    else if(/\b(interface|protocol|port|connector|signal)\b/i.test(cleaned))type="Interface";
    else if(/\b(safety|hazard|fault|fail-safe|emergency)\b/i.test(cleaned))type="Safety";
    else if(/\b(security|authentication|encryption|authorization)\b/i.test(cleaned))type="Security";
    else if(/\b(reliability|MTBF|MTTR|failure rate)\b/i.test(cleaned))type="Reliability";
    else if(/\b(environment|temperature|humidity|vibration|shock|EMC)\b/i.test(cleaned))type="Environmental";
    else if(/\b(weight|size|dimension|mass|form factor)\b/i.test(cleaned))type="Physical";
    else if(/\b(comply|regulation|standard|MIL-STD|DO-178|IEC|ISO)\b/i.test(cleaned))type="Regulatory";
    let level="System Requirement";
    if(/\b(stakeholder|user need|operational need|mission)\b/i.test(cleaned))level="Stakeholder Need";
    else if(/\b(subsystem|sub-system|LRU|assembly)\b/i.test(cleaned))level="Subsystem Requirement";
    else if(/\b(component|part|element|CSCI|HWCI)\b/i.test(cleaned))level="Component Requirement";
    reqs.push({text:cleaned,type,level});
  }
  return reqs;
}

// ─── ReqIF EXPORT ─────────────────────────────────────────
function escXml(s){return(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function genReqIF(reqs,proj){
  const now=new Date().toISOString();
  const objs=reqs.map(r=>`    <SPEC-OBJECT IDENTIFIER="obj-${r.id}" LAST-CHANGE="${now}"><VALUES>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.id)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-id</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.text)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-text</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.type)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-type</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.level)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-level</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.priority)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-pri</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.status)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-stat</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.verification)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-veri</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${escXml(r.rationale)}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-rat</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
      <ATTRIBUTE-VALUE-STRING THE-VALUE="${analyze(r.text).score}"><DEFINITION><ATTRIBUTE-DEFINITION-STRING-REF>a-qual</ATTRIBUTE-DEFINITION-STRING-REF></DEFINITION></ATTRIBUTE-VALUE-STRING>
    </VALUES></SPEC-OBJECT>`).join("\n");
  const attrs=["id","text","type","level","pri","stat","veri","rat","qual"].map(a=>
    `          <ATTRIBUTE-DEFINITION-STRING IDENTIFIER="a-${a}" LAST-CHANGE="${now}"><TYPE><DATATYPE-DEFINITION-STRING-REF>dt-s</DATATYPE-DEFINITION-STRING-REF></TYPE></ATTRIBUTE-DEFINITION-STRING>`).join("\n");
  const hier=reqs.map(r=>`      <SPEC-HIERARCHY IDENTIFIER="h-${r.id}"><OBJECT><SPEC-OBJECT-REF>obj-${r.id}</SPEC-OBJECT-REF></OBJECT></SPEC-HIERARCHY>`).join("\n");
  return`<?xml version="1.0" encoding="UTF-8"?>
<REQ-IF xmlns="http://www.omg.org/spec/ReqIF/20110401/reqif.xsd">
  <THE-HEADER><REQ-IF-HEADER IDENTIFIER="hdr"><COMMENT>ReqRight Export</COMMENT><CREATION-TIME>${now}</CREATION-TIME><TITLE>${escXml(proj)}</TITLE></REQ-IF-HEADER></THE-HEADER>
  <CORE-CONTENT><REQ-IF-CONTENT>
    <DATATYPES><DATATYPE-DEFINITION-STRING IDENTIFIER="dt-s" MAX-LENGTH="4096" LAST-CHANGE="${now}"/></DATATYPES>
    <SPEC-TYPES><SPEC-OBJECT-TYPE IDENTIFIER="sot" LAST-CHANGE="${now}"><SPEC-ATTRIBUTES>
${attrs}
        </SPEC-ATTRIBUTES></SPEC-OBJECT-TYPE></SPEC-TYPES>
    <SPEC-OBJECTS>
${objs}
    </SPEC-OBJECTS>
    <SPECIFICATIONS><SPECIFICATION IDENTIFIER="spec-1" LAST-CHANGE="${now}"><CHILDREN>
${hier}
    </CHILDREN></SPECIFICATION></SPECIFICATIONS>
  </REQ-IF-CONTENT></CORE-CONTENT>
</REQ-IF>`;
}

// ─── HELPERS ──────────────────────────────────────────────
let _id=0;
function gid(p="REQ"){_id++;return p+"-"+String(_id).padStart(4,"0");}
function mkReq(o={}){return{id:gid(),text:"",type:"Functional",level:"System Requirement",priority:"Medium",verification:"Test",rationale:"",parent:"",status:"Draft",source:"",risk:"Medium",comments:[],history:[],created:new Date().toISOString(),modified:new Date().toISOString(),...o};}
let _riskId=0;
function gridRisk(){
  // Gap-filling: find first available RSK-NNNN
  const usedNums=S.risks.map(r=>parseInt(r.id.replace(/\D/g,""))||0);
  let n=1;
  while(usedNums.includes(n))n++;
  return"RSK-"+String(n).padStart(4,"0");
}
function mkRisk(o={}){return{id:gridRisk(),title:"",description:"",category:"Technical",likelihood:3,impact:3,status:"Open",mitigations:[],owner:"",dueDate:"",notes:"",created:new Date().toISOString(),modified:new Date().toISOString(),...o};}
function riskScore(l,i){return l*i;}
function riskLevel(score){if(score>=15)return{level:"Critical",color:"var(--danger)"};if(score>=10)return{level:"High",color:"var(--orange)"};if(score>=5)return{level:"Medium",color:"var(--warn)"};return{level:"Low",color:"var(--success)"};}

// Stakeholder ID generator (gap-filling)
function gStkId(){
  const usedNums=(S.stakeholders||[]).map(s=>parseInt(s.id.replace(/\D/g,""))||0);
  let n=1;while(usedNums.includes(n))n++;
  return"STH-"+String(n).padStart(4,"0");
}
function mkStk(o={}){return{id:gStkId(),name:"",role:"End User",organization:"",influence:"Medium",category:"Internal",concerns:"",expectations:"",linkedNeeds:[],contactInfo:"",notes:"",created:new Date().toISOString(),modified:new Date().toISOString(),...o};}

// Interface ID generator (gap-filling)
function gIfcId(){
  const usedNums=(S.interfaces||[]).map(i=>parseInt(i.id.replace(/\D/g,""))||0);
  let n=1;while(usedNums.includes(n))n++;
  return"IFC-"+String(n).padStart(4,"0");
}
function mkIfc(o={}){return{id:gIfcId(),name:"",type:"Data",source:"",destination:"",direction:"Unidirectional →",protocol:"",dataItems:"",dataRate:"",physicalChar:"",status:"Draft",linkedReqs:[],notes:"",created:new Date().toISOString(),modified:new Date().toISOString(),...o};}

// Use Case ID generator (gap-filling)
function gUcId(){
  const usedNums=(S.useCases||[]).map(u=>parseInt(u.id.replace(/\D/g,""))||0);
  let n=1;while(usedNums.includes(n))n++;
  return"UC-"+String(n).padStart(4,"0");
}
function mkUc(o={}){return{id:gUcId(),title:"",type:"Operational",priority:"Medium",status:"Draft",actor:"",trigger:"",preconditions:"",mainFlow:"",alternativeFlows:"",postconditions:"",derivedReqs:[],linkedStakeholders:[],notes:"",created:new Date().toISOString(),modified:new Date().toISOString(),...o};}
function dl(content,type,fn){const b=new Blob([content],{type});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=fn;a.click();URL.revokeObjectURL(u);}

// ─── THEME TOGGLE ────────────────────────────────────────
function getTheme(){
  const saved=localStorage.getItem("reqright_theme")||localStorage.getItem("incose_theme");
  if(saved)return saved;
  // Check system preference
  if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches)return "light";
  return "dark";
}
function setTheme(theme){
  localStorage.setItem("reqright_theme",theme);
  if(theme==="light"){
    document.documentElement.classList.add("light");
  }else{
    document.documentElement.classList.remove("light");
  }
}
function toggleTheme(){
  const current=document.documentElement.classList.contains("light")?"light":"dark";
  const newTheme=current==="light"?"dark":"light";
  setTheme(newTheme);
  render();
}
// Apply saved theme on load
// Migrate old localStorage keys
if(!localStorage.getItem("reqright_autosave")&&localStorage.getItem("incose_workbench_autosave")){
  localStorage.setItem("reqright_autosave",localStorage.getItem("incose_workbench_autosave"));
  localStorage.removeItem("incose_workbench_autosave");
}
if(!localStorage.getItem("reqright_theme")&&localStorage.getItem("incose_theme")){
  localStorage.setItem("reqright_theme",localStorage.getItem("incose_theme"));
  localStorage.removeItem("incose_theme");
}
setTheme(getTheme());

// ─── STATE ────────────────────────────────────────────────
const S={
  view:"welcome",reqs:[],selId:null,glossary:[{term:"SOI",def:"System of Interest"},{term:"ICD",def:"Interface Control Document"},{term:"V&V",def:"Verification and Validation"},{term:"ConOps",def:"Concept of Operations"}],
  decisions:[],selDecId:null,
  risks:[],selRiskId:null,
  stakeholders:[],selStkId:null,
  interfaces:[],selIfcId:null,
  useCases:[],selUcId:null,
  project:"New Systems Engineering Project",filterType:"All",filterLevel:"All",search:"",authorSearch:"",authorFilterType:"All",authorFilterLevel:"All",authorFilterStatus:"All",riskSearch:"",riskFilterCat:"All",riskFilterStat:"All",decSearch:"",decFilterCat:"All",decFilterStat:"All",stkSearch:"",stkFilterRole:"All",stkFilterInfluence:"All",ifcSearch:"",ifcFilterType:"All",ifcFilterStatus:"All",ucSearch:"",ucFilterType:"All",ucFilterStat:"All",traceTab:"hierarchy",glossSearch:"",sort:"id",
  showImport:false,importText:"",showExport:false,showBulkAI:false,showSearch:false,globalSearchQ:"",showReportCfg:false,
  rptSections:{execSummary:true,qualityStats:true,requirements:true,stakeholders:true,useCases:true,interfaces:true,risks:true,decisions:true,traceability:true,hierarchy:true,vv:false,glossary:true},
  rptLayout:"A",
  showTemplates:false,
  xlsxPreview:null,
  reviewer:localStorage.getItem("reqright_reviewer")||"Reviewer",
  showComments:true,
  showHistory:false,
  commentText:"",
  ruleWeights:JSON.parse(localStorage.getItem("reqright_ruleWeights")||"null")||Object.fromEntries(RULES.map(r=>[r.id,1])),
  aiLoading:null,toast:null,
  autoSaveKey:"reqright_autosave",
  // LLM settings
  showLLMSettings:false,
  llm:JSON.parse(localStorage.getItem("reqright_llm")||"null")||{provider:"anthropic",model:"claude-sonnet-4-5-20250929",apiKey:"",testStatus:null,testMsg:""},
  llmReview:null, // {reqId, original, suggested, changes, confidence, loading, error}
  llmBatch:null, // {total, done, improved, failed, running, results, currentId}
};

function setState(updates){Object.assign(S,updates);render();}
function saveLLM(){localStorage.setItem("reqright_llm",JSON.stringify({provider:S.llm.provider,model:S.llm.model,apiKey:S.llm.apiKey}));}
async function testLLMConnection(){
  S.llm.testStatus="testing";S.llm.testMsg="";render();
  try{
    if(S.llm.provider==="anthropic"){
      const resp=await fetch("https://api.anthropic.com/v1/messages",{
        method:"POST",
        headers:{"Content-Type":"application/json","x-api-key":S.llm.apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
        body:JSON.stringify({model:S.llm.model,max_tokens:20,messages:[{role:"user",content:"Reply with only: OK"}]})
      });
      if(resp.ok){
        const data=await resp.json();
        const txt=(data.content&&data.content[0]&&data.content[0].text)||"";
        S.llm.testStatus="ok";S.llm.testMsg="Model: "+S.llm.model+" — "+txt.trim();
      } else {
        const err=await resp.json().catch(()=>({error:{message:resp.statusText}}));
        S.llm.testStatus="error";S.llm.testMsg=(err.error&&err.error.message)||"HTTP "+resp.status;
      }
    } else if(S.llm.provider==="openai"){
      const resp=await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":"Bearer "+S.llm.apiKey},
        body:JSON.stringify({model:S.llm.model,max_tokens:20,messages:[{role:"user",content:"Reply with only: OK"}]})
      });
      if(resp.ok){
        const data=await resp.json();
        const txt=(data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)||"";
        S.llm.testStatus="ok";S.llm.testMsg="Model: "+S.llm.model+" — "+txt.trim();
      } else {
        const err=await resp.json().catch(()=>({error:{message:resp.statusText}}));
        S.llm.testStatus="error";S.llm.testMsg=(err.error&&err.error.message)||"HTTP "+resp.status;
      }
    }
  } catch(e){
    S.llm.testStatus="error";S.llm.testMsg=e.message||"Network error — check your connection";
  }
  saveLLM();render();
}

// ─── UNDO/REDO SYSTEM ──────────────────────────────────────
const History={
  undoStack:[],
  redoStack:[],
  maxSize:50,
  
  // Save current state to undo stack
  save(){
    const snapshot={
      reqs:JSON.parse(JSON.stringify(S.reqs)),
      glossary:JSON.parse(JSON.stringify(S.glossary)),
      decisions:JSON.parse(JSON.stringify(S.decisions)),
      risks:JSON.parse(JSON.stringify(S.risks)),
      stakeholders:JSON.parse(JSON.stringify(S.stakeholders||[])),
      interfaces:JSON.parse(JSON.stringify(S.interfaces||[])),
      useCases:JSON.parse(JSON.stringify(S.useCases||[])),
      project:S.project,
      selId:S.selId,
      selDecId:S.selDecId,
      selRiskId:S.selRiskId,
      selStkId:S.selStkId,
      selIfcId:S.selIfcId,
      selUcId:S.selUcId
    };
    this.undoStack.push(snapshot);
    if(this.undoStack.length>this.maxSize)this.undoStack.shift();
    this.redoStack=[];// Clear redo when new action is taken
  },
  
  // Undo last action
  undo(){
    if(this.undoStack.length===0)return false;
    // Save current state to redo stack
    const current={
      reqs:JSON.parse(JSON.stringify(S.reqs)),
      glossary:JSON.parse(JSON.stringify(S.glossary)),
      decisions:JSON.parse(JSON.stringify(S.decisions)),
      risks:JSON.parse(JSON.stringify(S.risks)),
      stakeholders:JSON.parse(JSON.stringify(S.stakeholders||[])),
      interfaces:JSON.parse(JSON.stringify(S.interfaces||[])),
      useCases:JSON.parse(JSON.stringify(S.useCases||[])),
      project:S.project,
      selId:S.selId,
      selDecId:S.selDecId,
      selRiskId:S.selRiskId,
      selStkId:S.selStkId,
      selIfcId:S.selIfcId,
      selUcId:S.selUcId
    };
    this.redoStack.push(current);
    
    // Restore previous state
    const prev=this.undoStack.pop();
    S.reqs=prev.reqs;
    S.glossary=prev.glossary;
    S.decisions=prev.decisions||[];
    S.risks=prev.risks||[];
    S.stakeholders=prev.stakeholders||[];
    S.interfaces=prev.interfaces||[];
    S.useCases=prev.useCases||[];
    S.project=prev.project;
    S.selId=prev.selId;
    S.selDecId=prev.selDecId||null;
    S.selRiskId=prev.selRiskId||null;
    S.selStkId=prev.selStkId||null;
    S.selIfcId=prev.selIfcId||null;
    S.selUcId=prev.selUcId||null;
    
    // Update _id counter
    if(S.reqs.length>0){
      _id=Math.max(0,...S.reqs.map(r=>parseInt(r.id.replace(/\D/g,""))||0));
    }
    
    autoSave();
    return true;
  },
  
  // Redo previously undone action
  redo(){
    if(this.redoStack.length===0)return false;
    // Save current state to undo stack
    const current={
      reqs:JSON.parse(JSON.stringify(S.reqs)),
      glossary:JSON.parse(JSON.stringify(S.glossary)),
      decisions:JSON.parse(JSON.stringify(S.decisions)),
      risks:JSON.parse(JSON.stringify(S.risks)),
      stakeholders:JSON.parse(JSON.stringify(S.stakeholders||[])),
      interfaces:JSON.parse(JSON.stringify(S.interfaces||[])),
      useCases:JSON.parse(JSON.stringify(S.useCases||[])),
      project:S.project,
      selId:S.selId,
      selDecId:S.selDecId,
      selRiskId:S.selRiskId,
      selStkId:S.selStkId,
      selIfcId:S.selIfcId,
      selUcId:S.selUcId
    };
    this.undoStack.push(current);
    
    // Restore redo state
    const next=this.redoStack.pop();
    S.reqs=next.reqs;
    S.glossary=next.glossary;
    S.decisions=next.decisions||[];
    S.risks=next.risks||[];
    S.stakeholders=next.stakeholders||[];
    S.interfaces=next.interfaces||[];
    S.useCases=next.useCases||[];
    S.project=next.project;
    S.selId=next.selId;
    S.selDecId=next.selDecId||null;
    S.selRiskId=next.selRiskId||null;
    S.selStkId=next.selStkId||null;
    S.selIfcId=next.selIfcId||null;
    S.selUcId=next.selUcId||null;
    
    // Update _id counter
    if(S.reqs.length>0){
      _id=Math.max(0,...S.reqs.map(r=>parseInt(r.id.replace(/\D/g,""))||0));
    }
    
    autoSave();
    return true;
  },
  
  canUndo(){return this.undoStack.length>0;},
  canRedo(){return this.redoStack.length>0;}
};

// ─── KEYBOARD SHORTCUTS ────────────────────────────────────
document.addEventListener("keydown",e=>{
  // Don't trigger shortcuts when typing in inputs (except for Alt shortcuts)
  const tag=document.activeElement?.tagName?.toLowerCase();
  const isTyping=tag==="input"||tag==="textarea"||tag==="select";
  
  // Alt + key shortcuts (work even when typing, to avoid browser conflicts)
  if(e.altKey&&!e.ctrlKey&&!e.metaKey){
    if(e.key==="n"||e.key==="N"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){addReq();}
      return false;
    }else if(e.key==="s"||e.key==="S"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){exportJSON();}
      return false;
    }else if(e.key==="f"||e.key==="F"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){
        S.view="requirements";
        render();
        setTimeout(()=>document.getElementById("search-input")?.focus(),100);
      }
      return false;
    }else if(e.key==="g"||e.key==="G"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="glossary";render();}
      return false;
    }else if(e.key==="d"||e.key==="D"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="dashboard";render();}
      return false;
    }else if(e.key==="a"||e.key==="A"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="editor";render();}
      return false;
    }else if(e.key==="t"||e.key==="T"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="traceability";render();}
      return false;
    }else if(e.key==="c"||e.key==="C"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="decisions";render();}
      return false;
    }else if(e.key==="r"||e.key==="R"){
      e.preventDefault();
      e.stopPropagation();
      if(S.view!=="welcome"){S.view="risks";render();}
      return false;
    }
  }
  
  // Ctrl+Z for Undo, Ctrl+Y or Ctrl+Shift+Z for Redo (only when not typing)
  if((e.ctrlKey||e.metaKey)&&!e.altKey){
    if(e.key==="k"||e.key==="K"){
      e.preventDefault();
      if(S.view!=="welcome"){S.showSearch=!S.showSearch;S.globalSearchQ="";render();setTimeout(()=>document.getElementById("global-search-input")?.focus(),50);}
      return false;
    }
    if(!isTyping){
    if(e.key==="z"||e.key==="Z"){
      if(e.shiftKey){
        // Ctrl+Shift+Z = Redo
        e.preventDefault();
        if(S.view!=="welcome"&&History.redo()){
          toast("Redo","info");
          render();
        }
      }else{
        // Ctrl+Z = Undo
        e.preventDefault();
        if(S.view!=="welcome"&&History.undo()){
          toast("Undo","info");
          render();
        }
      }
      return false;
    }else if(e.key==="y"||e.key==="Y"){
      // Ctrl+Y = Redo
      e.preventDefault();
      if(S.view!=="welcome"&&History.redo()){
        toast("Redo","info");
        render();
      }
      return false;
    }
    }// end isTyping check
  }
  
  // Arrow keys for requirement navigation (only when not typing)
  if(!isTyping&&S.view==="editor"&&S.reqs.length>0){
    const idx=S.reqs.findIndex(r=>r.id===S.selId);
    if(e.key==="ArrowUp"&&idx>0){
      e.preventDefault();
      S.selId=S.reqs[idx-1].id;render();
    }else if(e.key==="ArrowDown"&&idx<S.reqs.length-1){
      e.preventDefault();
      S.selId=S.reqs[idx+1].id;render();
    }
  }
  
  // Escape to close modals
  if(e.key==="Escape"){
    if(S.showSearch){S.showSearch=false;S.globalSearchQ="";render();}
    if(S.showReportCfg){S.showReportCfg=false;render();}
    if(S.showTemplates){S.showTemplates=false;render();}
    if(S.xlsxPreview){S.xlsxPreview=null;render();}
    if(S.showExport){S.showExport=false;render();}
    if(S.showBulkAI){S.showBulkAI=false;render();}
    if(S.showLLMSettings){S.showLLMSettings=false;render();}
    if(S.showImport){S.showImport=false;render();}
  }
});

// ─── COPY TO CLIPBOARD ─────────────────────────────────────
function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    toast("Copied to clipboard","success");
  }).catch(()=>{
    // Fallback for older browsers
    const ta=document.createElement("textarea");
    ta.value=text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast("Copied to clipboard","success");
  });
}

// ─── AUTO-SAVE TO LOCALSTORAGE ────────────────────────────
function autoSave(){
  try{
    const data={project:S.project,reqs:S.reqs,glossary:S.glossary,decisions:S.decisions,risks:S.risks,stakeholders:S.stakeholders||[],interfaces:S.interfaces||[],useCases:S.useCases||[],savedAt:new Date().toISOString()};
    localStorage.setItem(S.autoSaveKey,JSON.stringify(data));
  }catch(e){}
}
function autoLoad(){
  try{
    const raw=localStorage.getItem(S.autoSaveKey);
    if(!raw)return false;
    const data=JSON.parse(raw);
    if((data.reqs&&data.reqs.length>0)||(data.risks&&data.risks.length>0)||(data.decisions&&data.decisions.length>0)||(data.stakeholders&&data.stakeholders.length>0)||(data.interfaces&&data.interfaces.length>0)||(data.useCases&&data.useCases.length>0)){
      S.reqs=data.reqs||[];S.project=data.project||S.project;S.glossary=data.glossary||S.glossary;S.decisions=data.decisions||[];S.risks=data.risks||[];S.stakeholders=data.stakeholders||[];S.interfaces=data.interfaces||[];S.useCases=data.useCases||[];
      _id=Math.max(0,...(data.reqs||[]).map(r=>parseInt(r.id.replace(/\D/g,""))||0));
      _riskId=Math.max(0,...(data.risks||[]).map(r=>parseInt(r.id.replace(/\D/g,""))||0));
      return true;
    }
  }catch(e){}
  return false;
}

function toast(msg,type="info"){S.toast={msg,type};render();setTimeout(()=>{S.toast=null;render();},3000);}

// ─── DEBOUNCE HELPER ──────────────────────────────────────
let _debounceTimer=null;
function debounce(fn,ms){clearTimeout(_debounceTimer);_debounceTimer=setTimeout(fn,ms);}

// ─── ACTIONS ──────────────────────────────────────────────
function addReq(){History.save();const r=mkReq();S.reqs.push(r);S.selId=r.id;S.view="editor";autoSave();toast("Created "+r.id,"success");render();}

// Silent update - updates data and quality panel without full re-render (fixes input focus loss)
// Note: We use debounced history save for silent updates to avoid saving on every keystroke
let _historyTimer=null;
// ─── VERSION HISTORY TRACKING ─────────────────────────────
const TRACKED_FIELDS={text:"Statement",type:"Type",level:"Level",priority:"Priority",status:"Status",verification:"Verification",rationale:"Rationale",source:"Source",parent:"Parent",risk:"Risk"};
let _pendingTextHistory=null;

function trackChanges(r,u){
  if(!r.history)r.history=[];
  for(const[k,v]of Object.entries(u)){
    if(k in TRACKED_FIELDS&&r[k]!==v&&v!==undefined){
      if(k==="text"){
        // Debounce text changes — only record when user pauses
        if(!_pendingTextHistory||_pendingTextHistory.id!==r.id){
          _pendingTextHistory={id:r.id,oldValue:r[k],timestamp:new Date().toISOString()};
        }
      }else{
        r.history.push({timestamp:new Date().toISOString(),field:TRACKED_FIELDS[k],oldValue:String(r[k]||""),newValue:String(v||""),author:S.reviewer});
      }
    }
  }
}

function flushTextHistory(r){
  if(_pendingTextHistory&&_pendingTextHistory.id===r.id&&r.text!==_pendingTextHistory.oldValue){
    if(!r.history)r.history=[];
    const oldSnip=(_pendingTextHistory.oldValue||"").substring(0,60);
    const newSnip=(r.text||"").substring(0,60);
    r.history.push({timestamp:_pendingTextHistory.timestamp,field:"Statement",oldValue:oldSnip+((_pendingTextHistory.oldValue||"").length>60?"…":""),newValue:newSnip+((r.text||"").length>60?"…":""),author:S.reviewer});
  }
  _pendingTextHistory=null;
}

function updateReqSilent(id,u){
  const r=S.reqs.find(x=>x.id===id);
  if(r){
    clearTimeout(_historyTimer);
    _historyTimer=setTimeout(()=>{History.save();flushTextHistory(r);},1000);
    trackChanges(r,u);
    Object.assign(r,u,{modified:new Date().toISOString()});
    autoSave();
    debounce(()=>updateQualityPanel(id),150);
  }
}

// Full update with re-render (for dropdowns, structural changes)
function updateReq(id,u){History.save();const r=S.reqs.find(x=>x.id===id);if(r){if(_pendingTextHistory&&_pendingTextHistory.id===id)flushTextHistory(r);trackChanges(r,u);Object.assign(r,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteReq(id){History.save();S.reqs=S.reqs.filter(r=>r.id!==id);if(S.selId===id)S.selId=null;autoSave();toast("Deleted","info");render();}
function dupReq(id){History.save();const o=S.reqs.find(r=>r.id===id);if(!o)return;const n={...o,id:gid(),status:"Draft",comments:[],history:[],created:new Date().toISOString(),modified:new Date().toISOString()};S.reqs.push(n);autoSave();toast("Duplicated → "+n.id,"success");render();}
function doAI(id){
  History.save();
  const r=S.reqs.find(x=>x.id===id);if(!r||!r.text.trim())return;
  S.aiLoading=id;render();
  setTimeout(()=>{
    const a=analyze(r.text);const oldText=r.text;const improved=aiRewrite(r.text,a);
    if(!r.history)r.history=[];
    r.history.push({timestamp:new Date().toISOString(),field:"Statement (AI Improve)",oldValue:oldText.substring(0,60)+(oldText.length>60?"…":""),newValue:improved.substring(0,60)+(improved.length>60?"…":""),author:"AI Engine"});
    r.text=improved;r.modified=new Date().toISOString();
    S.aiLoading=null;autoSave();
    const ns=analyze(improved).score;toast(`AI: ${a.score}% → ${ns}%`,"success");render();
  },400);
}
function bulkAI(){
  History.save();
  let c=0;S.reqs.forEach(r=>{if(!r.text.trim())return;const a=analyze(r.text);if(a.score<80){r.text=aiRewrite(r.text,a);r.modified=new Date().toISOString();c++;}});
  autoSave();toast(`Improved ${c} requirements`,"success");render();
}

// ─── LLM-POWERED SMART REWRITE ──────────────────────────────
async function llmRewrite(req){
  const a=analyze(req.text);
  const failedRules=a.results.filter(r=>!r.pass&&r.weight>0);
  const glossaryTerms=S.glossary.map(g=>g.term+": "+g.def).join("\n");
  const weightProfile=Object.entries(S.ruleWeights).filter(([k,v])=>v>=2).map(([k,v])=>k+" ("+v+"×)").join(", ");

  const systemPrompt=`You are an expert systems engineer specialising in INCOSE Guide to Writing Requirements (GtWR) v4. Your task is to rewrite a requirement to fix specific rule violations while preserving the original intent.

RULES TO FIX:
${failedRules.map(r=>"- "+r.id+": "+r.nm+" — "+r.msg).join("\n")}

INCOSE BEST PRACTICES:
- Use "shall" as the obligation keyword (not "should", "will", "must")
- Use active voice with a named subject: "The [System_Name] shall..."
- One requirement per sentence (no combinators like "and/or" joining separate actions)
- Include measurable values with ± tolerances where applicable
- Avoid vague terms: adequate, appropriate, fast, efficient, reliable, etc.
- Avoid escape clauses: as applicable, where possible, as needed, etc.
- Avoid absolutes: always, never, 100%, all, none
- Use "each" instead of "all/any/every"
- No pronouns — use the actual entity name
- No parenthetical content or subordinate clauses that add separate requirements
${glossaryTerms?"\nPROJECT GLOSSARY:\n"+glossaryTerms:""}
${weightProfile?"\nHIGH-PRIORITY RULES (weighted 2×+): "+weightProfile:""}
REQUIREMENT CONTEXT:
- Type: ${req.type||"Not set"}
- Level: ${req.level||"Not set"}
- Parent: ${req.parent||"None"}

RESPOND WITH ONLY A JSON OBJECT — no markdown, no backticks, no explanation:
{"text":"the rewritten requirement","changes":"brief summary of what was changed and why","confidence":0.0 to 1.0}`;

  const userPrompt=`Rewrite this requirement to fix the ${failedRules.length} violation${failedRules.length!==1?"s":""} listed above:\n\n"${req.text}"`;

  if(S.llm.provider==="anthropic"){
    const resp=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":S.llm.apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({model:S.llm.model,max_tokens:1024,system:systemPrompt,messages:[{role:"user",content:userPrompt}]})
    });
    if(!resp.ok){const err=await resp.json().catch(()=>({}));throw new Error((err.error&&err.error.message)||"HTTP "+resp.status);}
    const data=await resp.json();
    const raw=(data.content&&data.content[0]&&data.content[0].text)||"";
    return JSON.parse(raw.replace(/```json|```/g,"").trim());
  } else {
    const resp=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+S.llm.apiKey},
      body:JSON.stringify({model:S.llm.model,max_tokens:1024,messages:[{role:"system",content:systemPrompt},{role:"user",content:userPrompt}]})
    });
    if(!resp.ok){const err=await resp.json().catch(()=>({}));throw new Error((err.error&&err.error.message)||"HTTP "+resp.status);}
    const data=await resp.json();
    const raw=(data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content)||"";
    return JSON.parse(raw.replace(/```json|```/g,"").trim());
  }
}

async function doLLMAI(id){
  const r=S.reqs.find(x=>x.id===id);if(!r||!r.text.trim())return;
  S.llmReview={reqId:id,original:r.text,suggested:null,changes:null,confidence:null,loading:true,error:null};
  render();
  try{
    const result=await llmRewrite(r);
    S.llmReview.suggested=result.text;
    S.llmReview.changes=result.changes;
    S.llmReview.confidence=result.confidence;
    S.llmReview.loading=false;
  }catch(e){
    S.llmReview.loading=false;
    S.llmReview.error=e.message||"LLM request failed";
  }
  render();
}

function acceptLLM(){
  if(!S.llmReview||!S.llmReview.suggested)return;
  History.save();
  const r=S.reqs.find(x=>x.id===S.llmReview.reqId);if(!r)return;
  const oldText=r.text;const oldScore=analyze(oldText).score;
  r.text=S.llmReview.suggested;
  r.modified=new Date().toISOString();
  if(!r.history)r.history=[];
  r.history.push({timestamp:new Date().toISOString(),field:"Statement (LLM Rewrite)",oldValue:oldText.substring(0,60)+(oldText.length>60?"…":""),newValue:r.text.substring(0,60)+(r.text.length>60?"…":""),author:"LLM ("+S.llm.model+")"});
  const newScore=analyze(r.text).score;
  S.llmReview=null;autoSave();
  toast(`LLM: ${oldScore}% → ${newScore}%`,"success");render();
}

function rejectLLM(){S.llmReview=null;render();}

async function bulkLLMAI(threshold=80){
  const targets=S.reqs.filter(r=>r.text.trim()&&analyze(r.text).score<threshold);
  if(!targets.length){toast("No requirements below "+threshold+"%","success");return;}
  S.llmBatch={total:targets.length,done:0,improved:0,failed:0,running:true,results:[]};
  render();
  for(const r of targets){
    S.llmBatch.currentId=r.id;render();
    try{
      const result=await llmRewrite(r);
      if(result&&result.text){
        History.save();
        const oldText=r.text;const oldScore=analyze(oldText).score;
        r.text=result.text;r.modified=new Date().toISOString();
        if(!r.history)r.history=[];
        r.history.push({timestamp:new Date().toISOString(),field:"Statement (LLM Batch)",oldValue:oldText.substring(0,60)+(oldText.length>60?"…":""),newValue:r.text.substring(0,60)+(r.text.length>60?"…":""),author:"LLM ("+S.llm.model+")"});
        const newScore=analyze(r.text).score;
        S.llmBatch.improved++;
        S.llmBatch.results.push({id:r.id,oldScore,newScore,status:"ok"});
      }
    }catch(e){
      S.llmBatch.failed++;
      S.llmBatch.results.push({id:r.id,oldScore:analyze(r.text).score,newScore:null,status:"error",msg:e.message});
    }
    S.llmBatch.done++;render();
  }
  S.llmBatch.running=false;S.llmBatch.currentId=null;
  autoSave();render();
  toast(`LLM batch: ${S.llmBatch.improved} improved, ${S.llmBatch.failed} failed of ${S.llmBatch.total}`,"success");
}
function doImport(){
  History.save();
  const parsed=parseDoc(S.importText);
  if(!parsed.length){toast("No 'shall' statements found","danger");return;}
  parsed.forEach(p=>S.reqs.push(mkReq(p)));
  S.showImport=false;S.importText="";autoSave();toast(`Imported ${parsed.length} requirements`,"success");render();
}

// ─── DECISION LOG FUNCTIONS ──────────────────────────────
let _decId=0;
function gDecId(){
  // Gap-filling: find first available DEC-NNNN
  const usedNums=S.decisions.map(d=>parseInt(d.id.replace(/\D/g,""))||0);
  let n=1;
  while(usedNums.includes(n))n++;
  return"DEC-"+String(n).padStart(4,"0");
}
function mkDec(o={}){return{id:gDecId(),title:"",decision:"",rationale:"",alternatives:"",category:"Design",status:"Proposed",decisionMaker:"",date:new Date().toISOString().split("T")[0],affectedReqs:[],created:new Date().toISOString(),modified:new Date().toISOString(),...o};}
function addDec(){History.save();const d=mkDec();S.decisions.push(d);S.selDecId=d.id;S.view="decisions";autoSave();toast("Created "+d.id,"success");render();}

// Silent update for decisions (prevents input focus loss)
let _decHistoryTimer=null;
function updateDecSilent(id,u){
  const d=S.decisions.find(x=>x.id===id);
  if(d){
    clearTimeout(_decHistoryTimer);
    _decHistoryTimer=setTimeout(()=>History.save(),1000);
    Object.assign(d,u,{modified:new Date().toISOString()});
    autoSave();
  }
}
// Full update with re-render (for dropdowns, structural changes)
function updateDec(id,u){History.save();const d=S.decisions.find(x=>x.id===id);if(d){Object.assign(d,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteDec(id){History.save();S.decisions=S.decisions.filter(d=>d.id!==id);if(S.selDecId===id)S.selDecId=null;autoSave();toast("Decision deleted","info");render();}

// ─── RISK ACTIONS ────────────────────────────────────────
function addRisk(){History.save();const r=mkRisk();S.risks.push(r);S.selRiskId=r.id;S.view="risks";autoSave();toast("Created "+r.id,"success");render();}

// Silent update for risks - doesn't re-render (for text inputs)
let _riskHistoryTimer=null;
function updateRiskSilent(id,u){
  const r=S.risks.find(x=>x.id===id);
  if(r){
    clearTimeout(_riskHistoryTimer);
    _riskHistoryTimer=setTimeout(()=>History.save(),1000);
    Object.assign(r,u,{modified:new Date().toISOString()});
    autoSave();
  }
}
// Full update with re-render (for dropdowns)
function updateRisk(id,u){History.save();const r=S.risks.find(x=>x.id===id);if(r){Object.assign(r,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteRisk(id){
  History.save();
  S.risks=S.risks.filter(r=>r.id!==id);
  if(S.selRiskId===id)S.selRiskId=null;
  autoSave();
  toast("Risk deleted","info");
  render();
}

// ─── STAKEHOLDER ACTIONS ────────────────────────────────
function addStk(){History.save();const s=mkStk();S.stakeholders.push(s);S.selStkId=s.id;S.view="stakeholders";autoSave();toast("Created "+s.id,"success");render();}
let _stkHistoryTimer=null;
function updateStkSilent(id,u){
  const s=S.stakeholders.find(x=>x.id===id);
  if(s){clearTimeout(_stkHistoryTimer);_stkHistoryTimer=setTimeout(()=>History.save(),1000);Object.assign(s,u,{modified:new Date().toISOString()});autoSave();}
}
function updateStk(id,u){History.save();const s=S.stakeholders.find(x=>x.id===id);if(s){Object.assign(s,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteStk(id){History.save();S.stakeholders=S.stakeholders.filter(s=>s.id!==id);if(S.selStkId===id)S.selStkId=null;autoSave();toast("Stakeholder deleted","info");render();}

// ─── INTERFACE ACTIONS ──────────────────────────────────
function addIfc(){History.save();const i=mkIfc();S.interfaces.push(i);S.selIfcId=i.id;S.view="interfaces";autoSave();toast("Created "+i.id,"success");render();}
let _ifcHistoryTimer=null;
function updateIfcSilent(id,u){
  const i=S.interfaces.find(x=>x.id===id);
  if(i){clearTimeout(_ifcHistoryTimer);_ifcHistoryTimer=setTimeout(()=>History.save(),1000);Object.assign(i,u,{modified:new Date().toISOString()});autoSave();}
}
function updateIfc(id,u){History.save();const i=S.interfaces.find(x=>x.id===id);if(i){Object.assign(i,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteIfc(id){History.save();S.interfaces=S.interfaces.filter(i=>i.id!==id);if(S.selIfcId===id)S.selIfcId=null;autoSave();toast("Interface deleted","info");render();}

// ─── USE CASE ACTIONS ───────────────────────────────────
function addUc(){History.save();const u=mkUc();S.useCases.push(u);S.selUcId=u.id;S.view="usecases";autoSave();toast("Created "+u.id,"success");render();}
let _ucHistoryTimer=null;
function updateUcSilent(id,u){
  const uc=S.useCases.find(x=>x.id===id);
  if(uc){clearTimeout(_ucHistoryTimer);_ucHistoryTimer=setTimeout(()=>History.save(),1000);Object.assign(uc,u,{modified:new Date().toISOString()});autoSave();}
}
function updateUc(id,u){History.save();const uc=S.useCases.find(x=>x.id===id);if(uc){Object.assign(uc,u,{modified:new Date().toISOString()});autoSave();render();}}
function deleteUc(id){History.save();S.useCases=S.useCases.filter(u=>u.id!==id);if(S.selUcId===id)S.selUcId=null;autoSave();toast("Use case deleted","info");render();}

// ─── EXPORTS ──────────────────────────────────────────────
function exportJSON(){
  const data={project:S.project,version:"2.2",standard:"INCOSE GtWR v4",exportDate:new Date().toISOString(),
    requirements:S.reqs.map(r=>({...r,qualityScore:analyze(r.text).score,qualityGrade:analyze(r.text).grade})),decisions:S.decisions,risks:S.risks,stakeholders:S.stakeholders||[],interfaces:S.interfaces||[],useCases:S.useCases||[],glossary:S.glossary,ruleWeights:S.ruleWeights};
  dl(JSON.stringify(data,null,2),"application/json",S.project.replace(/\s/g,"_")+"_requirements.json");
  toast("Saved project JSON","success");
}
function exportCSV(){
  const h=["ID","Text","Type","Level","Priority","Status","Verification","Rationale","Parent","Source","Risk","Score","Grade"];
  const rows=S.reqs.map(r=>{const a=analyze(r.text);return[r.id,'"'+(r.text||"").replace(/"/g,'""')+'"',r.type,r.level,r.priority,r.status,r.verification,'"'+(r.rationale||"").replace(/"/g,'""')+'"',r.parent,r.source,r.risk,a.score,a.grade];});
  dl([h.join(","),...rows.map(r=>r.join(","))].join("\n"),"text/csv",S.project.replace(/\s/g,"_")+".csv");
  toast("Exported CSV","success");
}
function exportReqIF(){dl(genReqIF(S.reqs,S.project),"application/xml",S.project.replace(/\s/g,"_")+".reqif");toast("Exported ReqIF","success");}

function exportPDF(){
  const sec=S.rptSections;
  const now=new Date();
  const dateStr=now.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
  const timeStr=now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});

  // Calculate statistics
  const stats={total:S.reqs.length,byLevel:{},byType:{},byStatus:{},avgScore:0,gradeA:0,gradeB:0,gradeC:0,gradeD:0,gradeF:0};
  let totalScore=0;
  S.reqs.forEach(r=>{
    const a=analyze(r.text);totalScore+=a.score;
    stats.byLevel[r.level]=(stats.byLevel[r.level]||0)+1;
    stats.byType[r.type]=(stats.byType[r.type]||0)+1;
    stats.byStatus[r.status]=(stats.byStatus[r.status]||0)+1;
    if(a.score>=90)stats.gradeA++;else if(a.score>=80)stats.gradeB++;else if(a.score>=70)stats.gradeC++;else if(a.score>=60)stats.gradeD++;else stats.gradeF++;
  });
  stats.avgScore=S.reqs.length>0?Math.round(totalScore/S.reqs.length):0;

  // Build traceability tree HTML
  function buildTreeHtml(parentId,level){
    const children=S.reqs.filter(r=>r.parent===parentId);if(children.length===0)return "";
    let result="";
    children.forEach(r=>{const a=analyze(r.text);const txt=escXml((r.text||"").substring(0,80))+((r.text||"").length>80?"...":"");const childHtml=buildTreeHtml(r.id,level+1);
      result+='<div class="tree-item level-'+level+'"><span class="tree-id">'+r.id+'</span><span class="tree-text">'+txt+'</span><span class="tree-meta">'+r.level.replace(" Requirement","")+" \xB7 "+a.score+'%</span>';
      if(childHtml)result+='<div class="tree-children">'+childHtml+'</div>';result+='</div>';});return result;
  }

  // Section builders - each returns HTML or empty string
  const builders={};

  builders.execSummary=()=>`<div class="section">
<h2>{{N}}. Executive Summary</h2>
<p>This report documents the "${escXml(S.project)}" project, analyzed against the INCOSE Guide to Writing Requirements (GtWR) version 4 standard with 42 quality rules.</p>
<div class="stat-grid">
<div class="stat-box"><div class="value">${stats.total}</div><div class="label">Requirements</div></div>
<div class="stat-box"><div class="value">${stats.avgScore}%</div><div class="label">Avg Quality</div></div>
<div class="stat-box"><div class="value">${stats.gradeA+stats.gradeB}</div><div class="label">Pass (\u226580%)</div></div>
<div class="stat-box"><div class="value">${S.risks.length}</div><div class="label">Risks</div></div>
<div class="stat-box"><div class="value">${S.decisions.length}</div><div class="label">Decisions</div></div>
<div class="stat-box"><div class="value">${S.stakeholders.length}</div><div class="label">Stakeholders</div></div>
<div class="stat-box"><div class="value">${S.interfaces.length}</div><div class="label">Interfaces</div></div>
<div class="stat-box"><div class="value">${S.useCases.length}</div><div class="label">Use Cases</div></div>
</div></div><div class="page-break"></div>`;

  builders.qualityStats=()=>`<div class="section">
<h2>{{N}}. Quality Statistics</h2>
<h3>Requirements by Level</h3>
<table><tr><th>Level</th><th>Count</th><th>%</th></tr>
${Object.entries(stats.byLevel).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td><td>${Math.round(v/stats.total*100)}%</td></tr>`).join("")}</table>
<h3>Requirements by Status</h3>
<table><tr><th>Status</th><th>Count</th><th>%</th></tr>
${Object.entries(stats.byStatus).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td><td>${Math.round(v/stats.total*100)}%</td></tr>`).join("")}</table>
<h3>Quality Distribution</h3>
<table><tr><th>Grade</th><th>Range</th><th>Count</th><th>%</th></tr>
<tr><td>A (Excellent)</td><td>90-100%</td><td>${stats.gradeA}</td><td>${Math.round(stats.gradeA/stats.total*100)||0}%</td></tr>
<tr><td>B (Good)</td><td>80-89%</td><td>${stats.gradeB}</td><td>${Math.round(stats.gradeB/stats.total*100)||0}%</td></tr>
<tr><td>C (Acceptable)</td><td>70-79%</td><td>${stats.gradeC}</td><td>${Math.round(stats.gradeC/stats.total*100)||0}%</td></tr>
<tr><td>D (Needs Work)</td><td>60-69%</td><td>${stats.gradeD}</td><td>${Math.round(stats.gradeD/stats.total*100)||0}%</td></tr>
<tr><td>F (Poor)</td><td>0-59%</td><td>${stats.gradeF}</td><td>${Math.round(stats.gradeF/stats.total*100)||0}%</td></tr>
</table></div><div class="page-break"></div>`;

  builders.requirements=()=>`<div class="section">
<h2>{{N}}. Requirements Register</h2>
<table><tr><th style="width:70px">ID</th><th style="width:45%">Statement</th><th>Type</th><th>Level</th><th>Status</th><th style="width:50px">Score</th></tr>
${S.reqs.map(r=>{const a=analyze(r.text);const sc=a.score>=90?"a":a.score>=80?"b":a.score>=70?"c":a.score>=60?"d":"f";
return`<tr><td style="font-family:monospace;font-size:9px;color:#0284c7;font-weight:600">${r.id}</td><td>${escXml(r.text)||"<em style='color:#94a3b8'>(empty)</em>"}</td><td style="font-size:9px">${r.type}</td><td style="font-size:9px">${r.level.replace(" Requirement","")}</td><td><span class="badge-sm badge-${r.status.toLowerCase()}">${r.status}</span></td><td class="score score-${sc}">${a.score}%</td></tr>`;}).join("")}
</table></div><div class="page-break"></div>`;

  builders.stakeholders=()=>S.stakeholders.length===0?"":`<div class="section">
<h2>{{N}}. Stakeholder Register</h2>
<table><tr><th style="width:70px">ID</th><th>Name</th><th>Organization</th><th style="width:80px">Role</th><th style="width:60px">Influence</th><th style="width:60px">Category</th><th>Key Concerns</th><th style="width:80px">Linked Needs</th></tr>
${S.stakeholders.map(s=>{const c=s.influence==="Critical"?"#dc2626":s.influence==="High"?"#ea580c":s.influence==="Medium"?"#d97706":"#059669";
return`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${escXml(s.id)}</td><td style="font-weight:600">${escXml(s.name||"")}</td><td>${escXml(s.organization||"")}</td><td>${escXml(s.role)}</td><td style="color:${c};font-weight:600">${escXml(s.influence)}</td><td>${escXml(s.category)}</td><td style="font-size:9px">${escXml((s.concerns||"").substring(0,120))}</td><td style="font-family:monospace;font-size:9px">${(s.linkedNeeds||[]).join(", ")}</td></tr>`;}).join("")}
</table></div><div class="page-break"></div>`;

  builders.useCases=()=>S.useCases.length===0?"":`<div class="section">
<h2>{{N}}. Use Cases &amp; Scenarios</h2>
<table><tr><th style="width:70px">ID</th><th>Title</th><th style="width:80px">Type</th><th style="width:55px">Priority</th><th style="width:55px">Status</th><th>Primary Actor</th><th style="width:80px">Derived Reqs</th></tr>
${S.useCases.map(u=>{const c=u.priority==="Critical"?"#dc2626":u.priority==="High"?"#ea580c":u.priority==="Medium"?"#d97706":"#059669";
return`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${escXml(u.id)}</td><td style="font-weight:600">${escXml(u.title||"")}</td><td>${escXml(u.type)}</td><td style="color:${c};font-weight:600">${escXml(u.priority)}</td><td>${escXml(u.status)}</td><td>${escXml(u.actor||"")}</td><td style="font-family:monospace;font-size:9px">${(u.derivedReqs||[]).join(", ")}</td></tr>`;}).join("")}
</table>
${S.useCases.map(u=>`<div style="margin:12px 0;padding:10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;page-break-inside:avoid;">
<div style="font-weight:700;font-size:11px;color:#0284c7;margin-bottom:6px;">${escXml(u.id)} \u2014 ${escXml(u.title||"Untitled")}</div>
<div style="font-size:9px;margin-bottom:4px;"><strong>Actor:</strong> ${escXml(u.actor||"\u2014")} \xB7 <strong>Trigger:</strong> ${escXml(u.trigger||"\u2014")}</div>
${(u.preconditions||"").trim()?`<div style="font-size:9px;margin-bottom:4px;"><strong>Preconditions:</strong><br>${escXml(u.preconditions)}</div>`:""}
${(u.mainFlow||"").trim()?`<div style="font-size:9px;margin-bottom:4px;"><strong>Main Flow:</strong><br><span style="font-family:monospace;white-space:pre-wrap;">${escXml(u.mainFlow)}</span></div>`:""}
${(u.alternativeFlows||"").trim()?`<div style="font-size:9px;margin-bottom:4px;"><strong>Alt Flows:</strong><br><span style="font-family:monospace;white-space:pre-wrap;">${escXml(u.alternativeFlows)}</span></div>`:""}
${(u.postconditions||"").trim()?`<div style="font-size:9px;"><strong>Postconditions:</strong><br>${escXml(u.postconditions)}</div>`:""}
</div>`).join("")}
</div><div class="page-break"></div>`;

  builders.interfaces=()=>S.interfaces.length===0?"":`<div class="section">
<h2>{{N}}. Interface Definitions</h2>
<table><tr><th style="width:70px">ID</th><th>Name</th><th style="width:65px">Type</th><th>Source</th><th style="width:30px"></th><th>Destination</th><th style="width:70px">Protocol</th><th style="width:55px">Status</th><th style="width:80px">Linked Reqs</th></tr>
${S.interfaces.map(i=>{const c=i.status==="Verified"||i.status==="Agreed"?"#059669":i.status==="Draft"?"#64748b":"#0284c7";const d=i.direction.includes("Bidirectional")?"\u2194":i.direction.includes("Broadcast")?"\u21C9":"\u2192";
return`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${escXml(i.id)}</td><td style="font-weight:600">${escXml(i.name||"")}</td><td>${escXml(i.type)}</td><td>${escXml(i.source||"")}</td><td style="text-align:center;font-size:14px;color:#0284c7">${d}</td><td>${escXml(i.destination||"")}</td><td>${escXml(i.protocol||"\u2014")}</td><td style="color:${c};font-weight:600">${escXml(i.status)}</td><td style="font-family:monospace;font-size:9px">${(i.linkedReqs||[]).join(", ")}</td></tr>`;}).join("")}
</table>
${S.interfaces.some(i=>(i.dataItems||"").trim())?`<h3>Interface Details</h3>
${S.interfaces.filter(i=>(i.dataItems||"").trim()||(i.dataRate||"").trim()).map(i=>`<div style="margin:8px 0;padding:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;">
<div style="font-weight:600;font-size:10px;color:#0284c7;margin-bottom:4px;">${escXml(i.id)} \u2014 ${escXml(i.name||"")}</div>
${(i.dataItems||"").trim()?`<div style="font-size:9px;"><strong>Data Items:</strong> ${escXml(i.dataItems.substring(0,200))}</div>`:""}
${(i.dataRate||"").trim()?`<div style="font-size:9px;"><strong>Data Rate:</strong> ${escXml(i.dataRate)}</div>`:""}
${(i.physicalChar||"").trim()?`<div style="font-size:9px;"><strong>Physical:</strong> ${escXml(i.physicalChar)}</div>`:""}
</div>`).join("")}`:""}</div><div class="page-break"></div>`;

  builders.risks=()=>S.risks.length===0?"":`<div class="section">
<h2>{{N}}. Risk Register</h2>
<table><tr><th style="width:70px">ID</th><th>Title</th><th style="width:70px">Category</th><th style="width:30px">L</th><th style="width:30px">I</th><th style="width:40px">Score</th><th style="width:55px">Level</th><th style="width:55px">Status</th><th>Mitigations</th><th>Owner</th></tr>
${S.risks.map(r=>{const sc=riskScore(r.likelihood,r.impact);const rl=riskLevel(sc);
return`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${escXml(r.id)}</td><td style="font-weight:600">${escXml(r.title)}</td><td>${escXml(r.category)}</td><td style="text-align:center">${r.likelihood}</td><td style="text-align:center">${r.impact}</td><td style="text-align:center;font-weight:700">${sc}</td><td style="color:${rl.color};font-weight:600">${rl.level}</td><td>${escXml(r.status)}</td><td style="font-size:9px">${(r.mitigations||[]).join("; ")}</td><td>${escXml(r.owner||"")}</td></tr>`;}).join("")}
</table></div><div class="page-break"></div>`;

  builders.decisions=()=>S.decisions.length===0?"":`<div class="section">
<h2>{{N}}. Decision Log</h2>
<table><tr><th style="width:70px">ID</th><th style="width:75px">Date</th><th>Title</th><th style="width:70px">Category</th><th style="width:60px">Status</th><th>Decision</th><th>Rationale</th><th style="width:90px">Affected Reqs</th></tr>
${S.decisions.map(d=>`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${escXml(d.id)}</td><td>${escXml(d.date)}</td><td style="font-weight:600">${escXml(d.title)}</td><td>${escXml(d.category)}</td><td>${escXml(d.status)}</td><td>${escXml(d.decision)}</td><td>${escXml(d.rationale)}</td><td style="font-family:monospace;font-size:9px">${(d.affectedReqs||[]).join(", ")}</td></tr>`).join("")}
</table></div><div class="page-break"></div>`;

  builders.hierarchy=()=>{
    let t='<div class="tree">';
    const sn=S.reqs.filter(r=>r.level==="Stakeholder Need");
    const orphans=S.reqs.filter(r=>!r.parent&&r.level!=="Stakeholder Need"&&!S.reqs.some(c=>c.parent===r.id));
    if(sn.length>0){t+='<h4 style="font-size:11px;color:#475569;margin:12px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">Stakeholder Needs</h4>';
      sn.forEach(r=>{const a=analyze(r.text);const txt=escXml((r.text||"").substring(0,80))+((r.text||"").length>80?"...":"");const ch=buildTreeHtml(r.id,1);
        t+='<div class="tree-item level-0"><span class="tree-id">'+r.id+'</span><span class="tree-text">'+txt+'</span><span class="tree-meta">'+a.score+'%</span>';if(ch)t+='<div class="tree-children">'+ch+'</div>';t+='</div>';});}
    const roots=S.reqs.filter(r=>!r.parent&&r.level!=="Stakeholder Need"&&S.reqs.some(c=>c.parent===r.id));
    if(roots.length>0){t+='<h4 style="font-size:11px;color:#475569;margin:20px 0 8px;border-bottom:1px solid #e2e8f0;padding-bottom:4px;">Other Root Requirements</h4>';
      roots.forEach(r=>{const a=analyze(r.text);const txt=escXml((r.text||"").substring(0,80))+((r.text||"").length>80?"...":"");const ch=buildTreeHtml(r.id,1);
        t+='<div class="tree-item level-0"><span class="tree-id">'+r.id+'</span><span class="tree-text">'+txt+'</span><span class="tree-meta">'+r.level.replace(" Requirement","")+' \xB7 '+a.score+'%</span>';if(ch)t+='<div class="tree-children">'+ch+'</div>';t+='</div>';});}
    t+='</div>';
    if(orphans.length>0){t+='<div class="orphan-box"><h4>\u26A0 Orphan Requirements</h4><p style="font-size:10px;color:#92400e;">Not linked to any hierarchy.</p><div style="margin-top:8px;">';
      orphans.forEach(r=>{t+='<span style="display:inline-block;font-family:monospace;font-size:9px;background:#fff;padding:2px 8px;border-radius:4px;margin:2px;">'+r.id+'</span>';});t+='</div></div>';}
    return`<div class="section"><h2>{{N}}. Traceability Tree</h2>
<p style="margin-bottom:16px;color:#64748b;font-size:11px;">Requirements hierarchy showing parent \u2192 child derivation.</p>
<style>.tree{margin:0;padding:0;}.tree-item{position:relative;padding:6px 0 6px 24px;border-left:2px solid #e2e8f0;}.tree-item:last-child{border-left-color:transparent;}.tree-item::before{content:"";position:absolute;left:-2px;top:14px;width:20px;height:2px;background:#e2e8f0;}.tree-item.level-0{border-left:none;padding-left:0;margin-top:12px;}.tree-item.level-0::before{display:none;}.tree-id{font-family:monospace;font-size:10px;font-weight:600;color:#0284c7;display:inline-block;min-width:70px;}.tree-text{font-size:10px;color:#475569;display:inline;}.tree-meta{font-size:9px;color:#94a3b8;margin-left:8px;}.tree-children{margin-left:20px;}.orphan-box{margin-top:24px;padding:12px;background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;}.orphan-box h4{font-size:12px;color:#92400e;margin-bottom:8px;}</style>
${t}</div><div class="page-break"></div>`;};

  builders.traceability=()=>`<div class="section">
<h2>{{N}}. Cross-Module Traceability</h2>
<p style="margin-bottom:16px;color:#64748b;font-size:11px;">Requirements linked across all modules.</p>
<table><tr><th style="width:70px">Req ID</th><th>Statement</th><th style="width:70px">Decisions</th><th style="width:70px">Stakeholders</th><th style="width:70px">Interfaces</th><th style="width:70px">Use Cases</th></tr>
${S.reqs.map(r=>{
  const dc=S.decisions.filter(d=>(d.affectedReqs||[]).includes(r.id)).map(d=>d.id);
  const sk=S.stakeholders.filter(s=>(s.linkedNeeds||[]).includes(r.id)).map(s=>s.id);
  const ic=S.interfaces.filter(i=>(i.linkedReqs||[]).includes(r.id)).map(i=>i.id);
  const uc=S.useCases.filter(u=>(u.derivedReqs||[]).includes(r.id)).map(u=>u.id);
  const bg=(dc.length+sk.length+ic.length+uc.length)===0?"#fef2f2":"transparent";
  return`<tr style="background:${bg}"><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${r.id}</td><td style="font-size:9px">${escXml((r.text||"").substring(0,60))}</td><td style="font-family:monospace;font-size:9px;text-align:center">${dc.join(", ")||"\u2014"}</td><td style="font-family:monospace;font-size:9px;text-align:center">${sk.join(", ")||"\u2014"}</td><td style="font-family:monospace;font-size:9px;text-align:center">${ic.join(", ")||"\u2014"}</td><td style="font-family:monospace;font-size:9px;text-align:center">${uc.join(", ")||"\u2014"}</td></tr>`;}).join("")}
</table>
<div style="margin-top:12px;font-size:10px;color:#64748b;"><span style="display:inline-block;width:12px;height:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:2px;vertical-align:middle;margin-right:4px;"></span> Red = no cross-module links</div>
</div><div class="page-break"></div>`;

  builders.vv=()=>`<div class="section">
<h2>{{N}}. Verification &amp; Validation</h2>
<table><tr><th style="width:70px">ID</th><th>Statement</th><th style="width:80px">V Method</th><th style="width:70px">Level</th><th style="width:55px">Status</th></tr>
${S.reqs.map(r=>`<tr><td style="font-family:monospace;font-size:9px;color:#38bdf8;font-weight:600">${r.id}</td><td style="font-size:9px">${escXml((r.text||"").substring(0,80))}</td><td style="font-weight:600">${escXml(r.verification||"Test")}</td><td style="font-size:9px">${r.level.replace(" Requirement","")}</td><td><span class="badge-sm badge-${r.status.toLowerCase()}">${r.status}</span></td></tr>`).join("")}
</table></div><div class="page-break"></div>`;

  builders.glossary=()=>S.glossary.length===0?"":`<div class="section">
<h2>{{N}}. Glossary</h2>
<table><tr><th style="width:150px">Term</th><th>Definition</th></tr>
${S.glossary.map(g=>`<tr><td style="font-weight:600">${escXml(g.term)}</td><td>${escXml(g.def)}</td></tr>`).join("")}
</table></div>`;

  // Layout ordering
  const layoutOrders={
    A:["execSummary","qualityStats","stakeholders","useCases","requirements","interfaces","risks","decisions","hierarchy","traceability","vv","glossary"],
    B:["execSummary","qualityStats","requirements","useCases","interfaces","stakeholders","risks","decisions","hierarchy","traceability","vv","glossary"],
    C:["execSummary","qualityStats","stakeholders","useCases","requirements","interfaces","risks","decisions","hierarchy","traceability","vv","glossary"]
  };
  const layoutNames={A:"ISO/INCOSE Standard",B:"NASA-style Hybrid",C:"Management-first"};
  const sectionLabels={execSummary:"Executive Summary",qualityStats:"Quality Statistics",requirements:"Requirements Register",stakeholders:"Stakeholder Register",useCases:"Use Cases & Scenarios",interfaces:"Interface Definitions",risks:"Risk Register",decisions:"Decision Log",hierarchy:"Traceability Tree",traceability:"Cross-Module Traceability",vv:"Verification & Validation",glossary:"Glossary"};

  // Build ordered active sections
  const order=layoutOrders[S.rptLayout]||layoutOrders.A;
  const active=order.filter(k=>sec[k]&&builders[k]);

  // Generate body with auto-numbering
  let sn=1;let bodyHtml="";
  active.forEach(k=>{let h=builders[k]();if(!h)return;h=h.replace(/\{\{N\}\}/g,String(sn));bodyHtml+=h;sn++;});

  // Generate TOC
  let tocHtml="";sn=1;
  active.forEach(k=>{if(!builders[k])return;const test=builders[k]();if(!test)return;
    tocHtml+=`<div class="toc-item"><span>${sn}. ${sectionLabels[k]||k}</span><span></span></div>`;sn++;});

  // Assemble
  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>${S.project} - Systems Engineering Report</title>
<style>
@page{size:A4;margin:20mm 15mm;}*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;line-height:1.5;color:#1e293b;}
.page-break{page-break-after:always;}
.cover{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;background:linear-gradient(135deg,#0f172a,#1e3a5f);}
.cover h1{font-size:32px;color:#fff;margin-bottom:8px;}.cover h2{font-size:18px;color:#94a3b8;font-weight:400;margin-bottom:40px;}
.cover .meta{color:#64748b;font-size:12px;}.cover .badge{display:inline-block;background:#38bdf8;color:#0f172a;padding:6px 16px;border-radius:20px;font-weight:600;margin-top:20px;}
.toc{padding:40px;}.toc h2{font-size:20px;border-bottom:2px solid #0284c7;padding-bottom:8px;margin-bottom:20px;}
.toc-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #e2e8f0;}.toc-item span:last-child{color:#64748b;}
.section{padding:20px 0;}.section h2{font-size:18px;color:#0f172a;border-bottom:2px solid #0284c7;padding-bottom:6px;margin-bottom:16px;}
.section h3{font-size:14px;color:#334155;margin:16px 0 10px;}
table{width:100%;border-collapse:collapse;margin:10px 0;font-size:10px;}
th{background:#f1f5f9;color:#475569;padding:8px 6px;text-align:left;font-weight:600;border:1px solid #e2e8f0;}
td{padding:6px;border:1px solid #e2e8f0;vertical-align:top;}tr:nth-child(even){background:#f8fafc;}
.score{font-weight:700;text-align:center;}.score-a{color:#059669;}.score-b{color:#0284c7;}.score-c{color:#d97706;}.score-d{color:#ea580c;}.score-f{color:#dc2626;}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0;}
.stat-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;text-align:center;}
.stat-box .value{font-size:24px;font-weight:700;color:#0f172a;}.stat-box .label{font-size:10px;color:#64748b;text-transform:uppercase;}
.footer{position:fixed;bottom:10mm;left:15mm;right:15mm;font-size:9px;color:#94a3b8;display:flex;justify-content:space-between;border-top:1px solid #e2e8f0;padding-top:8px;}
.badge-sm{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;}
.badge-draft{background:#fef3c7;color:#92400e;}.badge-reviewed{background:#ede9fe;color:#6d28d9;}.badge-approved{background:#d1fae5;color:#047857;}
</style></head><body>
<div class="cover">
<h1>${escXml(S.project)}</h1><h2>Systems Engineering Report</h2>
<div class="meta">Generated on ${dateStr} at ${timeStr}</div>
<div class="badge">INCOSE GtWR v4 Compliant</div>
<div style="margin-top:40px;color:#64748b;font-size:11px;">
<div>${stats.total} Requirements \xB7 ${S.risks.length} Risks \xB7 ${S.decisions.length} Decisions</div>
<div>${S.stakeholders.length} Stakeholders \xB7 ${S.interfaces.length} Interfaces \xB7 ${S.useCases.length} Use Cases</div>
<div style="margin-top:8px;">Average Quality Score: ${stats.avgScore}%</div>
<div style="margin-top:16px;font-size:10px;color:#475569;">Layout: ${layoutNames[S.rptLayout]} (Option ${S.rptLayout})</div>
</div></div>
<div class="page-break"></div>
<div class="toc"><h2>Table of Contents</h2>${tocHtml}</div>
<div class="page-break"></div>
${bodyHtml}
<div class="footer"><span>${escXml(S.project)} \u2014 Systems Engineering Report</span><span>Generated by ReqRight v2.6.0</span></div>
<div style="text-align:center;padding:8px;background:#0a0d12;font-size:9px;color:#4b5f82;border-top:1px solid #1c2744;">
ReqRight v2.6.0 \xB7 Independent educational project \xB7 Based on INCOSE\xAE GtWR v4 \xB7 Not affiliated with or endorsed by INCOSE\xAE, IBM\xAE, or any standards body.</div>
</body></html>`;

  const pw=window.open("","_blank");pw.document.write(html);pw.document.close();
  pw.onload=()=>{setTimeout(()=>{pw.print();},250);};
  toast("PDF report opened \u2014 use Print to save as PDF","success");
}

// ─── CSV PARSER ──────────────────────────────────────────
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2)return{headers:[],rows:[]};
  
  // Detect delimiter (comma, tab, semicolon)
  const firstLine=lines[0];
  let delimiter=",";
  if(firstLine.split("\t").length>firstLine.split(",").length)delimiter="\t";
  else if(firstLine.split(";").length>firstLine.split(",").length)delimiter=";";
  
  // Parse with proper quote handling
  function parseLine(line){
    const result=[];
    let current="";
    let inQuotes=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        if(inQuotes&&line[i+1]==='"'){current+='"';i++;}
        else inQuotes=!inQuotes;
      }else if(c===delimiter&&!inQuotes){
        result.push(current.trim());
        current="";
      }else{
        current+=c;
      }
    }
    result.push(current.trim());
    return result;
  }
  
  const headers=parseLine(lines[0]).map(h=>h.toLowerCase().replace(/[^a-z0-9]/g,""));
  const rows=lines.slice(1).map(l=>parseLine(l)).filter(r=>r.some(c=>c));
  return{headers,rows,delimiter};
}

function mapCSVToReqs(headers,rows){
  // Map common column names to requirement fields
  const colMap={};
  const fieldAliases={
    text:["text","statement","requirement","description","req","content","body"],
    id:["id","reqid","req-id","requirement id","number","#"],
    type:["type","category","reqtype","requirement type"],
    level:["level","tier","reqlevel"],
    priority:["priority","pri","importance"],
    status:["status","state"],
    verification:["verification","verificationmethod","vmethod","v&v"],
    rationale:["rationale","reason","justification","why"],
    parent:["parent","parentid","parent id","tracesto","derives from"],
    source:["source","origin","reference"],
    risk:["risk","risklevel"]
  };
  
  // Find matching columns
  headers.forEach((h,i)=>{
    for(const[field,aliases]of Object.entries(fieldAliases)){
      if(aliases.some(a=>h.includes(a.replace(/[^a-z0-9]/g,"")))){
        if(!colMap[field])colMap[field]=i;
      }
    }
  });
  
  // Must have text column
  if(colMap.text===undefined){
    // Try to find any column with "shall" in the data
    for(let i=0;i<headers.length;i++){
      if(rows.some(r=>r[i]&&/\bshall\b/i.test(r[i]))){
        colMap.text=i;
        break;
      }
    }
  }
  
  if(colMap.text===undefined)return[];
  
  // Convert rows to requirements
  return rows.map(row=>{
    const req={};
    if(colMap.text!==undefined)req.text=row[colMap.text]||"";
    if(colMap.type!==undefined&&row[colMap.type]){
      const t=row[colMap.type];
      const match=REQ_TYPES.find(rt=>rt.toLowerCase()===t.toLowerCase());
      if(match)req.type=match;
    }
    if(colMap.level!==undefined&&row[colMap.level]){
      const l=row[colMap.level];
      const match=REQ_LEVELS.find(rl=>rl.toLowerCase().includes(l.toLowerCase())||l.toLowerCase().includes(rl.toLowerCase().split(" ")[0]));
      if(match)req.level=match;
    }
    if(colMap.priority!==undefined&&row[colMap.priority]){
      const p=row[colMap.priority];
      const match=PRIORITIES.find(pr=>pr.toLowerCase()===p.toLowerCase());
      if(match)req.priority=match;
    }
    if(colMap.status!==undefined&&row[colMap.status]){
      const s=row[colMap.status];
      const match=STATUSES.find(st=>st.toLowerCase()===s.toLowerCase());
      if(match)req.status=match;
    }
    if(colMap.verification!==undefined&&row[colMap.verification]){
      const v=row[colMap.verification];
      const match=V_METHODS.find(vm=>vm.toLowerCase()===v.toLowerCase());
      if(match)req.verification=match;
    }
    if(colMap.rationale!==undefined)req.rationale=row[colMap.rationale]||"";
    if(colMap.source!==undefined)req.source=row[colMap.source]||"";
    return req;
  }).filter(r=>r.text&&r.text.trim());
}

function importFile(file,type){
  if(type==="xlsx"){
    // Excel import via SheetJS
    if(typeof XLSX==="undefined"){toast("Excel library not loaded. Check internet connection.","danger");return;}
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:"array"});
        const sheetNames=wb.SheetNames;
        const ws=wb.Sheets[sheetNames[0]];
        const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
        if(raw.length<2){toast("Spreadsheet is empty or has no data rows","danger");return;}
        const headers=raw[0].map(h=>String(h||"").trim());
        const rows=raw.slice(1).filter(r=>r.some(c=>c!==""));
        // Show preview/mapping modal
        S.xlsxPreview={headers,rows,sheetNames,activeSheet:0,wb,
          mapping:{text:-1,type:-1,level:-1,priority:-1,status:-1,verification:-1,rationale:-1,source:-1,parent:-1}
        };
        // Auto-detect column mapping
        const fieldAliases={text:["text","statement","requirement","description","req","content","body"],type:["type","category","reqtype"],level:["level","tier","reqlevel"],priority:["priority","pri","importance"],status:["status","state"],verification:["verification","verificationmethod","vmethod"],rationale:["rationale","reason","justification"],source:["source","origin","reference"],parent:["parent","parentid","tracesto","derivesfrom"]};
        headers.forEach((h,i)=>{const hn=h.toLowerCase().replace(/[^a-z0-9]/g,"");
          for(const[field,aliases]of Object.entries(fieldAliases)){if(S.xlsxPreview.mapping[field]===-1&&aliases.some(a=>hn.includes(a)))S.xlsxPreview.mapping[field]=i;}});
        render();
      }catch(err){toast("Error reading Excel file: "+err.message,"danger");}
    };
    reader.readAsArrayBuffer(file);
    return;
  }
  const reader=new FileReader();
  reader.onload=e=>{
    const content=e.target.result;
    if(type==="json"){
      try{
        const d=JSON.parse(content);
        if(d.requirements||d.risks||d.decisions||d.stakeholders||d.interfaces||d.useCases){
          History.save();
          if(d.requirements)d.requirements.forEach(r=>S.reqs.push(mkReq(r)));
          if(d.glossary)S.glossary=[...S.glossary,...d.glossary];
          if(d.decisions)d.decisions.forEach(dc=>{S.decisions.push({...mkDec(),...dc});});
          if(d.risks){d.risks.forEach(r=>{S.risks.push({...mkRisk(),...r});});_riskId=Math.max(_riskId,...d.risks.map(r=>parseInt(r.id.replace(/\D/g,""))||0));}
          if(d.stakeholders)d.stakeholders.forEach(s=>{S.stakeholders.push({...mkStk(),...s});});
          if(d.interfaces)d.interfaces.forEach(i=>{S.interfaces.push({...mkIfc(),...i});});
          if(d.useCases)d.useCases.forEach(u=>{S.useCases.push({...mkUc(),...u});});
          if(d.project)S.project=d.project;
          if(d.ruleWeights){S.ruleWeights={...S.ruleWeights,...d.ruleWeights};saveRuleWeights();}
          autoSave();
          let msg="Loaded";
          if(d.requirements&&d.requirements.length)msg+=" "+d.requirements.length+" requirements";
          if(d.risks&&d.risks.length)msg+=", "+d.risks.length+" risks";
          if(d.decisions&&d.decisions.length)msg+=", "+d.decisions.length+" decisions";
          if(d.stakeholders&&d.stakeholders.length)msg+=", "+d.stakeholders.length+" stakeholders";
          if(d.interfaces&&d.interfaces.length)msg+=", "+d.interfaces.length+" interfaces";
          if(d.useCases&&d.useCases.length)msg+=", "+d.useCases.length+" use cases";
          S.view="dashboard";
          toast(msg,"success");
        }else{
          toast("No data found in file","danger");
        }
      }catch(err){toast("Invalid JSON: "+err.message,"danger");}
      render();
    }else if(type==="csv"){
      // CSV/TSV import
      const{headers,rows}=parseCSV(content);
      if(rows.length===0){toast("No data found in file","danger");return;}
      const reqs=mapCSVToReqs(headers,rows);
      if(reqs.length===0){toast("No requirements found. Ensure there's a 'Text' or 'Statement' column.","danger");return;}
      History.save();
      reqs.forEach(r=>S.reqs.push(mkReq(r)));
      autoSave();
      toast(`Imported ${reqs.length} requirements from CSV`,"success");
      S.view="dashboard";
      render();
    }else{
      // Text document import (existing behavior)
      S.importText=content;
      S.showImport=true;
      render();
    }
  };
  reader.readAsText(file);
}

// ─── QUALITY PANEL UPDATE (without full re-render) ────────
function updateQualityPanel(id){
  const r=S.reqs.find(x=>x.id===id);
  if(!r)return;
  const a=analyze(r.text);
  
  // Update score display
  const scoreEl=document.getElementById("quality-score");
  if(scoreEl){
    const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
    scoreEl.textContent=String(a.score);
    scoreEl.style.color=sc;
  }
  
  // Update grade
  const gradeEl=document.getElementById("quality-grade");
  if(gradeEl)gradeEl.textContent="Grade: "+a.grade;
  
  // Update summary counts
  const summaryEl=document.getElementById("quality-summary");
  if(summaryEl)summaryEl.innerHTML=`<span style="color:var(--success)">✓ ${a.passed}</span><span style="color:var(--danger)">✕ ${a.failed}</span><span style="color:var(--warn)">⚠ ${a.warnings}</span>`;
  
  // Update AI panel visibility and content
  const aiPanel=document.getElementById("ai-panel");
  const successPanel=document.getElementById("success-panel");
  
  if(r.text.trim()&&a.failed>0){
    if(aiPanel){
      aiPanel.style.display="block";
      const aiInfo=aiPanel.querySelector(".ai-info");
      if(aiInfo)aiInfo.innerHTML=`<div style="font-size:15px;font-weight:700;color:var(--purple);margin-bottom:4px;">⚡ AI Requirement Improver</div><div style="font-size:12px;color:var(--textMid);">${a.failed} INCOSE violation${a.failed!==1?"s":""} detected — AI can fix: ${a.results.filter(x=>!x.pass).map(x=>x.id).join(", ")}</div>`;
      const aiTags=aiPanel.querySelector(".ai-tags");
      if(aiTags)aiTags.innerHTML=a.results.filter(x=>!x.pass).map(x=>`<div style="font-size:11px;padding:4px 10px;border-radius:6px;background:var(--danger)15;border:1px solid var(--danger)33;color:var(--danger);font-weight:500;display:inline-block;margin:3px;">${x.id}: ${x.msg.length>50?x.msg.slice(0,50)+"...":x.msg}</div>`).join("");
    }
    if(successPanel)successPanel.style.display="none";
  }else if(r.text.trim()&&a.failed===0){
    if(aiPanel)aiPanel.style.display="none";
    if(successPanel){
      successPanel.style.display="flex";
      const spText=successPanel.querySelector(".sp-text");
      if(spText)spText.innerHTML=`<div style="font-size:14px;font-weight:600;color:var(--success);">All automated INCOSE checks passed</div><div style="font-size:12px;color:var(--textMid);margin-top:2px;">Score: ${a.score}% (${a.grade}) — ${a.warnings} rules for manual review</div>`;
    }
  }else{
    if(aiPanel)aiPanel.style.display="none";
    if(successPanel)successPanel.style.display="none";
  }
  
  // Update rules panel
  const rulesPanel=document.getElementById("rules-panel");
  if(rulesPanel){
    let html='<div style="font-size:12px;font-weight:600;margin-bottom:12px;">Rule Analysis</div>';
    if(a.results.filter(x=>!x.pass).length===0&&r.text.trim()){
      html+=`<div style="padding:12px;background:var(--success)11;border-radius:8px;border:1px solid var(--success)33;color:var(--success);font-size:12px;margin-bottom:10px;">✓ All automated checks passed.</div>`;
    }
    a.results.filter(x=>!x.pass).forEach(x=>{
      html+=`<div style="padding:10px;background:var(--danger)0a;border-radius:8px;border:1px solid var(--danger)22;margin-bottom:6px;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span class="mono" style="font-size:11px;color:var(--danger);font-weight:600;">${x.id}</span><span class="badge" style="background:var(--danger)22;color:var(--danger);">FAIL</span></div><div style="font-size:11px;font-weight:600;color:var(--text);">${x.nm}</div><div style="font-size:11px;color:var(--textMid);line-height:1.5;margin-top:2px;">${x.msg}</div></div>`;
    });
    a.results.filter(x=>x.pass&&x.warn).forEach(x=>{
      html+=`<div style="padding:8px;background:var(--warn)08;border-radius:8px;border:1px solid var(--warn)22;margin-bottom:6px;"><div style="display:flex;justify-content:space-between;margin-bottom:2px;"><span class="mono" style="font-size:11px;color:var(--warn);font-weight:600;">${x.id} — ${x.nm}</span><span class="badge" style="background:var(--warn)22;color:var(--warn);">REVIEW</span></div><div style="font-size:11px;color:var(--textMid);line-height:1.4;">${x.msg}</div></div>`;
    });
    a.results.filter(x=>x.pass&&!x.warn).forEach(x=>{
      html+=`<div style="padding:6px;margin-bottom:4px;display:flex;align-items:center;gap:6px;"><span class="mono" style="font-size:11px;color:var(--success);">✓ ${x.id}</span><span style="font-size:10px;color:var(--textDim);">— ${x.nm}</span></div>`;
    });
    rulesPanel.innerHTML=html;
  }
}

// ─── RENDER ENGINE ────────────────────────────────────────
function h(tag,attrs,...children){
  const el=document.createElement(tag);
  if(attrs)for(const[k,v]of Object.entries(attrs)){
    if(k==="style"&&typeof v==="object"){Object.assign(el.style,v);}
    else if(k.startsWith("on")){el.addEventListener(k.slice(2).toLowerCase(),v);}
    else if(k==="className"){el.className=v;}
    else if(k==="value"&&(tag==="input"||tag==="textarea"||tag==="select")){el.value=v||"";}
    else if(k==="checked"){el.checked=v;}
    else if(k==="disabled"){el.disabled=v;}
    else if(k==="selected"){el.selected=v;}
    else if(k==="placeholder"){el.placeholder=v;}
    else if(k==="rows"){el.rows=v;}
    else if(k==="type"){el.type=v;}
    else if(k==="accept"){el.accept=v;}
    else if(k==="title"){el.title=v;}
    else if(k==="htmlFor"){el.htmlFor=v;}
    else{el.setAttribute(k,v);}
  }
  children.flat(Infinity).forEach(c=>{
    if(c==null||c===false)return;
    el.appendChild(typeof c==="string"||typeof c==="number"?document.createTextNode(c):c);
  });
  return el;
}

function render(){
  // Save focus state before rebuilding DOM
  const _fId=document.activeElement?.id||"";
  const _fStart=document.activeElement?.selectionStart;
  const _fEnd=document.activeElement?.selectionEnd;

  const app=document.getElementById("app");
  app.innerHTML="";

  const cur=S.reqs.find(r=>r.id===S.selId);
  const curA=cur?analyze(cur.text):null;

  // Store current analysis in global for panel updates
  S._curA=curA;

  // Toast
  if(S.toast){
    const bg=S.toast.type==="success"?"var(--success)":S.toast.type==="danger"?"var(--danger)":"var(--accent)";
    app.appendChild(h("div",{className:"toast",style:{background:bg}},
      S.toast.type==="success"?"✓ ":S.toast.type==="danger"?"✕ ":"ℹ ",S.toast.msg));
  }

  // ═══ WELCOME SCREEN ═══
  if(S.view==="welcome"){
    const hasAutoSave=!!localStorage.getItem(S.autoSaveKey);
    const overlay=h("div",{className:"welcome-overlay"});
    const card=h("div",{className:"welcome-card"});
    card.appendChild(h("div",{className:"welcome-logo"},"RR"));
    card.appendChild(h("h1",{style:{fontSize:"28px",fontWeight:700,letterSpacing:"-0.03em",marginBottom:"8px"}},"ReqRight"));
    card.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"14px",marginBottom:"32px",lineHeight:"1.6"}},"Free, open systems engineering workbench with 6 integrated modules — Requirements, Risks, Decisions, Stakeholders, Interfaces, and Use Cases. INCOSE GtWR v4 quality analysis with 42 rules. Cross-module traceability. Configurable PDF reports. Your data never leaves your machine."));

    // Continue button
    if(hasAutoSave){
      const contBtn=h("button",{className:"btn btn-ai",style:{width:"100%",marginBottom:"12px"},onClick:()=>{autoLoad();setState({view:"dashboard"})}},"▶ Continue Previous Session");
      card.appendChild(contBtn);
      try{const d=JSON.parse(localStorage.getItem(S.autoSaveKey));
        const parts=[(d.reqs?.length||0)+" reqs"];
        if(d.risks?.length)parts.push(d.risks.length+" risks");
        if(d.decisions?.length)parts.push(d.decisions.length+" decisions");
        if(d.stakeholders?.length)parts.push(d.stakeholders.length+" stakeholders");
        card.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"12px",marginBottom:"20px"}},parts.join(" · ")+" · Last saved "+new Date(d.savedAt).toLocaleString()));
      }catch(e){}
    }

    // New project
    card.appendChild(h("button",{className:"btn btn-pri",style:{width:"100%",marginBottom:"12px",padding:"14px"},onClick:()=>{localStorage.removeItem(S.autoSaveKey);S.reqs=[];S.decisions=[];S.risks=[];S.stakeholders=[];S.interfaces=[];S.useCases=[];S.glossary=[{term:"SOI",def:"System of Interest"},{term:"ICD",def:"Interface Control Document"},{term:"V&V",def:"Verification and Validation"},{term:"ConOps",def:"Concept of Operations"}];S.project="New Systems Engineering Project";setState({view:"dashboard"});}},"+ Start New Project"));

    // Load file
    const fileLabel=h("label",{className:"file-drop",style:{display:"block",marginBottom:"16px"}});
    fileLabel.appendChild(h("div",{style:{fontSize:"24px",opacity:".3",marginBottom:"8px"}},"📂"));
    fileLabel.appendChild(h("div",{style:{color:"var(--textMid)",fontSize:"13px"}},"Load Project (.json) · Import Spreadsheet (.xlsx, .csv)"));
    const fileInput=h("input",{type:"file",accept:".json,.txt,.csv,.tsv,.md,.xlsx,.xls",style:{display:"none"},onChange:e=>{const f=e.target.files[0];if(!f)return;const ext=f.name.split(".").pop().toLowerCase();importFile(f,ext==="json"?"json":(ext==="xlsx"||ext==="xls")?"xlsx":(ext==="csv"||ext==="tsv")?"csv":"text");}});
    fileLabel.appendChild(fileInput);
    fileLabel.addEventListener("dragover",e=>{e.preventDefault();fileLabel.classList.add("dragover");});
    fileLabel.addEventListener("dragleave",()=>fileLabel.classList.remove("dragover"));
    fileLabel.addEventListener("drop",e=>{e.preventDefault();fileLabel.classList.remove("dragover");const f=e.dataTransfer.files[0];if(f){const ext=f.name.split(".").pop().toLowerCase();importFile(f,ext==="json"?"json":(ext==="xlsx"||ext==="xls")?"xlsx":(ext==="csv"||ext==="tsv")?"csv":"text");}});
    card.appendChild(fileLabel);

    // Tutorial link
    const tutorialLink=h("a",{href:"https://github.com/ssaleem74/reqright#readme",target:"_blank",style:{display:"inline-block",marginBottom:"16px",color:"var(--accent)",fontSize:"13px",textDecoration:"none"}},"📖 Read the Tutorial & User Guide →");
    card.appendChild(tutorialLink);

    card.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"12px",lineHeight:"1.5"}},"🔒 Privacy-first: All data is processed in your browser. Nothing is uploaded to any server. Save your work as a JSON file to your machine and load it back anytime."));
    overlay.appendChild(card);
    app.appendChild(overlay);
    return;
  }

  // ═══ GLOBAL SEARCH MODAL ═══
  if(S.showSearch){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showSearch=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"720px",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column",padding:0},onClick:e=>e.stopPropagation()});
    // Search header
    const sHead=h("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",gap:"12px"}});
    sHead.appendChild(h("span",{style:{fontSize:"20px",opacity:.5}},"🔍"));
    const sInput=h("input",{id:"global-search-input",className:"input",style:{flex:1,fontSize:"16px",padding:"10px 14px",border:"none",background:"transparent",color:"var(--text)",outline:"none"},placeholder:"Search across all modules...",value:S.globalSearchQ||"",onInput:e=>{S.globalSearchQ=e.target.value;render();setTimeout(()=>{const el=document.getElementById("global-search-input");if(el){el.focus();el.selectionStart=el.selectionEnd=el.value.length;}},10);}});
    sHead.appendChild(sInput);
    sHead.appendChild(h("kbd",{style:{fontSize:"11px",padding:"2px 8px",borderRadius:"4px",background:"var(--surface)",color:"var(--textDim)",border:"1px solid var(--border)"}},"ESC"));
    modal.appendChild(sHead);

    // Results area
    const results=h("div",{style:{flex:1,overflowY:"auto",padding:"8px 12px",maxHeight:"calc(80vh - 80px)"}});
    const q=(S.globalSearchQ||"").toLowerCase().trim();
    let totalHits=0;

    if(q.length>=2){
      // Search requirements
      const rHits=S.reqs.filter(r=>r.id.toLowerCase().includes(q)||(r.text||"").toLowerCase().includes(q)||(r.rationale||"").toLowerCase().includes(q)||(r.source||"").toLowerCase().includes(q));
      if(rHits.length>0){
        totalHits+=rHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"8px 8px 4px"}},"☰ Requirements ("+rHits.length+")"));
        rHits.slice(0,10).forEach(r=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selId=r.id;S.showSearch=false;setState({view:"editor"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},r.id));
          row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px",flexShrink:0}},r.type));
          const txt=h("span",{style:{flex:1,fontSize:"13px",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}});txt.textContent=r.text?r.text.substring(0,80):"(empty)";
          row.appendChild(txt);
          results.appendChild(row);
        });
        if(rHits.length>10)results.appendChild(h("div",{style:{padding:"4px 12px",fontSize:"11px",color:"var(--textDim)",fontStyle:"italic"}},"... and "+(rHits.length-10)+" more requirements"));
      }

      // Search risks
      const rkHits=S.risks.filter(r=>r.id.toLowerCase().includes(q)||(r.title||"").toLowerCase().includes(q)||(r.description||"").toLowerCase().includes(q)||(r.owner||"").toLowerCase().includes(q));
      if(rkHits.length>0){
        totalHits+=rkHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"⚠ Risks ("+rkHits.length+")"));
        rkHits.slice(0,8).forEach(r=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selRiskId=r.id;S.showSearch=false;setState({view:"risks"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},r.id));
          const rl=riskLevel(riskScore(r.likelihood,r.impact));
          row.appendChild(h("span",{className:"badge",style:{background:rl.color+"22",color:rl.color,fontSize:"9px",flexShrink:0}},rl.level));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.title||"Untitled"));
          results.appendChild(row);
        });
      }

      // Search decisions
      const dcHits=S.decisions.filter(d=>d.id.toLowerCase().includes(q)||(d.title||"").toLowerCase().includes(q)||(d.decision||"").toLowerCase().includes(q)||(d.rationale||"").toLowerCase().includes(q));
      if(dcHits.length>0){
        totalHits+=dcHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"📋 Decisions ("+dcHits.length+")"));
        dcHits.slice(0,8).forEach(d=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selDecId=d.id;S.showSearch=false;setState({view:"decisions"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},d.id));
          row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px",flexShrink:0}},d.status));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},d.title||"Untitled"));
          results.appendChild(row);
        });
      }

      // Search stakeholders
      const stHits=S.stakeholders.filter(s=>s.id.toLowerCase().includes(q)||(s.name||"").toLowerCase().includes(q)||(s.organization||"").toLowerCase().includes(q)||(s.concerns||"").toLowerCase().includes(q)||(s.expectations||"").toLowerCase().includes(q));
      if(stHits.length>0){
        totalHits+=stHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"👥 Stakeholders ("+stHits.length+")"));
        stHits.slice(0,8).forEach(s=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selStkId=s.id;S.showSearch=false;setState({view:"stakeholders"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},s.id));
          row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px",flexShrink:0}},s.role));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},s.name||"Unnamed"));
          results.appendChild(row);
        });
      }

      // Search interfaces
      const ifHits=S.interfaces.filter(i=>i.id.toLowerCase().includes(q)||(i.name||"").toLowerCase().includes(q)||(i.source||"").toLowerCase().includes(q)||(i.destination||"").toLowerCase().includes(q)||(i.protocol||"").toLowerCase().includes(q)||(i.dataItems||"").toLowerCase().includes(q));
      if(ifHits.length>0){
        totalHits+=ifHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"🔌 Interfaces ("+ifHits.length+")"));
        ifHits.slice(0,8).forEach(i=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selIfcId=i.id;S.showSearch=false;setState({view:"interfaces"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},i.id));
          row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px",flexShrink:0}},i.type));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},i.name||"Unnamed"));
          results.appendChild(row);
        });
      }

      // Search use cases
      const ucHits=S.useCases.filter(u=>u.id.toLowerCase().includes(q)||(u.title||"").toLowerCase().includes(q)||(u.actor||"").toLowerCase().includes(q)||(u.mainFlow||"").toLowerCase().includes(q)||(u.trigger||"").toLowerCase().includes(q));
      if(ucHits.length>0){
        totalHits+=ucHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"📐 Use Cases ("+ucHits.length+")"));
        ucHits.slice(0,8).forEach(u=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.selUcId=u.id;S.showSearch=false;setState({view:"usecases"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,fontSize:"12px",minWidth:"65px"}},u.id));
          row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px",flexShrink:0}},u.type));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},u.title||"Untitled"));
          results.appendChild(row);
        });
      }

      // Search glossary
      const glHits=S.glossary.filter(g=>(g.term||"").toLowerCase().includes(q)||(g.def||"").toLowerCase().includes(q));
      if(glHits.length>0){
        totalHits+=glHits.length;
        results.appendChild(h("div",{style:{fontSize:"11px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em",padding:"12px 8px 4px"}},"📖 Glossary ("+glHits.length+")"));
        glHits.slice(0,8).forEach(g=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",borderRadius:"8px",cursor:"pointer",marginBottom:"2px"},onClick:()=>{S.showSearch=false;setState({view:"glossary"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surface)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          row.appendChild(h("span",{style:{fontWeight:700,fontSize:"13px",color:"var(--accent)",minWidth:"100px"}},g.term));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px",color:"var(--textMid)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},g.def));
          results.appendChild(row);
        });
      }

      if(totalHits===0){
        const empty=h("div",{style:{textAlign:"center",padding:"48px 20px"}});
        empty.appendChild(h("div",{style:{fontSize:"32px",opacity:.15,marginBottom:"8px"}},"🔍"));
        empty.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"14px"}},"No results for \""+S.globalSearchQ+"\""));
        empty.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",marginTop:"4px"}},"Searches across requirements, risks, decisions, stakeholders, interfaces, use cases, and glossary"));
        results.appendChild(empty);
      }else{
        results.appendChild(h("div",{style:{padding:"8px 12px",fontSize:"11px",color:"var(--textDim)",borderTop:"1px solid var(--border)",marginTop:"8px"}},totalHits+" result"+(totalHits!==1?"s":"")+" across all modules"));
      }
    }else{
      const hint=h("div",{style:{textAlign:"center",padding:"48px 20px"}});
      hint.appendChild(h("div",{style:{fontSize:"32px",opacity:.15,marginBottom:"8px"}},"🔍"));
      hint.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"14px"}},"Type to search across all modules"));
      hint.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",marginTop:"8px",lineHeight:"1.8"}},"Requirements · Risks · Decisions · Stakeholders · Interfaces · Use Cases · Glossary"));
      results.appendChild(hint);
    }
    modal.appendChild(results);
    overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ XLSX COLUMN MAPPING MODAL ═══
  if(S.xlsxPreview){
    const xp=S.xlsxPreview;
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.xlsxPreview=null;render();}});
    const modal=h("div",{className:"modal",style:{width:"860px",maxHeight:"88vh",overflow:"auto",padding:0},onClick:e=>e.stopPropagation()});

    const mHead=h("div",{style:{padding:"20px 24px 16px",borderBottom:"1px solid var(--border)"}});
    mHead.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"4px"}},"📊 Import from Excel"));
    mHead.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"13px"}},`Found ${xp.headers.length} columns and ${xp.rows.length} data rows. Map columns to requirement fields below.`));
    if(xp.sheetNames.length>1){
      const sheetSel=h("div",{style:{display:"flex",gap:"6px",marginTop:"10px"}});
      xp.sheetNames.forEach((sn,si)=>{
        sheetSel.appendChild(h("button",{className:"btn "+(si===xp.activeSheet?"btn-pri":"btn-sec"),style:{fontSize:"11px",padding:"4px 12px"},onClick:()=>{
          const ws=xp.wb.Sheets[sn];const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
          xp.headers=raw[0].map(hd=>String(hd||"").trim());xp.rows=raw.slice(1).filter(r=>r.some(c=>c!==""));xp.activeSheet=si;render();
        }},sn));
      });
      mHead.appendChild(sheetSel);
    }
    modal.appendChild(mHead);

    const mBody=h("div",{style:{padding:"20px 24px"}});
    // Column mapping
    const fields=[{k:"text",l:"Statement *",req:true},{k:"type",l:"Type"},{k:"level",l:"Level"},{k:"priority",l:"Priority"},{k:"status",l:"Status"},{k:"verification",l:"V&V Method"},{k:"rationale",l:"Rationale"},{k:"source",l:"Source"},{k:"parent",l:"Parent ID"}];
    const mapGrid=h("div",{style:{display:"grid",gridTemplateColumns:"140px 1fr 1fr",gap:"8px",marginBottom:"20px"}});
    mapGrid.appendChild(h("div",{style:{fontWeight:700,fontSize:"12px",color:"var(--textDim)"}},"Field"));
    mapGrid.appendChild(h("div",{style:{fontWeight:700,fontSize:"12px",color:"var(--textDim)"}},"Mapped Column"));
    mapGrid.appendChild(h("div",{style:{fontWeight:700,fontSize:"12px",color:"var(--textDim)"}},"Sample Data"));
    fields.forEach(f=>{
      mapGrid.appendChild(h("div",{style:{fontSize:"13px",fontWeight:f.req?700:500,color:f.req?"var(--accent)":"var(--text)",display:"flex",alignItems:"center"}},f.l));
      const sel=h("select",{className:"input",style:{fontSize:"12px",padding:"6px 8px"},value:String(xp.mapping[f.k]),onChange:e=>{xp.mapping[f.k]=parseInt(e.target.value);render();}});
      sel.appendChild(h("option",{value:"-1"},"— Not mapped —"));
      xp.headers.forEach((hdr,i)=>sel.appendChild(h("option",{value:String(i)},hdr||"Column "+(i+1))));
      sel.value=String(xp.mapping[f.k]);
      mapGrid.appendChild(sel);
      const ci=xp.mapping[f.k];
      const sample=ci>=0&&xp.rows.length>0?String(xp.rows[0][ci]||"").substring(0,60):"—";
      mapGrid.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",display:"flex",alignItems:"center",fontFamily:"var(--mono)"}},sample));
    });
    mBody.appendChild(mapGrid);

    // Preview table
    mBody.appendChild(h("div",{style:{fontSize:"13px",fontWeight:700,marginBottom:"8px"}},"Preview (first 5 rows)"));
    const prevTable=h("table",{style:{fontSize:"10px",marginBottom:"16px"}});
    const thead=h("tr");xp.headers.forEach(hdr=>thead.appendChild(h("th",{style:{padding:"4px 6px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},hdr||"(empty)")));
    prevTable.appendChild(thead);
    xp.rows.slice(0,5).forEach(row=>{
      const tr=h("tr");
      xp.headers.forEach((hdr,i)=>tr.appendChild(h("td",{style:{padding:"3px 6px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},String(row[i]||""))));
      prevTable.appendChild(tr);
    });
    mBody.appendChild(prevTable);
    modal.appendChild(mBody);

    // Footer
    const mFoot=h("div",{style:{padding:"16px 24px",borderTop:"1px solid var(--border)",display:"flex",justifyContent:"space-between",alignItems:"center"}});
    const validMap=xp.mapping.text>=0;
    mFoot.appendChild(h("span",{style:{fontSize:"11px",color:validMap?"var(--success)":"var(--danger)"}},validMap?`✓ Statement column mapped — ${xp.rows.length} rows ready`:"⚠ Map the Statement column to import"));
    const fBtns=h("div",{style:{display:"flex",gap:"8px"}});
    fBtns.appendChild(h("button",{className:"btn btn-sec",onClick:()=>{S.xlsxPreview=null;render();}},"Cancel"));
    fBtns.appendChild(h("button",{className:"btn btn-pri",style:{opacity:validMap?1:.5},onClick:()=>{
      if(!validMap)return;
      History.save();
      const mp=xp.mapping;let imported=0;
      xp.rows.forEach(row=>{
        const text=String(row[mp.text]||"").trim();if(!text)return;
        const o={text};
        if(mp.type>=0&&row[mp.type]){const m=REQ_TYPES.find(rt=>rt.toLowerCase()===String(row[mp.type]).toLowerCase());if(m)o.type=m;}
        if(mp.level>=0&&row[mp.level]){const l=String(row[mp.level]);const m=REQ_LEVELS.find(rl=>rl.toLowerCase().includes(l.toLowerCase()));if(m)o.level=m;}
        if(mp.priority>=0&&row[mp.priority]){const m=PRIORITIES.find(p=>p.toLowerCase()===String(row[mp.priority]).toLowerCase());if(m)o.priority=m;}
        if(mp.status>=0&&row[mp.status]){const m=STATUSES.find(s=>s.toLowerCase()===String(row[mp.status]).toLowerCase());if(m)o.status=m;}
        if(mp.verification>=0&&row[mp.verification]){const m=V_METHODS.find(v=>v.toLowerCase()===String(row[mp.verification]).toLowerCase());if(m)o.verification=m;}
        if(mp.rationale>=0)o.rationale=String(row[mp.rationale]||"");
        if(mp.source>=0)o.source=String(row[mp.source]||"");
        S.reqs.push(mkReq(o));imported++;
      });
      S.xlsxPreview=null;autoSave();
      toast(`Imported ${imported} requirements from Excel`,"success");
      S.view="dashboard";render();
    }},"Import "+xp.rows.length+" Rows"));
    mFoot.appendChild(fBtns);
    modal.appendChild(mFoot);
    overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ TEMPLATES MODAL ═══
  if(S.showTemplates){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showTemplates=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"900px",maxHeight:"88vh",overflow:"auto",padding:0},onClick:e=>e.stopPropagation()});

    const mHead=h("div",{style:{padding:"20px 24px 16px",borderBottom:"1px solid var(--border)"}});
    mHead.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"4px"}},"📋 Requirement Templates Library"));
    mHead.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"13px"}},"Click any template to insert it as a new requirement. Replace [placeholders] with your specific values."));
    modal.appendChild(mHead);

    const mBody=h("div",{style:{padding:"20px 24px"}});
    const catColors={"Functional":"var(--accent)","Performance":"#f59e0b","Interface":"#8b5cf6","Safety":"#ef4444","Security":"#ec4899","Reliability":"#10b981","Environmental":"#06b6d4","Maintainability":"#84cc16","Regulatory":"#f97316"};

    REQ_TEMPLATES.forEach(cat=>{
      const catSec=h("div",{style:{marginBottom:"20px"}});
      const catHead=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"}});
      catHead.appendChild(h("div",{style:{width:"4px",height:"20px",borderRadius:"2px",background:catColors[cat.cat]||"var(--accent)"}}));
      catHead.appendChild(h("div",{style:{fontSize:"14px",fontWeight:700,color:catColors[cat.cat]||"var(--accent)"}},cat.cat));
      catHead.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)"}},cat.templates.length+" templates"));
      catSec.appendChild(catHead);

      const grid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"}});
      cat.templates.forEach(t=>{
        const card=h("div",{style:{padding:"12px",borderRadius:"10px",border:"1px solid var(--border)",cursor:"pointer",transition:"all .15s"},onClick:()=>{
          History.save();const r=mkReq({text:t.text,type:t.type,level:t.level,verification:t.verification});
          S.reqs.push(r);S.selId=r.id;S.showTemplates=false;S.view="editor";autoSave();
          toast("Created "+r.id+" from template","success");render();
        }});
        card.addEventListener("mouseenter",()=>{card.style.borderColor="var(--accent)";card.style.background="var(--accentDim)22";});
        card.addEventListener("mouseleave",()=>{card.style.borderColor="var(--border)";card.style.background="transparent";});
        const top=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}});
        top.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600}},t.name));
        const tags=h("div",{style:{display:"flex",gap:"4px"}});
        tags.appendChild(h("span",{className:"badge",style:{fontSize:"9px",background:(catColors[t.type]||"var(--accent)")+"22",color:catColors[t.type]||"var(--accent)"}},t.type));
        tags.appendChild(h("span",{className:"badge",style:{fontSize:"9px"}},t.level.replace(" Requirement","")));
        top.appendChild(tags);
        card.appendChild(top);
        // Highlight placeholders in the template text
        const textDiv=h("div",{style:{fontSize:"11px",color:"var(--textMid)",lineHeight:"1.5"}});
        const parts=t.text.split(/(\[[^\]]+\])/g);
        parts.forEach(part=>{
          if(part.startsWith("[")){
            textDiv.appendChild(h("span",{style:{color:"var(--accent)",fontWeight:600,background:"var(--accentDim)22",padding:"1px 4px",borderRadius:"3px",fontSize:"10px"}},part));
          }else{
            textDiv.appendChild(document.createTextNode(part));
          }
        });
        card.appendChild(textDiv);
        grid.appendChild(card);
      });
      catSec.appendChild(grid);
      mBody.appendChild(catSec);
    });
    modal.appendChild(mBody);

    const mFoot=h("div",{style:{padding:"12px 24px",borderTop:"1px solid var(--border)",display:"flex",justifyContent:"space-between",alignItems:"center"}});
    const totalTemplates=REQ_TEMPLATES.reduce((s,c)=>s+c.templates.length,0);
    mFoot.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)"}},totalTemplates+" templates across "+REQ_TEMPLATES.length+" categories · Click to insert"));
    mFoot.appendChild(h("button",{className:"btn btn-sec",onClick:()=>{S.showTemplates=false;render();}},"Close"));
    modal.appendChild(mFoot);
    overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ REPORT CONFIGURATION MODAL ═══
  if(S.showReportCfg){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showReportCfg=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"820px",maxHeight:"88vh",overflow:"auto",padding:0},onClick:e=>e.stopPropagation()});

    // Header
    const mHead=h("div",{style:{padding:"20px 24px 16px",borderBottom:"1px solid var(--border)"}});
    mHead.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"4px"}},"📄 Generate Systems Engineering Report"));
    mHead.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"13px"}},"Select sections to include and choose a layout, then generate your PDF report."));
    modal.appendChild(mHead);

    const mBody=h("div",{style:{padding:"20px 24px"}});

    // ── Step 1: Section selection ──
    mBody.appendChild(h("div",{style:{fontSize:"13px",fontWeight:700,color:"var(--accent)",textTransform:"uppercase",letterSpacing:".06em",marginBottom:"12px"}},"Step 1 — Select Sections"));

    const secDefs=[
      {key:"execSummary",label:"Executive Summary",icon:"📊",desc:"Project overview, statistics, and quality metrics",always:true},
      {key:"qualityStats",label:"Quality Statistics",icon:"★",desc:"Grade distribution, level/type/status breakdowns"},
      {key:"stakeholders",label:"Stakeholder Register",icon:"👥",desc:S.stakeholders.length+" stakeholders",disabled:S.stakeholders.length===0},
      {key:"useCases",label:"Use Cases & Scenarios",icon:"📐",desc:S.useCases.length+" use cases",disabled:S.useCases.length===0},
      {key:"requirements",label:"Requirements Register",icon:"☰",desc:S.reqs.length+" requirements",always:true},
      {key:"interfaces",label:"Interface Definitions",icon:"🔌",desc:S.interfaces.length+" interfaces",disabled:S.interfaces.length===0},
      {key:"risks",label:"Risk Register",icon:"⚠",desc:S.risks.length+" risks",disabled:S.risks.length===0},
      {key:"decisions",label:"Decision Log",icon:"📋",desc:S.decisions.length+" decisions",disabled:S.decisions.length===0},
      {key:"hierarchy",label:"Traceability Tree",icon:"🌳",desc:"Parent-child requirement hierarchy"},
      {key:"traceability",label:"Cross-Module Traceability",icon:"◫",desc:"Requirements linked across all modules"},
      {key:"vv",label:"Verification & Validation",icon:"✓",desc:"V&V method assignments per requirement"},
      {key:"glossary",label:"Glossary",icon:"📖",desc:S.glossary.length+" terms",disabled:S.glossary.length===0},
    ];

    const secGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px",marginBottom:"24px"}});
    secDefs.forEach(sd=>{
      const isOn=S.rptSections[sd.key];
      const isDisabled=sd.disabled;
      const card=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 14px",borderRadius:"10px",border:"1px solid "+(isDisabled?"var(--border)":isOn?"var(--accent)":"var(--border)"),background:isDisabled?"transparent":isOn?"var(--accentDim)":"transparent",cursor:isDisabled?"not-allowed":"pointer",opacity:isDisabled?.4:1,transition:"all .15s ease"},onClick:()=>{
        if(isDisabled||sd.always)return;
        S.rptSections[sd.key]=!S.rptSections[sd.key];render();
      }});
      // Checkbox
      const chk=h("div",{style:{width:"20px",height:"20px",borderRadius:"5px",border:"2px solid "+(isOn?"var(--accent)":"var(--border)"),background:isOn?"var(--accent)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:"12px",color:"#fff",fontWeight:700}});
      if(isOn)chk.textContent="✓";
      if(sd.always){chk.style.opacity=".6";chk.title="Always included";}
      card.appendChild(chk);
      const info=h("div",{style:{flex:1,minWidth:0}});
      info.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,display:"flex",alignItems:"center",gap:"6px"}},sd.icon+" "+sd.label));
      info.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"1px"}},sd.desc));
      card.appendChild(info);
      if(!isDisabled){card.addEventListener("mouseenter",()=>{if(!sd.always)card.style.borderColor="var(--accent)";});card.addEventListener("mouseleave",()=>{if(!sd.always&&!S.rptSections[sd.key])card.style.borderColor="var(--border)";});}
      secGrid.appendChild(card);
    });
    mBody.appendChild(secGrid);

    // Quick actions
    const qRow=h("div",{style:{display:"flex",gap:"8px",marginBottom:"24px"}});
    qRow.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"11px",padding:"4px 12px"},onClick:()=>{Object.keys(S.rptSections).forEach(k=>S.rptSections[k]=true);render();}},"Select All"));
    qRow.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"11px",padding:"4px 12px"},onClick:()=>{Object.keys(S.rptSections).forEach(k=>{const def=secDefs.find(d=>d.key===k);S.rptSections[k]=def?.always||false;});render();}},"Minimum"));
    const selCount=Object.values(S.rptSections).filter(Boolean).length;
    qRow.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)",alignSelf:"center",marginLeft:"8px"}},selCount+" of "+Object.keys(S.rptSections).length+" sections selected"));
    mBody.appendChild(qRow);

    // ── Step 2: Layout selection ──
    mBody.appendChild(h("div",{style:{fontSize:"13px",fontWeight:700,color:"var(--accent)",textTransform:"uppercase",letterSpacing:".06em",marginBottom:"12px"}},"Step 2 — Choose Layout"));

    const layouts=[
      {id:"A",title:"ISO/INCOSE Standard",desc:"Stakeholders → Use Cases → Requirements → Interfaces → Risks → Decisions → Traceability → Glossary",tag:"Formal Reviews"},
      {id:"B",title:"NASA-style Hybrid",desc:"Requirements → Use Cases → Interfaces → Stakeholders → Risks → Decisions → Traceability → Glossary",tag:"Aerospace / Defence"},
      {id:"C",title:"Management-first",desc:"Exec Summary → Quality → Stakeholders → Use Cases → Requirements → Interfaces → Risks → Decisions → Traceability → Glossary",tag:"Leadership Audience"},
    ];

    const layGrid=h("div",{style:{display:"flex",gap:"10px",marginBottom:"24px"}});
    layouts.forEach(lo=>{
      const isSel=S.rptLayout===lo.id;
      const lCard=h("div",{style:{flex:1,padding:"14px",borderRadius:"10px",border:"2px solid "+(isSel?"var(--accent)":"var(--border)"),background:isSel?"var(--accentDim)":"transparent",cursor:"pointer",transition:"all .15s ease"},onClick:()=>{S.rptLayout=lo.id;render();}});
      const top=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}});
      top.appendChild(h("div",{style:{fontSize:"14px",fontWeight:700,color:isSel?"var(--accent)":"var(--text)"}},"Option "+lo.id));
      if(isSel)top.appendChild(h("div",{style:{width:"20px",height:"20px",borderRadius:"50%",background:"var(--accent)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"11px",color:"#fff",fontWeight:700}},"✓"));
      else top.appendChild(h("div",{style:{width:"20px",height:"20px",borderRadius:"50%",border:"2px solid var(--border)"}}));
      lCard.appendChild(top);
      lCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"4px"}},lo.title));
      lCard.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)",lineHeight:"1.5",marginBottom:"6px"}},lo.desc));
      lCard.appendChild(h("span",{className:"badge",style:{background:isSel?"var(--accent)22":"var(--surface)",color:isSel?"var(--accent)":"var(--textDim)",fontSize:"9px"}},lo.tag));
      lCard.addEventListener("mouseenter",()=>{lCard.style.borderColor="var(--accent)";});
      lCard.addEventListener("mouseleave",()=>{if(S.rptLayout!==lo.id)lCard.style.borderColor="var(--border)";});
      layGrid.appendChild(lCard);
    });
    mBody.appendChild(layGrid);

    modal.appendChild(mBody);

    // Footer
    const mFoot=h("div",{style:{padding:"16px 24px",borderTop:"1px solid var(--border)",display:"flex",justifyContent:"space-between",alignItems:"center"}});
    mFoot.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)"}},"Report will open in a new tab — use Print → Save as PDF"));
    const fBtns=h("div",{style:{display:"flex",gap:"8px"}});
    fBtns.appendChild(h("button",{className:"btn btn-sec",onClick:()=>{S.showReportCfg=false;render();}},"Cancel"));
    fBtns.appendChild(h("button",{className:"btn btn-pri",style:{padding:"10px 28px",fontSize:"14px"},onClick:()=>{S.showReportCfg=false;exportPDF();}},"📄 Generate Report"));
    mFoot.appendChild(fBtns);
    modal.appendChild(mFoot);

    overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ IMPORT MODAL ═══
  if(S.showImport){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showImport=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"720px",maxHeight:"80vh",overflow:"auto"},onClick:e=>e.stopPropagation()});
    modal.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"8px"}},"Import from Document"));
    modal.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"13px",marginBottom:"16px"}},"Paste document text. All lines containing 'shall' will be extracted and auto-classified."));
    const ta=h("textarea",{className:"input mono",style:{height:"300px",resize:"vertical",lineHeight:"1.7",fontSize:"12px"},value:S.importText,placeholder:"Paste requirements document here...\n\nExamples:\n• REQ-001: The system shall process data within 500 ms.\n• The Navigation_Module shall compute position within ±10 m.\n• 3.2.1 The subsystem shall interface via RS-422.",onInput:e=>{S.importText=e.target.value;const cnt=(e.target.value.match(/\bshall\b/gi)||[]).length;modal.querySelector(".shall-count").textContent=cnt+" 'shall' statements detected";}});
    modal.appendChild(ta);
    const bar=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"16px"}});
    bar.appendChild(h("span",{className:"shall-count",style:{fontSize:"13px",color:"var(--textMid)"}},S.importText?(S.importText.match(/\bshall\b/gi)||[]).length+" 'shall' statements detected":""));
    const btns=h("div",{style:{display:"flex",gap:"8px"}});
    btns.appendChild(h("button",{className:"btn btn-sec",onClick:()=>{S.showImport=false;render();}},"Cancel"));
    btns.appendChild(h("button",{className:"btn btn-pri",onClick:doImport},"Import Requirements"));
    bar.appendChild(btns);modal.appendChild(bar);overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ BULK AI MODAL ═══
  if(S.showBulkAI){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showBulkAI=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"900px",maxHeight:"85vh",overflow:"auto"},onClick:e=>e.stopPropagation()});
    const hdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"}});
    hdr.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700}},"Bulk Quality Analysis"));
    const hbtns=h("div",{style:{display:"flex",gap:"8px"}});
    hbtns.appendChild(h("button",{className:"btn btn-ai",style:{padding:"10px 24px",fontSize:"13px"},onClick:()=>{bulkAI();S.showBulkAI=false;}},"⚡ Auto-Fix All Below 80%"));
    // LLM batch button
    const llmConfigured=S.llm.apiKey&&S.llm.apiKey.length>10;
    if(llmConfigured){
      const batchRunning=S.llmBatch&&S.llmBatch.running;
      const llmBatchBtn=h("button",{style:{padding:"10px 24px",background:batchRunning?"var(--surfAlt)":"linear-gradient(135deg,#8b5cf6,#06b6d4)",color:"#fff",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:600,cursor:batchRunning?"not-allowed":"pointer",fontFamily:"inherit",opacity:batchRunning?0.6:1},disabled:batchRunning,onClick:()=>{if(!batchRunning)bulkLLMAI(80);}},batchRunning?"✨ Running...":"✨ LLM Fix All Below 80%");
      hbtns.appendChild(llmBatchBtn);
    }
    hbtns.appendChild(h("button",{className:"btn btn-sec",onClick:()=>{S.showBulkAI=false;render();}},"Close"));
    hdr.appendChild(hbtns);modal.appendChild(hdr);

    // LLM batch progress panel
    if(S.llmBatch){
      const bp=h("div",{style:{background:"var(--surface)",borderRadius:"10px",padding:"16px",border:"1px solid var(--purple)33",marginBottom:"16px"}});
      const bpHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}});
      bpHead.appendChild(h("div",{style:{fontSize:"14px",fontWeight:600,color:"var(--purple)"}},S.llmBatch.running?"✨ LLM Batch Rewrite in Progress...":"✨ LLM Batch Rewrite Complete"));
      bpHead.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)"}},S.llmBatch.done+" / "+S.llmBatch.total));
      bp.appendChild(bpHead);

      // Progress bar
      const pct=S.llmBatch.total>0?Math.round(S.llmBatch.done/S.llmBatch.total*100):0;
      const barBg=h("div",{style:{height:"8px",borderRadius:"4px",background:"var(--border)",overflow:"hidden",marginBottom:"12px"}});
      barBg.appendChild(h("div",{style:{height:"100%",width:pct+"%",borderRadius:"4px",background:"linear-gradient(90deg,#8b5cf6,#06b6d4)",transition:"width .3s"}}));
      bp.appendChild(barBg);

      // Stats row
      const stats=h("div",{style:{display:"flex",gap:"16px",marginBottom:"10px"}});
      stats.appendChild(h("span",{style:{fontSize:"12px",color:"var(--success)"}},"✓ "+S.llmBatch.improved+" improved"));
      stats.appendChild(h("span",{style:{fontSize:"12px",color:"var(--danger)"}},"✕ "+S.llmBatch.failed+" failed"));
      if(S.llmBatch.running&&S.llmBatch.currentId){
        stats.appendChild(h("span",{style:{fontSize:"12px",color:"var(--purple)"}},"⏳ Processing "+S.llmBatch.currentId+"..."));
      }
      bp.appendChild(stats);

      // Results list (compact)
      if(S.llmBatch.results.length>0){
        const resList=h("div",{style:{maxHeight:"150px",overflowY:"auto"}});
        S.llmBatch.results.forEach(res=>{
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 0",fontSize:"12px"}});
          row.appendChild(h("span",{style:{color:"var(--accent)",fontFamily:"var(--mono)",fontWeight:600,minWidth:"60px"}},res.id));
          if(res.status==="ok"){
            row.appendChild(h("span",{style:{color:"var(--textMid)"}},res.oldScore+"% → "+res.newScore+"%"));
            const diff=res.newScore-res.oldScore;
            row.appendChild(h("span",{style:{color:diff>0?"var(--success)":"var(--danger)",fontWeight:600}},(diff>0?"+":"")+diff+"%"));
          } else {
            row.appendChild(h("span",{style:{color:"var(--danger)"}},"Error: "+(res.msg||"failed")));
          }
          resList.appendChild(row);
        });
        bp.appendChild(resList);
      }

      // Clear button when done
      if(!S.llmBatch.running){
        bp.appendChild(h("button",{style:{marginTop:"8px",padding:"6px 14px",borderRadius:"6px",border:"1px solid var(--border)",background:"transparent",color:"var(--textMid)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit"},onClick:()=>{S.llmBatch=null;render();}},"✕ Dismiss"));
      }
      modal.appendChild(bp);
    }

    let anyFails=false;
    S.reqs.forEach(r=>{
      const a=analyze(r.text);const fails=a.results.filter(x=>!x.pass);
      if(!fails.length)return;anyFails=true;
      const row=h("div",{style:{background:"var(--surface)",borderRadius:"10px",padding:"16px",border:"1px solid var(--border)",marginBottom:"12px"}});
      const rh=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}});
      const lf=h("div",{style:{display:"flex",alignItems:"center",gap:"12px"}});
      lf.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--accent)",fontWeight:600}},r.id));
      const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
      lf.appendChild(h("span",{className:"badge",style:{background:sc+"22",color:sc}},a.score+"% ("+a.grade+")"));
      rh.appendChild(lf);
      const rowBtns=h("div",{style:{display:"flex",gap:"4px"}});
      rowBtns.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"4px 12px"},onClick:()=>doAI(r.id)},"⚡ Auto-Fix"));
      if(llmConfigured){
        const lrb=h("button",{style:{padding:"4px 12px",borderRadius:"6px",border:"none",background:"linear-gradient(135deg,#8b5cf6,#06b6d4)",color:"#fff",fontSize:"12px",fontWeight:600,cursor:"pointer",fontFamily:"inherit"},onClick:()=>{S.showBulkAI=false;S.selId=r.id;S.view="editor";render();setTimeout(()=>doLLMAI(r.id),100);}});
        lrb.textContent="✨ LLM";rowBtns.appendChild(lrb);
      }
      rh.appendChild(rowBtns);
      row.appendChild(rh);
      row.appendChild(h("p",{style:{fontSize:"13px",color:"var(--text)",marginBottom:"8px",lineHeight:"1.5"}},r.text||"(empty)"));
      const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
      fails.forEach(f=>tags.appendChild(h("span",{className:"badge",style:{background:"var(--danger)22",color:"var(--danger)"}},f.id+": "+f.nm)));
      row.appendChild(tags);modal.appendChild(row);
    });
    if(!anyFails)modal.appendChild(h("div",{style:{padding:"32px",textAlign:"center",color:"var(--success)",fontSize:"14px"}},"✓ All requirements pass automated checks."));
    overlay.appendChild(modal);app.appendChild(overlay);
  }

  // ═══ LLM SETTINGS MODAL ═══
  if(S.showLLMSettings){
    const overlay=h("div",{className:"modal-overlay",onClick:()=>{S.showLLMSettings=false;render();}});
    const modal=h("div",{className:"modal",style:{width:"560px",maxHeight:"88vh",overflow:"auto",padding:0},onClick:e=>e.stopPropagation()});

    // Header
    const mHead=h("div",{style:{padding:"20px 24px 16px",borderBottom:"1px solid var(--border)"}});
    const mTitle=h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}});
    mTitle.appendChild(h("h2",{style:{fontSize:"18px",fontWeight:700}},"🤖 LLM Configuration"));
    const closeBtn=h("button",{style:{background:"none",border:"none",color:"var(--textMid)",fontSize:"18px",cursor:"pointer",padding:"4px 8px"},onClick:()=>{S.showLLMSettings=false;render();}},"✕");
    mTitle.appendChild(closeBtn);
    mHead.appendChild(mTitle);
    mHead.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"12px",marginTop:"4px"}},"Connect your own API key to enable smart rewrite, requirement generation, and AI-powered analysis. Your key is stored locally and never sent to our servers."));
    modal.appendChild(mHead);

    const mBody=h("div",{style:{padding:"20px 24px"}});

    // Status banner
    const configured=S.llm.apiKey&&S.llm.apiKey.length>10;
    const statusBanner=h("div",{style:{padding:"12px 16px",borderRadius:"8px",marginBottom:"20px",border:"1px solid",borderColor:configured?(S.llm.testStatus==="ok"?"var(--success)":"var(--accent)"):"var(--border)",background:configured?(S.llm.testStatus==="ok"?"var(--success)11":"var(--accent)11"):"var(--surfAlt)"}});
    if(!configured){
      statusBanner.appendChild(h("div",{style:{fontSize:"13px",color:"var(--textMid)"}},"⚪ No API key configured — LLM features disabled. All core features work offline."));
    } else if(S.llm.testStatus==="ok"){
      statusBanner.appendChild(h("div",{style:{fontSize:"13px",color:"var(--success)"}},"🟢 Connected — LLM features enabled."));
    } else if(S.llm.testStatus==="error"){
      statusBanner.appendChild(h("div",{style:{fontSize:"13px",color:"var(--danger)"}},"🔴 Connection failed: "+(S.llm.testMsg||"Unknown error")));
    } else {
      statusBanner.appendChild(h("div",{style:{fontSize:"13px",color:"var(--accent)"}},"🔵 API key set — click Test Connection to verify."));
    }
    mBody.appendChild(statusBanner);

    // Provider selector
    const provField=h("div",{style:{marginBottom:"16px"}});
    provField.appendChild(h("label",{style:{display:"block",fontSize:"12px",fontWeight:600,color:"var(--textMid)",marginBottom:"6px",textTransform:"uppercase",letterSpacing:".05em"}},"Provider"));
    const provRow=h("div",{style:{display:"flex",gap:"8px"}});
    [{k:"anthropic",l:"Anthropic Claude",icon:"🟣"},{k:"openai",l:"OpenAI",icon:"🟢"}].forEach(p=>{
      const active=S.llm.provider===p.k;
      const btn=h("button",{style:{flex:1,padding:"10px 16px",borderRadius:"8px",border:"1px solid "+(active?"var(--accent)":"var(--border)"),background:active?"var(--accent)11":"transparent",color:active?"var(--accent)":"var(--textMid)",cursor:"pointer",fontSize:"13px",fontWeight:active?600:400,fontFamily:"inherit",transition:"all .15s"},onClick:()=>{
        S.llm.provider=p.k;
        S.llm.model=p.k==="anthropic"?"claude-sonnet-4-5-20250929":"gpt-4o";
        S.llm.testStatus=null;S.llm.testMsg="";saveLLM();render();
      }});
      btn.textContent=p.icon+" "+p.l;
      btn.addEventListener("mouseenter",()=>{if(!active)btn.style.borderColor="var(--textMid)";});
      btn.addEventListener("mouseleave",()=>{if(!active)btn.style.borderColor="var(--border)";});
      provRow.appendChild(btn);
    });
    provField.appendChild(provRow);
    mBody.appendChild(provField);

    // Model selector
    const modelField=h("div",{style:{marginBottom:"16px"}});
    modelField.appendChild(h("label",{style:{display:"block",fontSize:"12px",fontWeight:600,color:"var(--textMid)",marginBottom:"6px",textTransform:"uppercase",letterSpacing:".05em"}},"Model"));
    const models=S.llm.provider==="anthropic"
      ?[{k:"claude-sonnet-4-5-20250929",l:"Claude Sonnet 4.5 (recommended)"},{k:"claude-haiku-4-5-20251001",l:"Claude Haiku 4.5 (fast, cheap)"},{k:"claude-opus-4-5-20250929",l:"Claude Opus 4.5 (most capable)"}]
      :[{k:"gpt-4o",l:"GPT-4o (recommended)"},{k:"gpt-4o-mini",l:"GPT-4o Mini (fast, cheap)"},{k:"gpt-4.1",l:"GPT-4.1 (latest)"}];
    const modelSel=h("select",{style:{width:"100%",padding:"10px 14px",borderRadius:"8px",border:"1px solid var(--border)",background:"var(--surfAlt)",color:"var(--text)",fontSize:"13px",fontFamily:"inherit",cursor:"pointer"},value:S.llm.model,onChange:e=>{S.llm.model=e.target.value;S.llm.testStatus=null;saveLLM();render();}});
    models.forEach(m=>{const opt=h("option",{value:m.k},m.l);if(S.llm.model===m.k)opt.selected=true;modelSel.appendChild(opt);});
    modelField.appendChild(modelSel);
    mBody.appendChild(modelField);

    // API Key input
    const keyField=h("div",{style:{marginBottom:"20px"}});
    keyField.appendChild(h("label",{style:{display:"block",fontSize:"12px",fontWeight:600,color:"var(--textMid)",marginBottom:"6px",textTransform:"uppercase",letterSpacing:".05em"}},"API Key"));
    const keyRow=h("div",{style:{display:"flex",gap:"8px"}});
    const keyInput=h("input",{type:"password",id:"llm-key-input",placeholder:S.llm.provider==="anthropic"?"sk-ant-api03-...":"sk-...",value:S.llm.apiKey||"",style:{flex:1,padding:"10px 14px",borderRadius:"8px",border:"1px solid var(--border)",background:"var(--surfAlt)",color:"var(--text)",fontSize:"13px",fontFamily:"var(--mono)"}});
    const updateKey=()=>{const v=document.getElementById("llm-key-input").value.trim();S.llm.apiKey=v;S.llm.testStatus=null;S.llm.testMsg="";saveLLM();render();};
    keyInput.addEventListener("input",updateKey);
    keyInput.addEventListener("paste",()=>setTimeout(updateKey,50));
    keyInput.addEventListener("change",updateKey);
    keyRow.appendChild(keyInput);
    const showKeyBtn=h("button",{style:{padding:"10px 14px",borderRadius:"8px",border:"1px solid var(--border)",background:"var(--surfAlt)",color:"var(--textMid)",cursor:"pointer",fontSize:"14px",fontFamily:"inherit"},onClick:()=>{const inp=document.getElementById("llm-key-input");inp.type=inp.type==="password"?"text":"password";}});
    showKeyBtn.textContent="👁";showKeyBtn.title="Show/hide key";
    keyRow.appendChild(showKeyBtn);
    keyField.appendChild(keyRow);
    keyField.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"6px"}},S.llm.provider==="anthropic"?"Get your key at console.anthropic.com → API Keys":"Get your key at platform.openai.com → API keys"));
    mBody.appendChild(keyField);

    // Action buttons
    const actions=h("div",{style:{display:"flex",gap:"10px",alignItems:"center"}});
    const testBtn=h("button",{className:"btn btn-pri",style:{padding:"10px 20px",opacity:configured?1:.5,cursor:configured?"pointer":"not-allowed"},onClick:()=>{if(configured)testLLMConnection();}});
    testBtn.textContent=S.llm.testStatus==="testing"?"⏳ Testing...":"🔌 Test Connection";
    actions.appendChild(testBtn);
    if(configured){
      const clearBtn=h("button",{className:"btn btn-sec",style:{padding:"10px 16px",borderColor:"var(--danger)44",color:"var(--danger)"},onClick:()=>{S.llm.apiKey="";S.llm.testStatus=null;S.llm.testMsg="";saveLLM();render();}});
      clearBtn.textContent="🗑 Clear Key";
      actions.appendChild(clearBtn);
    }
    mBody.appendChild(actions);

    // Privacy note
    const privacy=h("div",{style:{marginTop:"20px",padding:"12px 16px",borderRadius:"8px",background:"var(--surfAlt)",border:"1px solid var(--border)"}});
    privacy.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textMid)",marginBottom:"4px"}},"🔒 Privacy"));
    privacy.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",lineHeight:"1.6"}},"Your API key is stored in your browser's localStorage only. It is never included in JSON exports, never sent to ReqRight servers (there are none), and never shared. When you use LLM features, your requirement text is sent directly from your browser to the API provider you selected."));
    mBody.appendChild(privacy);

    // Cost estimate
    const cost=h("div",{style:{marginTop:"12px",padding:"12px 16px",borderRadius:"8px",background:"var(--surfAlt)",border:"1px solid var(--border)"}});
    cost.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textMid)",marginBottom:"4px"}},"💰 Estimated Cost"));
    cost.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",lineHeight:"1.6"}},"Single rewrite ≈ $0.005 · Batch rewrite (30 reqs) ≈ $0.15 · Decomposition ≈ $0.02. Costs depend on your provider and model. Haiku/Mini models are 5–10× cheaper."));
    mBody.appendChild(cost);

    modal.appendChild(mBody);
    overlay.appendChild(modal);app.appendChild(overlay);
  }
  const header=h("header",{className:"header"});

  // ── Row 1: Logo + Actions ──
  const headerTop=h("div",{className:"header-top"});
  const logo=h("div",{style:{display:"flex",alignItems:"center",gap:"14px"}});
  logo.appendChild(h("div",{style:{width:"38px",height:"38px",borderRadius:"10px",background:"linear-gradient(135deg,var(--accent),var(--purple))",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"15px",fontWeight:800}},"RR"));
  const logoText=h("div",{});
  logoText.appendChild(h("div",{style:{fontSize:"16px",fontWeight:700,letterSpacing:"-0.02em"}},"ReqRight"));
  logoText.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"1px"}},"Systems Engineering Workbench · INCOSE GtWR v4 · 42 Rules"));
  logo.appendChild(logoText);headerTop.appendChild(logo);

  const reqCount=S.reqs.length;
  const glossCount=S.glossary.length;
  const decCount=S.decisions.length;
  const riskCount=S.risks.length;

  const hActions=h("div",{style:{display:"flex",gap:"6px",alignItems:"center"}});

  // Reference tabs (moved from nav to save space)
  const refTabs=[{k:"vv",l:"✓ V&V"},{k:"rules",l:"⚙ Rules"},{k:"glossary",l:"📖 Glossary",c:glossCount}];
  const refGroup=h("div",{style:{display:"flex",gap:"2px",background:"var(--surface)",borderRadius:"8px",padding:"2px",border:"1px solid var(--border)",marginRight:"4px"}});
  refTabs.forEach(t=>{
    const btn=h("button",{style:{padding:"5px 10px",borderRadius:"6px",border:"none",cursor:"pointer",fontSize:"12px",fontWeight:S.view===t.k?600:500,background:S.view===t.k?"var(--accent)":"transparent",color:S.view===t.k?"var(--bg)":"var(--textMid)",transition:"all .15s",whiteSpace:"nowrap"},onClick:()=>setState({view:t.k})});
    btn.appendChild(document.createTextNode(t.l));
    if(t.c&&t.c>0){btn.appendChild(h("span",{style:{marginLeft:"4px",fontSize:"10px",padding:"1px 5px",borderRadius:"6px",background:S.view===t.k?"rgba(0,0,0,0.3)":"var(--border)",color:S.view===t.k?"#fff":"var(--textDim)",fontWeight:600}},String(t.c)));}
    btn.addEventListener("mouseenter",()=>{if(S.view!==t.k)btn.style.background="var(--card)";});
    btn.addEventListener("mouseleave",()=>{if(S.view!==t.k)btn.style.background="transparent";});
    refGroup.appendChild(btn);
  });
  hActions.appendChild(refGroup);

  // Global search button
  const searchBtn=h("button",{className:"btn btn-sec",style:{borderColor:"var(--border)",display:"flex",alignItems:"center",gap:"6px",padding:"6px 12px"},onClick:()=>{S.showSearch=true;S.globalSearchQ="";render();setTimeout(()=>document.getElementById("global-search-input")?.focus(),50);}});
  searchBtn.appendChild(h("span",{style:{fontSize:"14px"}},"🔍"));
  searchBtn.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)",fontFamily:"var(--mono)"}},"⌘K"));
  hActions.appendChild(searchBtn);
  hActions.appendChild(h("button",{className:"btn btn-pri",onClick:addReq},"+ New"));
  hActions.appendChild(h("button",{className:"btn btn-sec",style:{borderColor:"#f59e0b44",color:"#f59e0b"},onClick:()=>{S.showTemplates=true;render();}},"📋 Templates"));

  // File dropdown (Save/Load/Export consolidated)
  const fileWrap=h("div",{style:{position:"relative"}});
  fileWrap.appendChild(h("button",{className:"btn btn-sec",style:{borderColor:"#10b98144",color:"var(--success)"},onClick:()=>{S.showExport=!S.showExport;render();}},"📁 File ▾"));
  if(S.showExport){
    const dd=h("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"4px",background:"var(--card)",border:"1px solid var(--border)",borderRadius:"10px",padding:"4px",minWidth:"200px",boxShadow:"0 12px 40px rgba(0,0,0,.5)",zIndex:200}});
    // Save
    const saveItem=h("button",{style:{display:"block",width:"100%",padding:"10px 16px",border:"none",background:"transparent",color:"var(--success)",fontSize:"13px",textAlign:"left",cursor:"pointer",borderRadius:"6px",fontFamily:"inherit",fontWeight:600},onClick:()=>{exportJSON();S.showExport=false;render();}},"💾 Save Project");
    saveItem.addEventListener("mouseenter",()=>saveItem.style.background="var(--surfAlt)");saveItem.addEventListener("mouseleave",()=>saveItem.style.background="transparent");
    dd.appendChild(saveItem);
    // Load
    const loadLabel=h("label",{style:{display:"block",padding:"10px 16px",color:"var(--accent)",fontSize:"13px",cursor:"pointer",borderRadius:"6px",fontWeight:600}});
    loadLabel.textContent="📂 Load Project";
    loadLabel.addEventListener("mouseenter",()=>loadLabel.style.background="var(--surfAlt)");loadLabel.addEventListener("mouseleave",()=>loadLabel.style.background="transparent");
    loadLabel.appendChild(h("input",{type:"file",accept:".json,.txt,.csv,.tsv,.md,.xlsx,.xls",style:{display:"none"},onChange:e=>{const f=e.target.files[0];if(f){const ext=f.name.split(".").pop().toLowerCase();importFile(f,ext==="json"?"json":(ext==="xlsx"||ext==="xls")?"xlsx":(ext==="csv"||ext==="tsv")?"csv":"text");}e.target.value="";S.showExport=false;}}));
    dd.appendChild(loadLabel);
    dd.appendChild(h("div",{style:{borderTop:"1px solid var(--border)",margin:"4px 0"}}));
    // Exports
    [{l:"📄 Export Full Report (PDF)",fn:()=>{S.showReportCfg=true;S.showExport=false;render();}},{l:"📊 Export CSV",fn:exportCSV},{l:"🔗 Export ReqIF (DOORS)",fn:exportReqIF},{l:"💾 Export JSON Archive",fn:exportJSON}].forEach(({l,fn})=>{
      const item=h("button",{style:{display:"block",width:"100%",padding:"10px 16px",border:"none",background:"transparent",color:"var(--text)",fontSize:"13px",textAlign:"left",cursor:"pointer",borderRadius:"6px",fontFamily:"inherit"},onClick:()=>{fn();S.showExport=false;render();}},l);
      item.addEventListener("mouseenter",()=>item.style.background="var(--surfAlt)");item.addEventListener("mouseleave",()=>item.style.background="transparent");
      dd.appendChild(item);
    });
    dd.appendChild(h("div",{style:{borderTop:"1px solid var(--border)",margin:"4px 0"}}));
    const impLabel=h("label",{style:{display:"block",padding:"10px 16px",color:"var(--text)",fontSize:"13px",cursor:"pointer",borderRadius:"6px"}});
    impLabel.textContent="↑ Import Excel/CSV/Document";
    impLabel.addEventListener("mouseenter",()=>impLabel.style.background="var(--surfAlt)");impLabel.addEventListener("mouseleave",()=>impLabel.style.background="transparent");
    impLabel.appendChild(h("input",{type:"file",accept:".txt,.csv,.tsv,.md,.xlsx,.xls",style:{display:"none"},onChange:e=>{const f=e.target.files[0];if(f){const ext=f.name.split(".").pop().toLowerCase();importFile(f,(ext==="xlsx"||ext==="xls")?"xlsx":(ext==="csv"||ext==="tsv")?"csv":"text");}S.showExport=false;}}));
    dd.appendChild(impLabel);fileWrap.appendChild(dd);
  }
  hActions.appendChild(fileWrap);
  hActions.appendChild(h("button",{className:"btn btn-sec",style:{borderColor:"#a78bfa44",color:"var(--purple)"},onClick:()=>{S.showBulkAI=true;render();}},"⚡ AI"));
  
  // LLM Settings button
  const llmConfigured=S.llm.apiKey&&S.llm.apiKey.length>10;
  const llmBtn=h("button",{className:"btn btn-sec",style:{borderColor:llmConfigured?"#10b98144":"var(--border)",color:llmConfigured?"var(--success)":"var(--textMid)",position:"relative"},onClick:()=>{S.showLLMSettings=true;render();}});
  llmBtn.appendChild(h("span",{},"🤖"));
  llmBtn.appendChild(h("span",{style:{fontSize:"11px",marginLeft:"4px"}},"LLM"));
  if(llmConfigured){llmBtn.appendChild(h("span",{style:{position:"absolute",top:"-2px",right:"-2px",width:"8px",height:"8px",borderRadius:"50%",background:"var(--success)",border:"2px solid var(--bg)"}},"")); }
  hActions.appendChild(llmBtn);
  
  // Theme toggle button
  const isDark=!document.documentElement.classList.contains("light");
  const themeBtn=h("button",{className:"btn btn-sec",style:{borderColor:"var(--border)",padding:"8px 12px",fontSize:"16px"},onClick:toggleTheme,title:isDark?"Switch to Light Mode":"Switch to Dark Mode"},isDark?"☀️":"🌙");
  hActions.appendChild(themeBtn);
  
  // Help button
  const helpBtn=h("a",{href:"https://github.com/ssaleem74/reqright#readme",target:"_blank",className:"btn btn-sec",style:{borderColor:"#38bdf844",color:"var(--accent)",textDecoration:"none",display:"inline-flex",alignItems:"center"}},"?");
  hActions.appendChild(helpBtn);
  
  headerTop.appendChild(hActions);
  header.appendChild(headerTop);

  // ── Row 2: Navigation Tabs ──
  const headerNav=h("div",{className:"header-nav"});
  const nav=h("div",{className:"nav"});
  const navTabs=[{k:"dashboard",l:"◉ Dashboard",c:null},{k:"editor",l:"✎ Author",c:reqCount},{k:"requirements",l:"☰ Register",c:reqCount},{k:"traceability",l:"⊞ Trace",c:null},{k:"sep"},{k:"risks",l:"⚠ Risks",c:riskCount},{k:"decisions",l:"📋 Decisions",c:decCount},{k:"stakeholders",l:"👥 Stakeholders",c:S.stakeholders.length||null},{k:"interfaces",l:"🔌 Interfaces",c:S.interfaces.length||null},{k:"usecases",l:"📐 Use Cases",c:S.useCases.length||null}];
  navTabs.forEach(t=>{
    if(t.k==="sep"){nav.appendChild(h("div",{className:"nav-sep"}));return;}
    const btn=h("button",{className:S.view===t.k?"active":"",onClick:()=>setState({view:t.k})});
    btn.appendChild(document.createTextNode(t.l));
    if(t.c!==null&&t.c>0){
      const badge=h("span",{style:{marginLeft:"6px",fontSize:"12px",padding:"1px 6px",borderRadius:"8px",background:S.view===t.k?"rgba(0,0,0,0.3)":"var(--border)",color:S.view===t.k?"#fff":"var(--textDim)",fontWeight:600}},String(t.c));
      btn.appendChild(badge);
    }
    nav.appendChild(btn);
  });
  headerNav.appendChild(nav);
  header.appendChild(headerNav);
  app.appendChild(header);

  const main=h("main",{style:{padding:"24px 28px",maxWidth:"1680px",margin:"0 auto"}});

  // ═══ DASHBOARD ═══
  if(S.view==="dashboard"){
    const stats={total:S.reqs.length,draft:S.reqs.filter(r=>r.status==="Draft").length,reviewed:S.reqs.filter(r=>r.status==="Reviewed").length,approved:S.reqs.filter(r=>r.status==="Approved").length,
      low:S.reqs.filter(r=>analyze(r.text).score<60).length,avg:S.reqs.length>0?Math.round(S.reqs.reduce((s,r)=>s+analyze(r.text).score,0)/S.reqs.length):0};

    const pnInput=h("input",{style:{background:"transparent",border:"none",color:"var(--text)",fontSize:"26px",fontWeight:700,letterSpacing:"-0.03em",width:"100%",outline:"none"},value:S.project,onInput:e=>{S.project=e.target.value;autoSave();}});
    main.appendChild(h("div",{style:{marginBottom:"28px"}},pnInput,h("p",{style:{color:"var(--textDim)",fontSize:"13px",marginTop:"2px"}},"INCOSE GtWR v4 · ISO/IEC/IEEE 29148 · ISO/IEC/IEEE 15288 · Your data stays on your machine")));

    const sg=h("div",{className:"grid-stats"});
    [{l:"Total",v:stats.total,c:"var(--accent)",i:"☰"},{l:"Draft",v:stats.draft,c:"var(--warn)",i:"✎"},{l:"Reviewed",v:stats.reviewed,c:"var(--purple)",i:"◎"},{l:"Approved",v:stats.approved,c:"var(--success)",i:"✓"},{l:"Low Quality",v:stats.low,c:"var(--danger)",i:"⚠"},{l:"Avg Score",v:stats.avg+"%",c:stats.avg>=80?"var(--success)":stats.avg>=60?"var(--warn)":"var(--danger)",i:"★"},{l:"Comments",v:S.reqs.reduce((s,r)=>s+(r.comments||[]).length,0),c:"var(--purple)",i:"💬"},{l:"Changes",v:S.reqs.reduce((s,r)=>s+(r.history||[]).length,0),c:"var(--accent)",i:"🕐"}].forEach(s=>{
      const card=h("div",{className:"card stat-card"});
      card.appendChild(h("div",{className:"icon",style:{color:s.c}},s.i));
      card.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".08em",fontWeight:600}},s.l));
      card.appendChild(h("div",{className:"mono stat-val",style:{color:s.c}},String(s.v)));
      sg.appendChild(card);
    });
    main.appendChild(sg);

    // Risk + Decision summaries side by side
    const _sumCols=[S.risks.length>0,S.decisions.length>0,S.stakeholders.length>0,S.interfaces.length>0,S.useCases.length>0].filter(Boolean).length;
    const _gridCols=_sumCols<=3?"repeat("+_sumCols+",1fr)":"repeat("+Math.min(_sumCols,3)+",1fr)";
    const summaryRow=h("div",{style:{display:"grid",gridTemplateColumns:_gridCols,gap:"16px",marginBottom:"16px"}});

    // Risk Summary Card
    if(S.risks.length>0){
      const riskCard=h("div",{className:"card"});
      const riskHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      riskHdr.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600}},"⚠ Risk Summary"));
      riskHdr.appendChild(h("button",{className:"btn btn-sec",style:{padding:"4px 12px",fontSize:"12px"},onClick:()=>setState({view:"risks"})},"View All →"));
      riskCard.appendChild(riskHdr);
      const riskGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"10px"}});
      const criticalRisks=S.risks.filter(r=>riskScore(r.likelihood,r.impact)>=15).length;
      const highRisks=S.risks.filter(r=>{const s=riskScore(r.likelihood,r.impact);return s>=10&&s<15;}).length;
      const mediumRisks=S.risks.filter(r=>{const s=riskScore(r.likelihood,r.impact);return s>=5&&s<10;}).length;
      const lowRisks=S.risks.filter(r=>riskScore(r.likelihood,r.impact)<5).length;
      [{l:"Critical",c:criticalRisks,clr:"var(--danger)"},{l:"High",c:highRisks,clr:"var(--orange)"},{l:"Medium",c:mediumRisks,clr:"var(--warn)"},{l:"Low",c:lowRisks,clr:"var(--success)"}].forEach(x=>{
        const box=h("div",{style:{background:x.clr+"15",borderRadius:"8px",padding:"10px",textAlign:"center"}});
        box.appendChild(h("div",{style:{fontSize:"20px",fontWeight:700,color:x.clr}},String(x.c)));
        box.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)"}},x.l));
        riskGrid.appendChild(box);
      });
      riskCard.appendChild(riskGrid);
      summaryRow.appendChild(riskCard);
    }

    // Decision Log Summary
    if(S.decisions.length>0){
      const decCard=h("div",{className:"card"});
      const decHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      decHdr.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600}},"📋 Decision Summary"));
      decHdr.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"4px 12px"},onClick:()=>setState({view:"decisions"})},"View All →"));
      decCard.appendChild(decHdr);
      const decStats=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(80px,1fr))",gap:"8px",marginBottom:"14px"}});
      const decByStatus={};DEC_STATUSES.forEach(s=>decByStatus[s]=S.decisions.filter(d=>d.status===s).length);
      const decStatusClr={Proposed:"var(--warn)",Approved:"var(--success)",Superseded:"var(--textDim)",Rejected:"var(--danger)",Deferred:"var(--purple)"};
      Object.entries(decByStatus).filter(([,c])=>c>0).forEach(([st,cnt])=>{
        const sc=h("div",{style:{background:"var(--surface)",borderRadius:"8px",padding:"10px",textAlign:"center",border:"1px solid var(--border)"}});
        sc.appendChild(h("div",{className:"mono",style:{fontSize:"20px",fontWeight:700,color:decStatusClr[st]||"var(--text)"}},String(cnt)));
        sc.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",textTransform:"uppercase",fontWeight:600,marginTop:"2px"}},st));
        decStats.appendChild(sc);
      });
      decCard.appendChild(decStats);
      const recent=S.decisions.slice().sort((a,b)=>b.modified.localeCompare(a.modified)).slice(0,3);
      recent.forEach(d=>{
        const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 12px",background:"var(--surface)",borderRadius:"8px",marginBottom:"4px",cursor:"pointer"},onClick:()=>{S.selDecId=d.id;setState({view:"decisions"});}});
        row.addEventListener("mouseenter",()=>row.style.background="var(--surfAlt)");row.addEventListener("mouseleave",()=>row.style.background="var(--surface)");
        const stClr=decStatusClr[d.status]||"var(--textDim)";
        row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--accent)",fontWeight:700,minWidth:"72px"}},d.id));
        row.appendChild(h("span",{style:{fontSize:"12px",color:"var(--text)",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},d.title||"Untitled"));
        row.appendChild(h("span",{className:"badge",style:{background:stClr+"22",color:stClr}},d.status));
        decCard.appendChild(row);
      });
      summaryRow.appendChild(decCard);
    }

    // Stakeholder Summary
    if(S.stakeholders.length>0){
      const stkCard=h("div",{className:"card"});
      const stkHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      stkHdr.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600}},"👥 Stakeholder Summary"));
      stkHdr.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"4px 12px"},onClick:()=>setState({view:"stakeholders"})},"View All →"));
      stkCard.appendChild(stkHdr);
      const stkInflClr={Critical:"var(--danger)",High:"var(--orange)",Medium:"var(--warn)",Low:"var(--success)"};
      const stkGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"8px",marginBottom:"10px"}});
      STK_INFLUENCE.forEach(level=>{
        const cnt=S.stakeholders.filter(s=>s.influence===level).length;
        const clr=stkInflClr[level];
        const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"8px",textAlign:"center"}});
        box.appendChild(h("div",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:clr}},String(cnt)));
        box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)"}},level));
        stkGrid.appendChild(box);
      });
      stkCard.appendChild(stkGrid);
      // Show top stakeholders
      S.stakeholders.slice(0,3).forEach(s=>{
        const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"6px 10px",background:"var(--surface)",borderRadius:"6px",marginBottom:"4px",cursor:"pointer",fontSize:"12px"},onClick:()=>{S.selStkId=s.id;setState({view:"stakeholders"});}});
        row.addEventListener("mouseenter",()=>row.style.background="var(--surfAlt)");row.addEventListener("mouseleave",()=>row.style.background="var(--surface)");
        row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,minWidth:"60px"}},s.id));
        row.appendChild(h("span",{style:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},s.name||"Unnamed"));
        const ic=stkInflClr[s.influence]||"var(--textDim)";
        row.appendChild(h("span",{className:"badge",style:{background:ic+"22",color:ic}},s.influence));
        stkCard.appendChild(row);
      });
      summaryRow.appendChild(stkCard);
    }

    // Interface Summary
    if(S.interfaces.length>0){
      const ifcCard=h("div",{className:"card"});
      const ifcHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      ifcHdr.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600}},"🔌 Interface Summary"));
      ifcHdr.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"4px 12px"},onClick:()=>setState({view:"interfaces"})},"View All →"));
      ifcCard.appendChild(ifcHdr);
      const ifcStatusClr2={Draft:"var(--textDim)",Defined:"var(--accent)",Agreed:"var(--success)",Verified:"var(--success)",Deprecated:"var(--danger)"};
      const ifcSGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat("+Math.min(IFC_STATUSES.length,5)+",1fr)",gap:"6px",marginBottom:"10px"}});
      IFC_STATUSES.forEach(st=>{
        const cnt=S.interfaces.filter(i=>i.status===st).length;
        const clr=ifcStatusClr2[st]||"var(--textDim)";
        const box=h("div",{style:{background:clr+"15",borderRadius:"6px",padding:"6px",textAlign:"center"}});
        box.appendChild(h("div",{className:"mono",style:{fontSize:"16px",fontWeight:700,color:clr}},String(cnt)));
        box.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)"}},st));
        ifcSGrid.appendChild(box);
      });
      ifcCard.appendChild(ifcSGrid);
      S.interfaces.slice(0,3).forEach(i=>{
        const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"6px 10px",background:"var(--surface)",borderRadius:"6px",marginBottom:"4px",cursor:"pointer",fontSize:"12px"},onClick:()=>{S.selIfcId=i.id;setState({view:"interfaces"});}});
        row.addEventListener("mouseenter",()=>row.style.background="var(--surfAlt)");row.addEventListener("mouseleave",()=>row.style.background="var(--surface)");
        row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,minWidth:"60px"}},i.id));
        row.appendChild(h("span",{style:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},i.name||"Unnamed"));
        row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"10px"}},i.type));
        ifcCard.appendChild(row);
      });
      summaryRow.appendChild(ifcCard);
    }

    // Use Case Summary
    if(S.useCases.length>0){
      const ucCard=h("div",{className:"card"});
      const ucHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      ucHdr.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600}},"📐 Use Case Summary"));
      ucHdr.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"4px 12px"},onClick:()=>setState({view:"usecases"})},"View All →"));
      ucCard.appendChild(ucHdr);
      const ucPriClrD={Critical:"var(--danger)",High:"var(--orange)",Medium:"var(--warn)",Low:"var(--success)"};
      const ucPriG=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"8px",marginBottom:"10px"}});
      UC_PRIORITIES.forEach(p=>{
        const cnt=S.useCases.filter(u=>u.priority===p).length;
        const clr=ucPriClrD[p];
        const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"8px",textAlign:"center"}});
        box.appendChild(h("div",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:clr}},String(cnt)));
        box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)"}},p));
        ucPriG.appendChild(box);
      });
      ucCard.appendChild(ucPriG);
      S.useCases.slice(0,3).forEach(u=>{
        const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"6px 10px",background:"var(--surface)",borderRadius:"6px",marginBottom:"4px",cursor:"pointer",fontSize:"12px"},onClick:()=>{S.selUcId=u.id;setState({view:"usecases"});}});
        row.addEventListener("mouseenter",()=>row.style.background="var(--surfAlt)");row.addEventListener("mouseleave",()=>row.style.background="var(--surface)");
        row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,minWidth:"55px"}},u.id));
        row.appendChild(h("span",{style:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},u.title||"Untitled"));
        row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"10px"}},u.type));
        ucCard.appendChild(row);
      });
      summaryRow.appendChild(ucCard);
    }
    if(S.risks.length>0||S.decisions.length>0||S.stakeholders.length>0||S.interfaces.length>0||S.useCases.length>0)main.appendChild(summaryRow);
    const pc=h("div",{className:"card"});
    pc.appendChild(h("h3",{style:{fontSize:"14px",fontWeight:600,marginBottom:"14px"}},"INCOSE Requirement Patterns — Click to create"));
    const pg=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(260px,1fr))",gap:"10px"}});
    PATTERNS.forEach(p=>{
      const pi=h("div",{style:{background:"var(--surface)",borderRadius:"10px",padding:"14px",border:"1px solid var(--border)",cursor:"pointer",transition:"all .2s"},onClick:()=>{const r=mkReq({text:p.t});S.reqs.push(r);S.selId=r.id;autoSave();setState({view:"editor"});}});
      pi.addEventListener("mouseenter",()=>pi.style.borderColor="var(--accent)");pi.addEventListener("mouseleave",()=>pi.style.borderColor="var(--border)");
      pi.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--accent)",marginBottom:"4px"}},p.nm));
      pi.appendChild(h("div",{className:"mono",style:{fontSize:"12px",color:"var(--textMid)",lineHeight:"1.6"}},p.t));
      pg.appendChild(pi);
    });
    pc.appendChild(pg);main.appendChild(pc);

    // Save reminder
    const saveReminder=h("div",{style:{marginTop:"20px",padding:"16px 20px",background:"var(--successDim)33",borderRadius:"12px",border:"1px solid #10b98133",display:"flex",justifyContent:"space-between",alignItems:"center"}});
    saveReminder.appendChild(h("div",{},
      h("div",{style:{fontSize:"14px",fontWeight:600,color:"var(--success)"}},"💾 Remember to save your work"),
      h("div",{style:{fontSize:"12px",color:"var(--textMid)",marginTop:"2px"}},"Click 'Save Project' to download a JSON file. Load it next time to continue. Auto-saved in browser for this session.")));
    saveReminder.appendChild(h("button",{className:"btn btn-pri",onClick:exportJSON},"💾 Save Project Now"));
    main.appendChild(saveReminder);
  }

  // ═══ EDITOR ═══
  if(S.view==="editor"){
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 360px",gap:"16px"}});

    // ─── LEFT SIDEBAR: Requirement list ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});

    // Sidebar header: search + add
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    const searchInput=h("input",{id:"author-search-input",className:"input",style:{flex:1,fontSize:"13px",padding:"7px 10px"},placeholder:"🔍 Search...",value:S.authorSearch||"",onInput:e=>{S.authorSearch=e.target.value;render();}});
    sbHead.appendChild(searchInput);
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addReq,title:"Add requirement"},"+"));
    sidebar.appendChild(sbHead);

    // Author sidebar filters
    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const aTypeSel=h("select",{id:"author-filter-type",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.authorFilterType=e.target.value;render();}});
    aTypeSel.appendChild(h("option",{value:"All"},"All Types"));
    REQ_TYPES.forEach(t=>aTypeSel.appendChild(h("option",{value:t},t)));
    aTypeSel.value=S.authorFilterType;
    sbFilters.appendChild(aTypeSel);
    const aLevSel=h("select",{id:"author-filter-level",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.authorFilterLevel=e.target.value;render();}});
    aLevSel.appendChild(h("option",{value:"All"},"All Levels"));
    REQ_LEVELS.forEach(l=>{const short=l.replace(" Requirement","").replace("Stakeholder ","STK ");aLevSel.appendChild(h("option",{value:l},short));});
    aLevSel.value=S.authorFilterLevel;
    sbFilters.appendChild(aLevSel);
    const aStatSel=h("select",{id:"author-filter-status",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.authorFilterStatus=e.target.value;render();}});
    aStatSel.appendChild(h("option",{value:"All"},"All Status"));
    STATUSES.forEach(s=>aStatSel.appendChild(h("option",{value:s},s)));
    aStatSel.value=S.authorFilterStatus;
    sbFilters.appendChild(aStatSel);
    sidebar.appendChild(sbFilters);

    // Filter requirements
    const filteredReqs=S.reqs.filter(r=>{
      if(S.authorFilterType!=="All"&&r.type!==S.authorFilterType)return false;
      if(S.authorFilterLevel!=="All"&&r.level!==S.authorFilterLevel)return false;
      if(S.authorFilterStatus!=="All"&&r.status!==S.authorFilterStatus)return false;
      if(S.authorSearch){
        const q=S.authorSearch.toLowerCase();
        if(!r.id.toLowerCase().includes(q)&&!r.text.toLowerCase().includes(q)&&!r.type.toLowerCase().includes(q))return false;
      }
      return true;
    });

    // Scrollable requirement list
    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredReqs.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.authorSearch?"No matches":"No requirements yet"));
    }
    filteredReqs.forEach(r=>{
      const a=analyze(r.text);const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
      const isSel=S.selId===r.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selId=r.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)",letterSpacing:".03em"}},r.id));
      const itemScore=h("div",{style:{display:"flex",alignItems:"center",gap:"5px"}});
      itemScore.appendChild(h("span",{className:"mono",style:{fontSize:"11px",color:sc,fontWeight:700}},a.score+"%"));
      itemScore.appendChild(h("span",{style:{width:"7px",height:"7px",borderRadius:"50%",background:sc,display:"inline-block"}}));
      if((r.comments||[]).length>0)itemScore.appendChild(h("span",{style:{fontSize:"9px",color:"var(--purple)",marginLeft:"2px"}},"💬"+r.comments.length));
      itemTop.appendChild(itemScore);item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",lineHeight:"1.4",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.text||"(empty)"));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);

    // Sidebar footer
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"11px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredReqs.length+" of "+S.reqs.length+" · ↑↓ Navigate";
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Editor ───
    const center=h("div",{});

    if(cur){
      // Breadcrumb trail
      const breadcrumb=h("div",{style:{display:"flex",alignItems:"center",gap:"6px",marginBottom:"12px",fontSize:"12px",flexWrap:"wrap"}});
      const trail=[];
      let walkId=cur.parent;
      while(walkId){
        const p=S.reqs.find(r=>r.id===walkId);
        if(p){trail.unshift(p);walkId=p.parent;}else break;
      }
      if(trail.length>0){
        trail.forEach((p,i)=>{
          const crumb=h("span",{style:{color:"var(--accent)",cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",fontWeight:500},onClick:()=>{S.selId=p.id;render();}},p.id);
          breadcrumb.appendChild(crumb);
          breadcrumb.appendChild(h("span",{style:{color:"var(--textDim)"}},"→"));
        });
      }
      breadcrumb.appendChild(h("span",{className:"mono",style:{color:"var(--text)",fontWeight:700}},cur.id));
      // Show children count
      const childCount=S.reqs.filter(r=>r.parent===cur.id).length;
      if(childCount>0){
        breadcrumb.appendChild(h("span",{style:{color:"var(--textDim)"}},"→"));
        breadcrumb.appendChild(h("span",{style:{color:"var(--teal)",fontSize:"11px"}},childCount+" child"+(childCount!==1?"ren":"")));
      }
      if(trail.length>0||childCount>0)center.appendChild(breadcrumb);

      // Editor card
      const edCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const edHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      const edLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      edLeft.appendChild(h("span",{className:"mono",style:{fontSize:"14px",color:"var(--accent)",fontWeight:600}},cur.id));
      const stColor=cur.status==="Approved"?"var(--success)":cur.status==="Reviewed"?"var(--purple)":"var(--warn)";
      edLeft.appendChild(h("span",{className:"badge",style:{background:stColor+"22",color:stColor}},cur.status));
      edLeft.appendChild(h("span",{className:"badge",style:{background:"var(--textMid)22",color:"var(--textMid)"}},cur.type));
      edHdr.appendChild(edLeft);
      const edBtns=h("div",{style:{display:"flex",gap:"6px"}});
      edBtns.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"5px 12px"},onClick:()=>copyToClipboard(cur.id+": "+cur.text)},"📋 Copy"));
      edBtns.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"5px 12px"},onClick:()=>dupReq(cur.id)},"⧉ Dup"));
      edBtns.appendChild(h("button",{className:"btn btn-danger",style:{fontSize:"12px",padding:"5px 12px"},onClick:()=>deleteReq(cur.id)},"✕"));
      edHdr.appendChild(edBtns);edCard.appendChild(edHdr);

      edCard.appendChild(h("label",{className:"label"},"Requirement Statement"));
      const ta=h("textarea",{className:"input",style:{height:"auto",lineHeight:"1.7",resize:"vertical",fontSize:"15px",fontFamily:"'DM Sans',system-ui"},rows:4,value:cur.text,placeholder:'e.g., "When in operational mode, the Navigation_System shall compute position within ±10 m accuracy."',onInput:e=>updateReqSilent(cur.id,{text:e.target.value})});
      edCard.appendChild(ta);

      const patRow=h("div",{style:{marginTop:"10px"}});
      patRow.appendChild(h("div",{className:"label",style:{marginBottom:"4px"}},"Apply Pattern"));
      const patBtns=h("div",{style:{display:"flex",gap:"4px",flexWrap:"wrap"}});
      PATTERNS.forEach(p=>patBtns.appendChild(h("button",{style:{padding:"4px 10px",borderRadius:"5px",border:"1px solid var(--border)",background:"var(--surface)",color:"var(--textMid)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit",transition:"all .15s"},onClick:()=>{updateReq(cur.id,{text:p.t});}},p.nm)));
      patRow.appendChild(patBtns);edCard.appendChild(patRow);
      center.appendChild(edCard);

      // ═══ AI IMPROVE PANEL (PROMINENT) ═══
      const aiPanel=h("div",{id:"ai-panel",className:"ai-panel",style:{display:cur.text.trim()&&curA&&curA.failed>0?"block":"none"}});
      aiPanel.appendChild(h("div",{className:"bg-icon"},"⚡"));
      const aiTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}});
      const aiInfo=h("div",{className:"ai-info"});
      aiInfo.appendChild(h("div",{style:{fontSize:"15px",fontWeight:700,color:"var(--purple)",marginBottom:"4px"}},"⚡ AI Requirement Improver"));
      aiInfo.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)"}},curA?(curA.failed+" INCOSE violation"+(curA.failed!==1?"s":"")+" detected — AI can fix: "+curA.results.filter(r=>!r.pass).map(r=>r.id).join(", ")):""));
      aiTop.appendChild(aiInfo);
      const aiBtns=h("div",{style:{display:"flex",gap:"8px",alignItems:"center"}});
      const aiBtn=h("button",{className:"btn btn-ai",disabled:S.aiLoading===cur.id,onClick:()=>doAI(cur.id)},S.aiLoading===cur.id?"⚡ Improving...":"⚡ Auto-Fix");
      aiBtns.appendChild(aiBtn);
      // LLM rewrite button (only if API key configured)
      if(S.llm.apiKey&&S.llm.apiKey.length>10){
        const llmBtn=h("button",{className:"btn",style:{padding:"8px 16px",background:"linear-gradient(135deg,#8b5cf6,#06b6d4)",color:"#fff",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:600,cursor:"pointer",fontFamily:"inherit",opacity:S.llmReview&&S.llmReview.loading?0.6:1},disabled:S.llmReview&&S.llmReview.loading,onClick:()=>doLLMAI(cur.id)},S.llmReview&&S.llmReview.loading&&S.llmReview.reqId===cur.id?"✨ Thinking...":"✨ LLM Rewrite");
        aiBtns.appendChild(llmBtn);
      }
      aiTop.appendChild(aiBtns);aiPanel.appendChild(aiTop);
      const aiTags=h("div",{className:"ai-tags",style:{display:"flex",flexWrap:"wrap",gap:"6px"}});
      if(curA){curA.results.filter(r=>!r.pass).forEach(r=>{
        aiTags.appendChild(h("div",{style:{fontSize:"12px",padding:"4px 10px",borderRadius:"6px",background:"var(--danger)15",border:"1px solid var(--danger)33",color:"var(--danger)",fontWeight:500}},r.id+": "+(r.msg.length>50?r.msg.slice(0,50)+"...":r.msg)));
      });}
      aiPanel.appendChild(aiTags);center.appendChild(aiPanel);
      
      const sp=h("div",{id:"success-panel",className:"success-panel",style:{display:cur.text.trim()&&curA&&curA.failed===0?"flex":"none"}});
      sp.appendChild(h("div",{style:{fontSize:"24px"}},"✓"));
      const spText=h("div",{className:"sp-text"});
      spText.appendChild(h("div",{style:{fontSize:"14px",fontWeight:600,color:"var(--success)"}},"All automated INCOSE checks passed"));
      spText.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)",marginTop:"2px"}},curA?`Score: ${curA.score}% (${curA.grade}) — ${curA.warnings} rules for manual review`:""));
      sp.appendChild(spText);center.appendChild(sp);

      // ═══ LLM REVIEW PANEL ═══
      if(S.llmReview&&S.llmReview.reqId===cur.id){
        const lrp=h("div",{style:{background:"var(--card)",border:"1px solid var(--purple)44",borderRadius:"12px",padding:"18px",marginBottom:"14px"}});
        
        if(S.llmReview.loading){
          lrp.appendChild(h("div",{style:{textAlign:"center",padding:"24px",color:"var(--purple)"}},
            "✨ LLM is analysing your requirement and generating an improved version..."));
          const dots=h("div",{style:{textAlign:"center",fontSize:"24px",color:"var(--purple)",animation:"pulse 1.5s infinite"}},"⏳");
          lrp.appendChild(dots);
        } else if(S.llmReview.error){
          const errHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}});
          errHead.appendChild(h("div",{style:{fontSize:"14px",fontWeight:600,color:"var(--danger)"}},"✕ LLM Rewrite Failed"));
          errHead.appendChild(h("button",{style:{background:"none",border:"none",color:"var(--textMid)",cursor:"pointer",fontSize:"14px",fontFamily:"inherit"},onClick:rejectLLM},"✕ Close"));
          lrp.appendChild(errHead);
          lrp.appendChild(h("div",{style:{fontSize:"12px",color:"var(--danger)",padding:"8px 12px",background:"var(--danger)11",borderRadius:"6px"}},S.llmReview.error));
        } else if(S.llmReview.suggested){
          // Header
          const lrHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
          lrHead.appendChild(h("div",{style:{fontSize:"14px",fontWeight:700,color:"var(--purple)"}},"✨ LLM Suggestion"));
          if(S.llmReview.confidence!=null){
            const conf=Math.round(S.llmReview.confidence*100);
            const confColor=conf>=80?"var(--success)":conf>=60?"var(--warn)":"var(--danger)";
            lrHead.appendChild(h("span",{style:{fontSize:"11px",padding:"3px 8px",borderRadius:"8px",background:confColor+"22",color:confColor,fontWeight:600}},conf+"% confidence"));
          }
          lrp.appendChild(lrHead);

          // Original
          const origBox=h("div",{style:{padding:"10px 14px",borderRadius:"8px",background:"var(--danger)08",border:"1px solid var(--danger)22",marginBottom:"10px"}});
          origBox.appendChild(h("div",{style:{fontSize:"10px",fontWeight:600,color:"var(--danger)",textTransform:"uppercase",letterSpacing:".05em",marginBottom:"4px"}},"Original"));
          origBox.appendChild(h("div",{style:{fontSize:"13px",color:"var(--textMid)",lineHeight:"1.6",textDecoration:"line-through",textDecorationColor:"var(--danger)44"}},S.llmReview.original));
          lrp.appendChild(origBox);

          // Suggested
          const sugBox=h("div",{style:{padding:"10px 14px",borderRadius:"8px",background:"var(--success)08",border:"1px solid var(--success)22",marginBottom:"10px"}});
          sugBox.appendChild(h("div",{style:{fontSize:"10px",fontWeight:600,color:"var(--success)",textTransform:"uppercase",letterSpacing:".05em",marginBottom:"4px"}},"Suggested"));
          sugBox.appendChild(h("div",{style:{fontSize:"13px",color:"var(--text)",lineHeight:"1.6",fontWeight:500}},S.llmReview.suggested));
          lrp.appendChild(sugBox);

          // Changes summary
          if(S.llmReview.changes){
            const chgBox=h("div",{style:{padding:"8px 12px",borderRadius:"6px",background:"var(--surfAlt)",marginBottom:"14px"}});
            chgBox.appendChild(h("div",{style:{fontSize:"10px",fontWeight:600,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".05em",marginBottom:"3px"}},"Changes Made"));
            chgBox.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)",lineHeight:"1.5"}},S.llmReview.changes));
            lrp.appendChild(chgBox);
          }

          // Score comparison
          const origScore=analyze(S.llmReview.original).score;
          const newScore=analyze(S.llmReview.suggested).score;
          const scoreDiff=newScore-origScore;
          const scoreRow=h("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"14px"}});
          scoreRow.appendChild(h("span",{style:{fontSize:"12px",color:"var(--textMid)"}},"Score:"));
          scoreRow.appendChild(h("span",{style:{fontSize:"13px",fontWeight:700,color:origScore>=80?"var(--success)":"var(--danger)"}},origScore+"%"));
          scoreRow.appendChild(h("span",{style:{fontSize:"12px",color:"var(--textMid)"}},"→"));
          scoreRow.appendChild(h("span",{style:{fontSize:"13px",fontWeight:700,color:newScore>=80?"var(--success)":"var(--danger)"}},newScore+"%"));
          if(scoreDiff!==0){
            scoreRow.appendChild(h("span",{style:{fontSize:"11px",padding:"2px 6px",borderRadius:"6px",background:scoreDiff>0?"var(--success)22":"var(--danger)22",color:scoreDiff>0?"var(--success)":"var(--danger)",fontWeight:600}},(scoreDiff>0?"+":"")+scoreDiff+"%"));
          }
          lrp.appendChild(scoreRow);

          // Accept / Reject buttons
          const lrBtns=h("div",{style:{display:"flex",gap:"10px"}});
          const acceptBtn=h("button",{style:{padding:"8px 20px",borderRadius:"8px",border:"none",background:"var(--success)",color:"#fff",fontSize:"13px",fontWeight:600,cursor:"pointer",fontFamily:"inherit"},onClick:acceptLLM},"✓ Accept Rewrite");
          const rejectBtn=h("button",{style:{padding:"8px 20px",borderRadius:"8px",border:"1px solid var(--border)",background:"transparent",color:"var(--textMid)",fontSize:"13px",cursor:"pointer",fontFamily:"inherit"},onClick:rejectLLM},"✕ Discard");
          lrBtns.appendChild(acceptBtn);lrBtns.appendChild(rejectBtn);
          lrp.appendChild(lrBtns);
        }
        center.appendChild(lrp);
      }

      // Attributes card
      const attrCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      attrCard.appendChild(h("h3",{style:{fontSize:"13px",fontWeight:600,marginBottom:"14px",color:"var(--accent)"}},"Attributes"));
      const attrGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"14px"}});
      [{l:"Type",k:"type",o:REQ_TYPES},{l:"Level",k:"level",o:REQ_LEVELS},{l:"Priority",k:"priority",o:PRIORITIES},{l:"Verification",k:"verification",o:V_METHODS},{l:"Status",k:"status",o:STATUSES},{l:"Risk",k:"risk",o:PRIORITIES}].forEach(a=>{
        const g=h("div",{});g.appendChild(h("label",{className:"label"},a.l));
        const sel=h("select",{className:"input",value:cur[a.k],onChange:e=>updateReq(cur.id,{[a.k]:e.target.value})});
        a.o.forEach(o=>{const opt=h("option",{value:o},o);if(cur[a.k]===o)opt.selected=true;sel.appendChild(opt);});
        g.appendChild(sel);attrGrid.appendChild(g);
      });
      attrCard.appendChild(attrGrid);

      const attrRow2=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"14px",marginTop:"14px"}});
      const pg=h("div",{});pg.appendChild(h("label",{className:"label"},"Parent"));
      const pSel=h("select",{className:"input",value:cur.parent||"",onChange:e=>updateReq(cur.id,{parent:e.target.value})});
      pSel.appendChild(h("option",{value:""},"None"));
      S.reqs.filter(r=>r.id!==cur.id).forEach(r=>{const o=h("option",{value:r.id},r.id+" — "+(r.text||"").slice(0,40));if(cur.parent===r.id)o.selected=true;pSel.appendChild(o);});
      pg.appendChild(pSel);attrRow2.appendChild(pg);
      const sg=h("div",{});sg.appendChild(h("label",{className:"label"},"Source"));
      sg.appendChild(h("input",{className:"input",value:cur.source||"",placeholder:"ConOps §3.2, Interview #4",onInput:e=>updateReqSilent(cur.id,{source:e.target.value})}));
      attrRow2.appendChild(sg);attrCard.appendChild(attrRow2);

      const ratDiv=h("div",{style:{marginTop:"14px"}});
      ratDiv.appendChild(h("label",{className:"label"},"Rationale (per R20 — purpose goes here, not in statement)"));
      ratDiv.appendChild(h("textarea",{className:"input",style:{height:"auto",resize:"vertical",lineHeight:"1.6"},rows:3,value:cur.rationale||"",placeholder:"Why is this requirement necessary?",onInput:e=>updateReqSilent(cur.id,{rationale:e.target.value})}));
      attrCard.appendChild(ratDiv);center.appendChild(attrCard);

      // ═══ COMMENTS & REVIEW ═══
      const cmtCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const cmtHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer",marginBottom:S.showComments?"14px":"0"},onClick:()=>{S.showComments=!S.showComments;render();}});
      const cmtLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"8px"}});
      cmtLeft.appendChild(h("span",{style:{fontSize:"13px",fontWeight:600,color:"var(--accent)"}},(S.showComments?"▾":"▸")+" 💬 Comments & Review"));
      const cmtCount=(cur.comments||[]).length;
      if(cmtCount>0)cmtLeft.appendChild(h("span",{className:"badge",style:{background:"var(--accent)22",color:"var(--accent)"}},String(cmtCount)));
      cmtHdr.appendChild(cmtLeft);
      // Reviewer name
      const rvName=h("div",{style:{display:"flex",alignItems:"center",gap:"6px"},onClick:e=>e.stopPropagation()});
      rvName.appendChild(h("span",{style:{fontSize:"11px",color:"var(--textDim)"}},"As:"));
      rvName.appendChild(h("input",{className:"input",style:{width:"120px",fontSize:"11px",padding:"3px 8px"},value:S.reviewer,onInput:e=>{S.reviewer=e.target.value;localStorage.setItem("reqright_reviewer",e.target.value);},placeholder:"Your name"}));
      cmtHdr.appendChild(rvName);
      cmtCard.appendChild(cmtHdr);

      if(S.showComments){
        const comments=cur.comments||[];
        // Comment list
        if(comments.length>0){
          const cmtList=h("div",{style:{marginBottom:"14px",maxHeight:"300px",overflowY:"auto"}});
          comments.forEach((c,ci)=>{
            const typeColors={"comment":"var(--textMid)","review":"var(--purple)","approval":"var(--success)","rejection":"var(--danger)"};
            const typeIcons={"comment":"💬","review":"📝","approval":"✅","rejection":"❌"};
            const typeLabels={"comment":"Comment","review":"Review Note","approval":"Approved","rejection":"Changes Requested"};
            const tc=typeColors[c.type]||"var(--textMid)";
            const cDiv=h("div",{style:{padding:"10px 12px",borderRadius:"8px",border:"1px solid "+tc+"33",background:tc+"08",marginBottom:"8px"}});
            const cHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}});
            const cInfo=h("div",{style:{display:"flex",alignItems:"center",gap:"6px"}});
            cInfo.appendChild(h("span",{style:{fontSize:"13px"}},(typeIcons[c.type]||"💬")));
            cInfo.appendChild(h("span",{style:{fontSize:"12px",fontWeight:600,color:tc}},c.author||"Unknown"));
            cInfo.appendChild(h("span",{className:"badge",style:{fontSize:"9px",background:tc+"22",color:tc}},typeLabels[c.type]||"Comment"));
            cHead.appendChild(cInfo);
            const cRight=h("div",{style:{display:"flex",alignItems:"center",gap:"8px"}});
            cRight.appendChild(h("span",{style:{fontSize:"10px",color:"var(--textDim)"}},new Date(c.timestamp).toLocaleString()));
            const delBtn=h("button",{style:{border:"none",background:"transparent",color:"var(--textDim)",cursor:"pointer",fontSize:"12px",padding:"2px 4px"},onClick:()=>{History.save();cur.comments.splice(ci,1);autoSave();render();}},"✕");
            delBtn.addEventListener("mouseenter",()=>delBtn.style.color="var(--danger)");
            delBtn.addEventListener("mouseleave",()=>delBtn.style.color="var(--textDim)");
            cRight.appendChild(delBtn);
            cHead.appendChild(cRight);
            cDiv.appendChild(cHead);
            cDiv.appendChild(h("div",{style:{fontSize:"13px",color:"var(--text)",lineHeight:"1.5"}},c.text));
            cmtList.appendChild(cDiv);
          });
          cmtCard.appendChild(cmtList);
        }else{
          cmtCard.appendChild(h("div",{style:{padding:"12px",textAlign:"center",color:"var(--textDim)",fontSize:"12px",marginBottom:"14px"}},"No comments yet. Add a comment or review below."));
        }

        // Add comment form
        const cmtForm=h("div",{style:{borderTop:"1px solid var(--border)",paddingTop:"12px"}});
        const cmtInput=h("textarea",{className:"input",style:{height:"auto",resize:"vertical",fontSize:"13px",marginBottom:"8px"},rows:2,value:S.commentText||"",placeholder:"Write a comment or review note...",onInput:e=>{S.commentText=e.target.value;}});
        cmtForm.appendChild(cmtInput);
        const cmtBtns=h("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap"}});
        [{type:"comment",label:"💬 Comment",color:"var(--textMid)"},{type:"review",label:"📝 Review Note",color:"var(--purple)"},{type:"approval",label:"✅ Approve",color:"var(--success)"},{type:"rejection",label:"❌ Request Changes",color:"var(--danger)"}].forEach(ct=>{
          cmtBtns.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"11px",padding:"5px 12px",borderColor:ct.color+"44",color:ct.color},onClick:()=>{
            const text=(S.commentText||"").trim();
            if(!text&&ct.type==="comment")return;
            if(!cur.comments)cur.comments=[];
            History.save();
            const commentText=text||(ct.type==="approval"?"Requirement approved.":"Changes requested.");
            cur.comments.push({id:Date.now(),text:commentText,author:S.reviewer,timestamp:new Date().toISOString(),type:ct.type});
            // Auto-update status for approval/rejection
            if(ct.type==="approval"&&cur.status!=="Approved"){
              if(!cur.history)cur.history=[];
              cur.history.push({timestamp:new Date().toISOString(),field:"Status",oldValue:cur.status,newValue:"Approved",author:S.reviewer});
              cur.status="Approved";
            }else if(ct.type==="rejection"&&cur.status!=="Under Review"){
              if(!cur.history)cur.history=[];
              cur.history.push({timestamp:new Date().toISOString(),field:"Status",oldValue:cur.status,newValue:"Under Review",author:S.reviewer});
              cur.status="Under Review";
            }
            cur.modified=new Date().toISOString();
            S.commentText="";autoSave();render();
          }},ct.label));
        });
        cmtForm.appendChild(cmtBtns);
        cmtCard.appendChild(cmtForm);
      }
      center.appendChild(cmtCard);

      // ═══ VERSION HISTORY ═══
      const histCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const histHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer",marginBottom:S.showHistory?"14px":"0"},onClick:()=>{S.showHistory=!S.showHistory;render();}});
      const histLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"8px"}});
      const histEntries=(cur.history||[]);
      histLeft.appendChild(h("span",{style:{fontSize:"13px",fontWeight:600,color:"var(--purple)"}},(S.showHistory?"▾":"▸")+" 🕐 Version History"));
      if(histEntries.length>0)histLeft.appendChild(h("span",{className:"badge",style:{background:"var(--purple)22",color:"var(--purple)"}},String(histEntries.length)));
      histHdr.appendChild(histLeft);
      histHdr.appendChild(h("span",{style:{fontSize:"10px",color:"var(--textDim)"}},"Created: "+new Date(cur.created).toLocaleDateString()));
      histCard.appendChild(histHdr);

      if(S.showHistory){
        if(histEntries.length>0){
          const timeline=h("div",{style:{maxHeight:"350px",overflowY:"auto"}});
          // Show newest first
          [...histEntries].reverse().forEach((entry,ei)=>{
            const isAI=entry.author==="AI Engine";
            const eDiv=h("div",{style:{display:"flex",gap:"10px",marginBottom:"10px",paddingBottom:"10px",borderBottom:ei<histEntries.length-1?"1px solid var(--border)":"none"}});
            // Timeline dot
            eDiv.appendChild(h("div",{style:{width:"8px",height:"8px",borderRadius:"50%",background:isAI?"var(--purple)":"var(--accent)",marginTop:"5px",flexShrink:0}}));
            const eContent=h("div",{style:{flex:1,minWidth:0}});
            const eHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"4px"}});
            const eInfo=h("div",{style:{display:"flex",alignItems:"center",gap:"6px"}});
            eInfo.appendChild(h("span",{style:{fontSize:"12px",fontWeight:600,color:isAI?"var(--purple)":"var(--text)"}},entry.field));
            eInfo.appendChild(h("span",{style:{fontSize:"10px",color:"var(--textDim)"}},"by "+entry.author));
            eHead.appendChild(eInfo);
            eHead.appendChild(h("span",{style:{fontSize:"10px",color:"var(--textDim)"}},new Date(entry.timestamp).toLocaleString()));
            eContent.appendChild(eHead);
            const eDiff=h("div",{style:{fontSize:"11px",lineHeight:"1.5"}});
            if(entry.oldValue){
              eDiff.appendChild(h("span",{style:{color:"var(--danger)",textDecoration:"line-through",background:"var(--danger)0a",padding:"1px 4px",borderRadius:"3px",marginRight:"4px"}},entry.oldValue));
            }
            eDiff.appendChild(h("span",{style:{color:"var(--success)",background:"var(--success)0a",padding:"1px 4px",borderRadius:"3px"}},entry.newValue||"(empty)"));
            eContent.appendChild(eDiff);
            eDiv.appendChild(eContent);
            timeline.appendChild(eDiv);
          });
          histCard.appendChild(timeline);
        }else{
          histCard.appendChild(h("div",{style:{padding:"12px",textAlign:"center",color:"var(--textDim)",fontSize:"12px"}},"No changes recorded yet. Edit fields to start tracking history."));
        }
      }
      center.appendChild(histCard);
    }else{
      // Improved empty state
      const empty=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      empty.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"16px"}},"✎"));
      empty.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"16px",fontWeight:600,marginBottom:"8px"}},"Select a Requirement"));
      empty.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"20px",maxWidth:"360px",margin:"0 auto 20px"}},"Choose a requirement from the sidebar to edit, or create a new one to get started. Each requirement is scored against 42 INCOSE® quality rules."));
      empty.appendChild(h("button",{className:"btn btn-pri",style:{padding:"10px 24px",fontSize:"14px"},onClick:addReq},"+ New Requirement"));
      center.appendChild(empty);
    }
    grid.appendChild(center);

    // ─── RIGHT: Quality panel ───
    const right=h("div",{});
    if(cur&&curA){
      const qp=h("div",{style:{position:"sticky",top:"80px",maxHeight:"calc(100vh - 100px)",display:"flex",flexDirection:"column"}});
      const scoreCard=h("div",{className:"card",style:{textAlign:"center",marginBottom:"14px",flexShrink:0}});
      scoreCard.appendChild(h("div",{className:"label",style:{marginBottom:"8px"}},"INCOSE Quality Score"));
      const sc=curA.score>=80?"var(--success)":curA.score>=60?"var(--warn)":"var(--danger)";
      scoreCard.appendChild(h("div",{id:"quality-score",className:"mono",style:{fontSize:"56px",fontWeight:700,color:sc,lineHeight:1}},String(curA.score)));
      scoreCard.appendChild(h("div",{id:"quality-grade",style:{fontSize:"18px",fontWeight:700,color:"var(--textMid)",marginTop:"4px"}},"Grade: "+curA.grade));
      const scSummary=h("div",{id:"quality-summary",style:{display:"flex",justifyContent:"center",gap:"16px",marginTop:"12px",fontSize:"12px"}});
      scSummary.appendChild(h("span",{style:{color:"var(--success)"}},"✓ "+curA.passed));
      scSummary.appendChild(h("span",{style:{color:"var(--danger)"}},"✕ "+curA.failed));
      scSummary.appendChild(h("span",{style:{color:"var(--warn)"}},"⚠ "+curA.warnings));
      scoreCard.appendChild(scSummary);qp.appendChild(scoreCard);

      const ruleCard=h("div",{id:"rules-panel",className:"card",style:{flex:1,overflowY:"auto",padding:"16px",minHeight:0}});
      ruleCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"12px"}},"Rule Analysis"));
      if(curA.results.filter(r=>!r.pass).length===0&&cur.text.trim()){
        const ok=h("div",{style:{padding:"12px",background:"var(--success)11",borderRadius:"8px",border:"1px solid var(--success)33",color:"var(--success)",fontSize:"12px",marginBottom:"10px"}});
        ok.textContent="✓ All automated checks passed.";ruleCard.appendChild(ok);
      }
      curA.results.filter(r=>!r.pass).forEach(r=>{
        const ri=h("div",{style:{padding:"10px",background:"var(--danger)0a",borderRadius:"8px",border:"1px solid var(--danger)22",marginBottom:"8px"}});
        const rh=h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"3px"}});
        rh.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--danger)",fontWeight:600}},r.id));
        rh.appendChild(h("span",{className:"badge",style:{background:"var(--danger)22",color:"var(--danger)"}},"FAIL"));
        const rWeight=S.ruleWeights[r.id]??1;
        if(rWeight!==1)rh.appendChild(h("span",{className:"badge",style:{fontSize:"9px",background:WEIGHT_COLORS[rWeight]+"22",color:WEIGHT_COLORS[rWeight]}},rWeight+"×"));
        ri.appendChild(rh);ri.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--text)"}},r.nm));
        ri.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)",lineHeight:"1.5",marginTop:"2px"}},r.msg));
        ruleCard.appendChild(ri);
      });
      curA.results.filter(r=>r.pass&&r.warn).forEach(r=>{
        const ri=h("div",{style:{padding:"8px",background:"var(--warn)08",borderRadius:"8px",border:"1px solid var(--warn)22",marginBottom:"8px"}});
        const rh=h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"2px"}});
        rh.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--warn)",fontWeight:600}},r.id+" — "+r.nm));
        rh.appendChild(h("span",{className:"badge",style:{background:"var(--warn)22",color:"var(--warn)"}},"REVIEW"));
        ri.appendChild(rh);ri.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)",lineHeight:"1.4"}},r.msg));
        ruleCard.appendChild(ri);
      });
      curA.results.filter(r=>r.pass&&!r.warn).forEach(r=>{
        ruleCard.appendChild(h("div",{style:{padding:"6px",marginBottom:"4px",display:"flex",alignItems:"center",gap:"6px"}},
          h("span",{className:"mono",style:{fontSize:"12px",color:"var(--success)"}},"✓ "+r.id),
          h("span",{style:{fontSize:"12px",color:"var(--textDim)"}},"— "+r.nm)));
      });
      qp.appendChild(ruleCard);right.appendChild(qp);
    }
    grid.appendChild(right);main.appendChild(grid);
  }

  // ═══ REGISTER ═══
  if(S.view==="requirements"){
    const filtered=S.reqs.filter(r=>{
      if(S.filterType!=="All"&&r.type!==S.filterType)return false;
      if(S.filterLevel!=="All"&&r.level!==S.filterLevel)return false;
      if(S.search&&!r.text.toLowerCase().includes(S.search.toLowerCase())&&!r.id.toLowerCase().includes(S.search.toLowerCase()))return false;
      return true;
    }).sort((a,b)=>{
      if(S.sort==="id")return a.id.localeCompare(b.id);
      if(S.sort==="score")return analyze(b.text).score-analyze(a.text).score;
      if(S.sort==="type")return a.type.localeCompare(b.type);
      if(S.sort==="status")return a.status.localeCompare(b.status);
      return 0;
    });

    const hdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}});
    hdr.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700}},"Requirements Register ("+filtered.length+" of "+S.reqs.length+")"));
    const filters=h("div",{style:{display:"flex",gap:"6px"}});
    filters.appendChild(h("input",{id:"search-input",className:"input",style:{width:"180px"},value:S.search,placeholder:"🔍 Search...",onInput:e=>{S.search=e.target.value;render();}}));
    const fType=h("select",{className:"input",style:{width:"120px"},value:S.filterType,onChange:e=>{S.filterType=e.target.value;render();}});
    fType.appendChild(h("option",{value:"All"},"All Types"));REQ_TYPES.forEach(t=>fType.appendChild(h("option",{value:t},t)));filters.appendChild(fType);
    const fLev=h("select",{className:"input",style:{width:"150px"},value:S.filterLevel,onChange:e=>{S.filterLevel=e.target.value;render();}});
    fLev.appendChild(h("option",{value:"All"},"All Levels"));REQ_LEVELS.forEach(l=>fLev.appendChild(h("option",{value:l},l)));filters.appendChild(fLev);
    const fSort=h("select",{className:"input",style:{width:"120px"},value:S.sort,onChange:e=>{S.sort=e.target.value;render();}});
    [{v:"id",l:"By ID"},{v:"score",l:"By Score"},{v:"type",l:"By Type"},{v:"status",l:"By Status"}].forEach(s=>{const o=h("option",{value:s.v},s.l);if(S.sort===s.v)o.selected=true;fSort.appendChild(o);});
    filters.appendChild(fSort);hdr.appendChild(filters);main.appendChild(hdr);

    if(filtered.length===0){
      const emptyR=h("div",{className:"card",style:{textAlign:"center",padding:"48px 32px"}});
      emptyR.appendChild(h("div",{style:{fontSize:"40px",opacity:".1",marginBottom:"12px"}},"☰"));
      if(S.reqs.length===0){
        emptyR.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"No Requirements Yet"));
        emptyR.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Create your first requirement or load an existing project to see it here."));
        emptyR.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:addReq},"+ New Requirement"));
      }else{
        emptyR.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"14px"}},"No requirements match your current filters. Try adjusting the search or filter criteria."));
      }
      main.appendChild(emptyR);
    }else{
      const tbl=h("div",{});
      // Header
      const thdr=h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 80px 70px 55px 70px 110px",gap:"6px",padding:"10px 14px",background:"var(--surface)",borderRadius:"10px 10px 0 0",border:"1px solid var(--border)",borderBottom:"none",fontSize:"12px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em"}});
      ["ID","Statement","Type","Level","Score","Status","Actions"].forEach(t=>thdr.appendChild(h("div",{},t)));
      tbl.appendChild(thdr);

      filtered.forEach((r,idx)=>{
        const a=analyze(r.text);const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
        const row=h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 80px 70px 55px 70px 110px",gap:"6px",padding:"12px 14px",background:idx%2===0?"var(--card)":"var(--surface)",border:"1px solid var(--border)",borderTop:"none",borderRadius:idx===filtered.length-1?"0 0 10px 10px":"0",fontSize:"12px",alignItems:"center",cursor:"pointer",transition:"background .15s"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}});
        row.addEventListener("mouseenter",()=>row.style.background="var(--cardHov)");
        row.addEventListener("mouseleave",()=>row.style.background=idx%2===0?"var(--card)":"var(--surface)");
        row.appendChild(h("div",{className:"mono",style:{fontSize:"12px",color:"var(--accent)",fontWeight:600}},r.id));
        row.appendChild(h("div",{style:{color:r.text?"var(--text)":"var(--textDim)",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:"2",WebkitBoxOrient:"vertical",lineHeight:"1.5",fontSize:"13px"}},r.text||"(empty)"));
        row.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)"}},r.type));
        row.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)"}},r.level.replace(" Requirement","").replace("Stakeholder ","Stkh ")));
        row.appendChild(h("div",{className:"mono",style:{fontSize:"12px",color:sc,fontWeight:700}},a.score+"%"));
        const stC=r.status==="Approved"?"var(--success)":r.status==="Reviewed"?"var(--purple)":"var(--warn)";
        row.appendChild(h("div",{},h("span",{className:"badge",style:{background:stC+"22",color:stC}},r.status)));
        const acts=h("div",{style:{display:"flex",gap:"3px"},onClick:e=>e.stopPropagation()});
        acts.appendChild(h("button",{style:{padding:"3px 6px",borderRadius:"4px",border:"1px solid var(--accent)44",background:"transparent",color:"var(--accent)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit"},title:"Copy to clipboard",onClick:()=>copyToClipboard(r.id+": "+r.text)},"📋"));
        acts.appendChild(h("button",{style:{padding:"3px 6px",borderRadius:"4px",border:"1px solid var(--purple)44",background:"transparent",color:"var(--purple)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit"},title:"AI Improve",onClick:()=>doAI(r.id)},"⚡"));
        acts.appendChild(h("button",{style:{padding:"3px 6px",borderRadius:"4px",border:"1px solid var(--border)",background:"transparent",color:"var(--textDim)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit"},title:"Duplicate",onClick:()=>dupReq(r.id)},"⧉"));
        acts.appendChild(h("button",{style:{padding:"3px 6px",borderRadius:"4px",border:"1px solid #ef444444",background:"transparent",color:"var(--danger)",fontSize:"12px",cursor:"pointer",fontFamily:"inherit"},title:"Delete",onClick:()=>deleteReq(r.id)},"✕"));
        row.appendChild(acts);tbl.appendChild(row);
      });
      main.appendChild(tbl);
    }
  }

  // ═══ TRACEABILITY ═══
  if(S.view==="traceability"){
    // Header with sub-tabs
    const tHeader=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}});
    tHeader.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700}},"Traceability"));
    const subTabs=h("div",{style:{display:"flex",gap:"4px",background:"var(--surface)",borderRadius:"8px",padding:"3px"}});
    [{k:"hierarchy",l:"⊞ Hierarchy"},{k:"matrix",l:"◫ Cross-Module Matrix"}].forEach(t=>{
      const isActive=S.traceTab===t.k;
      subTabs.appendChild(h("button",{className:"btn",style:{padding:"6px 14px",fontSize:"12px",fontWeight:600,background:isActive?"var(--accent)":"transparent",color:isActive?"#fff":"var(--textMid)",borderRadius:"6px",border:"none",cursor:"pointer"},onClick:()=>{S.traceTab=t.k;render();}},t.l));
    });
    tHeader.appendChild(subTabs);
    main.appendChild(tHeader);

    if(S.reqs.length===0&&S.traceTab==="hierarchy"){
      const emptyT=h("div",{className:"card",style:{textAlign:"center",padding:"48px 32px"}});
      emptyT.appendChild(h("div",{style:{fontSize:"40px",opacity:".1",marginBottom:"12px"}},"⊞"));
      emptyT.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"No Traceability Data"));
      emptyT.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Add requirements and set parent-child links in the Author view to build your traceability hierarchy."));
      emptyT.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:()=>setState({view:"editor"})},"Go to Author →"));
      main.appendChild(emptyT);
    }

    // ─── HIERARCHY SUB-TAB ───
    if(S.traceTab==="hierarchy"&&S.reqs.length>0){
      function renderTreeNode(req,depth){
        const a=analyze(req.text);const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
        const children=S.reqs.filter(c=>c.parent===req.id);
        const node=h("div",{style:{marginLeft:depth>0?(depth*24)+"px":"0"}});
        const row=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 14px",background:depth%2===0?"var(--card)":"var(--surface)",borderRadius:"8px",marginBottom:"4px",cursor:"pointer",border:"1px solid var(--border)",transition:"border-color .15s"},onClick:()=>{S.selId=req.id;setState({view:"editor"});}});
        row.addEventListener("mouseenter",()=>row.style.borderColor="var(--accent)");
        row.addEventListener("mouseleave",()=>row.style.borderColor="var(--border)");
        if(depth>0){
          row.insertBefore(h("span",{style:{color:"var(--textDim)",fontSize:"12px",marginRight:"-4px"}},"└"),row.firstChild);
        }
        if(children.length>0){
          row.appendChild(h("span",{style:{color:"var(--teal)",fontSize:"12px",fontWeight:600}},"▼"));
        }else{
          row.appendChild(h("span",{style:{width:"14px",display:"inline-block"}}));
        }
        row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:"var(--accent)",minWidth:"72px"}},req.id));
        const levelShort=req.level.replace(" Requirement","").replace("Stakeholder ","STK ");
        row.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",flexShrink:0}},levelShort));
        row.appendChild(h("span",{style:{flex:1,fontSize:"13px",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:"1.4"}},req.text||"(empty)"));
        row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:sc,fontWeight:700,flexShrink:0}},a.score+"%"));
        row.appendChild(h("span",{style:{width:"8px",height:"8px",borderRadius:"50%",background:sc,flexShrink:0}}));
        node.appendChild(row);
        children.sort((a,b)=>a.id.localeCompare(b.id)).forEach(child=>{
          node.appendChild(renderTreeNode(child,depth+1));
        });
        return node;
      }

      const tStats=h("div",{style:{display:"flex",gap:"16px",marginBottom:"20px",flexWrap:"wrap"}});
      REQ_LEVELS.forEach(level=>{
        const cnt=S.reqs.filter(r=>r.level===level).length;
        if(cnt===0)return;
        const levelShort=level.replace(" Requirement","").replace("Stakeholder ","STK ");
        tStats.appendChild(h("div",{style:{background:"var(--card)",border:"1px solid var(--border)",borderRadius:"8px",padding:"8px 16px",display:"flex",alignItems:"center",gap:"8px"}},
          h("span",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:"var(--accent)"}},String(cnt)),
          h("span",{style:{fontSize:"12px",color:"var(--textMid)"}},levelShort)));
      });
      const orphCount=S.reqs.filter(r=>!r.parent&&r.level!=="Stakeholder Need").length;
      if(orphCount>0){
        tStats.appendChild(h("div",{style:{background:"var(--danger)11",border:"1px solid var(--danger)33",borderRadius:"8px",padding:"8px 16px",display:"flex",alignItems:"center",gap:"8px"}},
          h("span",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:"var(--danger)"}},String(orphCount)),
          h("span",{style:{fontSize:"12px",color:"var(--danger)"}},("Orphan"+(orphCount!==1?"s":"")))));
      }
      main.appendChild(tStats);

      const treeCard=h("div",{className:"card",style:{padding:"16px"}});
      treeCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"12px",display:"flex",alignItems:"center",gap:"8px"}},
        h("span",{},"Requirement Hierarchy"),
        h("span",{style:{fontSize:"11px",color:"var(--textDim)",fontWeight:400}},"Click any item to edit in Author view")));
      const roots=S.reqs.filter(r=>!r.parent||!S.reqs.find(p=>p.id===r.parent));
      const rootsByLevel={};roots.forEach(r=>{
        if(!rootsByLevel[r.level])rootsByLevel[r.level]=[];
        rootsByLevel[r.level].push(r);
      });
      REQ_LEVELS.forEach(level=>{
        if(!rootsByLevel[level]||!rootsByLevel[level].length)return;
        const levelShort=level.replace(" Requirement","").replace("Stakeholder ","STK ");
        treeCard.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",fontWeight:600,textTransform:"uppercase",letterSpacing:".06em",padding:"8px 0 4px",borderBottom:"1px solid var(--border)",marginBottom:"8px",marginTop:"8px"}},levelShort+" ("+rootsByLevel[level].length+")"));
        rootsByLevel[level].sort((a,b)=>a.id.localeCompare(b.id)).forEach(root=>{
          treeCard.appendChild(renderTreeNode(root,0));
        });
      });
      main.appendChild(treeCard);

      const orphans=S.reqs.filter(r=>!r.parent&&r.level!=="Stakeholder Need"&&S.reqs.filter(c=>c.parent===r.id).length===0);
      if(orphans.length){
        const oc=h("div",{className:"card",style:{background:"var(--danger)08",borderColor:"var(--danger)22",marginTop:"14px"}});
        oc.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,color:"var(--danger)",marginBottom:"6px"}},"⚠ Orphan Requirements — no parent and no children ("+orphans.length+")"));
        const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px"}});
        orphans.forEach(r=>tags.appendChild(h("span",{className:"badge",style:{background:"var(--danger)22",color:"var(--danger)",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}},r.id)));
        oc.appendChild(tags);main.appendChild(oc);
      }
    }

    // ─── CROSS-MODULE MATRIX SUB-TAB ───
    if(S.traceTab==="matrix"){
      // Build reverse lookup maps
      const risksByReq={};S.risks.forEach(rk=>{/* risks don't directly link to reqs yet, check if req mentions risk */});
      const decsByReq={};S.decisions.forEach(dc=>(dc.affectedReqs||[]).forEach(rid=>{if(!decsByReq[rid])decsByReq[rid]=[];decsByReq[rid].push(dc.id);}));
      const stksByReq={};S.stakeholders.forEach(st=>(st.linkedNeeds||[]).forEach(rid=>{if(!stksByReq[rid])stksByReq[rid]=[];stksByReq[rid].push(st.id);}));
      const ifcsByReq={};S.interfaces.forEach(ifc=>(ifc.linkedReqs||[]).forEach(rid=>{if(!ifcsByReq[rid])ifcsByReq[rid]=[];ifcsByReq[rid].push(ifc.id);}));
      const ucsByReq={};S.useCases.forEach(uc=>(uc.derivedReqs||[]).forEach(rid=>{if(!ucsByReq[rid])ucsByReq[rid]=[];ucsByReq[rid].push(uc.id);}));

      // Coverage summary
      const modules=[
        {key:"decisions",label:"📋 Decisions",map:decsByReq,count:S.decisions.length,view:"decisions",selKey:"selDecId"},
        {key:"stakeholders",label:"👥 Stakeholders",map:stksByReq,count:S.stakeholders.length,view:"stakeholders",selKey:"selStkId"},
        {key:"interfaces",label:"🔌 Interfaces",map:ifcsByReq,count:S.interfaces.length,view:"interfaces",selKey:"selIfcId"},
        {key:"usecases",label:"📐 Use Cases",map:ucsByReq,count:S.useCases.length,view:"usecases",selKey:"selUcId"}
      ];

      // Coverage stats cards
      const covStats=h("div",{style:{display:"grid",gridTemplateColumns:"repeat("+modules.length+",1fr)",gap:"12px",marginBottom:"20px"}});
      modules.forEach(mod=>{
        const linked=S.reqs.filter(r=>mod.map[r.id]&&mod.map[r.id].length>0).length;
        const pct=S.reqs.length>0?Math.round(linked/S.reqs.length*100):0;
        const clr=pct>=80?"var(--success)":pct>=50?"var(--warn)":"var(--danger)";
        const cCard=h("div",{className:"card",style:{textAlign:"center",padding:"14px"}});
        cCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",marginBottom:"6px"}},mod.label));
        cCard.appendChild(h("div",{className:"mono",style:{fontSize:"28px",fontWeight:700,color:clr}},pct+"%"));
        cCard.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"4px"}},linked+"/"+S.reqs.length+" reqs linked"));
        // Mini bar
        const bar=h("div",{style:{height:"4px",background:"var(--surface)",borderRadius:"2px",marginTop:"8px",overflow:"hidden"}});
        bar.appendChild(h("div",{style:{height:"100%",width:pct+"%",background:clr,borderRadius:"2px"}}));
        cCard.appendChild(bar);
        covStats.appendChild(cCard);
      });
      main.appendChild(covStats);

      if(S.reqs.length===0){
        const emptyM=h("div",{className:"card",style:{textAlign:"center",padding:"48px 32px"}});
        emptyM.appendChild(h("div",{style:{fontSize:"40px",opacity:".1",marginBottom:"12px"}},"◫"));
        emptyM.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"No Requirements to Trace"));
        emptyM.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",marginBottom:"16px"}},"Add requirements first, then link them to other modules to build the cross-module traceability matrix."));
        emptyM.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:()=>setState({view:"editor"})},"Go to Author →"));
        main.appendChild(emptyM);
      }else{
        // Matrix table
        const tableWrap=h("div",{className:"card",style:{overflow:"auto",padding:"0"}});
        const table=h("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:"12px"}});

        // Header
        const thead=h("thead",{});
        const hRow=h("tr",{});
        [{l:"Requirement",w:"200px"},{l:"Level",w:"90px"},{l:"Status",w:"70px"}].forEach(c=>{
          hRow.appendChild(h("th",{style:{padding:"10px 12px",textAlign:"left",background:"var(--surface)",borderBottom:"2px solid var(--border)",fontWeight:700,fontSize:"11px",textTransform:"uppercase",letterSpacing:".04em",color:"var(--textDim)",position:"sticky",top:0,minWidth:c.w}},c.l));
        });
        modules.forEach(mod=>{
          hRow.appendChild(h("th",{style:{padding:"10px 12px",textAlign:"center",background:"var(--surface)",borderBottom:"2px solid var(--border)",fontWeight:700,fontSize:"11px",textTransform:"uppercase",letterSpacing:".04em",color:"var(--textDim)",position:"sticky",top:0,minWidth:"100px"}},mod.label));
        });
        hRow.appendChild(h("th",{style:{padding:"10px 12px",textAlign:"center",background:"var(--surface)",borderBottom:"2px solid var(--border)",fontWeight:700,fontSize:"11px",color:"var(--textDim)",position:"sticky",top:0,minWidth:"60px"}},"Coverage"));
        thead.appendChild(hRow);
        table.appendChild(thead);

        // Body
        const tbody=h("tbody",{});
        const sortedReqs=[...S.reqs].sort((a,b)=>a.id.localeCompare(b.id));
        sortedReqs.forEach((req,idx)=>{
          const tr=h("tr",{style:{background:idx%2===0?"transparent":"var(--surface)06"}});
          tr.addEventListener("mouseenter",()=>tr.style.background="var(--accentDim)11");
          tr.addEventListener("mouseleave",()=>tr.style.background=idx%2===0?"transparent":"var(--surface)06");

          // Req ID + text
          const reqTd=h("td",{style:{padding:"8px 12px",borderBottom:"1px solid var(--border)",cursor:"pointer"},onClick:()=>{S.selId=req.id;setState({view:"editor"});}});
          reqTd.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:700,marginRight:"8px"}},req.id));
          reqTd.appendChild(h("span",{style:{color:"var(--text)",fontSize:"12px"}},req.text?req.text.substring(0,50)+(req.text.length>50?"...":""):"(empty)"));
          tr.appendChild(reqTd);

          // Level
          const lvlShort=req.level.replace(" Requirement","").replace("Stakeholder ","STK ");
          tr.appendChild(h("td",{style:{padding:"8px 12px",borderBottom:"1px solid var(--border)"}},h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",fontSize:"10px"}},lvlShort)));

          // Status
          const stClr=req.status==="Approved"?"var(--success)":req.status==="Draft"?"var(--textDim)":"var(--accent)";
          tr.appendChild(h("td",{style:{padding:"8px 12px",borderBottom:"1px solid var(--border)"}},h("span",{style:{fontSize:"11px",color:stClr}},req.status)));

          // Module columns
          let linkCount=0;
          modules.forEach(mod=>{
            const linked=mod.map[req.id]||[];
            linkCount+=linked.length;
            const td=h("td",{style:{padding:"6px 8px",borderBottom:"1px solid var(--border)",textAlign:"center"}});
            if(linked.length===0){
              td.appendChild(h("span",{style:{color:"var(--textDim)",opacity:.3}},"—"));
            }else{
              const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"3px",justifyContent:"center"}});
              linked.forEach(id=>{
                tags.appendChild(h("span",{className:"badge mono",style:{fontSize:"9px",background:"var(--accentDim)",color:"var(--accent)",cursor:"pointer",padding:"2px 6px"},onClick:e=>{e.stopPropagation();S[mod.selKey]=id;setState({view:mod.view});}},id));
              });
              td.appendChild(tags);
            }
            tr.appendChild(td);
          });

          // Coverage indicator
          const covTd=h("td",{style:{padding:"8px 12px",borderBottom:"1px solid var(--border)",textAlign:"center"}});
          const covClr=linkCount>=3?"var(--success)":linkCount>=1?"var(--warn)":"var(--danger)";
          const covDots=h("div",{style:{display:"flex",gap:"3px",justifyContent:"center"}});
          for(let i=0;i<4;i++){
            covDots.appendChild(h("div",{style:{width:"8px",height:"8px",borderRadius:"50%",background:i<linkCount?covClr:"var(--border)"}}));
          }
          covTd.appendChild(covDots);
          tr.appendChild(covTd);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.appendChild(table);
        main.appendChild(tableWrap);

        // Gaps analysis card
        const gapCard=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"14px",marginTop:"16px"}});

        // Fully unlinked requirements
        const unlinked=S.reqs.filter(r=>{
          return!(decsByReq[r.id]||[]).length&&!(stksByReq[r.id]||[]).length&&!(ifcsByReq[r.id]||[]).length&&!(ucsByReq[r.id]||[]).length;
        });
        if(unlinked.length>0){
          const ulCard=h("div",{className:"card",style:{background:"var(--danger)08",borderColor:"var(--danger)22"}});
          ulCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:700,color:"var(--danger)",marginBottom:"8px"}},"🔴 Fully Unlinked ("+unlinked.length+")"));
          ulCard.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginBottom:"8px"}},"Requirements with no links to any module:"));
          const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
          unlinked.forEach(r=>tags.appendChild(h("span",{className:"badge mono",style:{background:"var(--danger)22",color:"var(--danger)",cursor:"pointer",fontSize:"10px"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}},r.id)));
          ulCard.appendChild(tags);
          gapCard.appendChild(ulCard);
        }else{
          const allOk=h("div",{className:"card",style:{background:"var(--success)08",borderColor:"var(--success)22"}});
          allOk.appendChild(h("div",{style:{fontSize:"12px",fontWeight:700,color:"var(--success)"}},"✓ All requirements linked to at least one module"));
          gapCard.appendChild(allOk);
        }

        // Well-connected requirements (3+ modules)
        const wellLinked=S.reqs.filter(r=>{
          let c=0;
          if((decsByReq[r.id]||[]).length)c++;
          if((stksByReq[r.id]||[]).length)c++;
          if((ifcsByReq[r.id]||[]).length)c++;
          if((ucsByReq[r.id]||[]).length)c++;
          return c>=3;
        });
        const wlCard=h("div",{className:"card"});
        wlCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:700,color:"var(--accent)",marginBottom:"8px"}},"🟢 Well-Connected ("+wellLinked.length+")"));
        wlCard.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginBottom:"8px"}},"Requirements linked to 3+ modules:"));
        if(wellLinked.length===0){
          wlCard.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",fontStyle:"italic"}},"None yet — link requirements across modules to improve traceability."));
        }else{
          const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
          wellLinked.forEach(r=>tags.appendChild(h("span",{className:"badge mono",style:{background:"var(--accentDim)",color:"var(--accent)",cursor:"pointer",fontSize:"10px"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}},r.id)));
          wlCard.appendChild(tags);
        }
        gapCard.appendChild(wlCard);
        main.appendChild(gapCard);

        // Cross-module connections summary
        const xCard=h("div",{className:"card",style:{marginTop:"14px"}});
        xCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:700,marginBottom:"12px"}},"Module Connection Summary"));
        const xGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:"12px"}});
        // UC ↔ Stakeholders
        const ucStkLinks=new Set();S.useCases.forEach(uc=>(uc.linkedStakeholders||[]).forEach(sid=>ucStkLinks.add(uc.id+"→"+sid)));
        const xBox1=h("div",{style:{background:"var(--surface)",borderRadius:"8px",padding:"12px",textAlign:"center"}});
        xBox1.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginBottom:"4px"}},"📐 Use Cases ↔ 👥 Stakeholders"));
        xBox1.appendChild(h("div",{className:"mono",style:{fontSize:"20px",fontWeight:700,color:"var(--accent)"}},String(ucStkLinks.size)));
        xBox1.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)"}},"connections"));
        xGrid.appendChild(xBox1);
        // IFC ↔ Reqs
        let ifcReqLinks=0;S.interfaces.forEach(i=>ifcReqLinks+=(i.linkedReqs||[]).length);
        const xBox2=h("div",{style:{background:"var(--surface)",borderRadius:"8px",padding:"12px",textAlign:"center"}});
        xBox2.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginBottom:"4px"}},"🔌 Interfaces ↔ ☰ Requirements"));
        xBox2.appendChild(h("div",{className:"mono",style:{fontSize:"20px",fontWeight:700,color:"var(--accent)"}},String(ifcReqLinks)));
        xBox2.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)"}},"connections"));
        xGrid.appendChild(xBox2);
        // DEC ↔ Reqs
        let decReqLinks=0;S.decisions.forEach(d=>decReqLinks+=(d.affectedReqs||[]).length);
        const xBox3=h("div",{style:{background:"var(--surface)",borderRadius:"8px",padding:"12px",textAlign:"center"}});
        xBox3.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginBottom:"4px"}},"📋 Decisions ↔ ☰ Requirements"));
        xBox3.appendChild(h("div",{className:"mono",style:{fontSize:"20px",fontWeight:700,color:"var(--accent)"}},String(decReqLinks)));
        xBox3.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)"}},"connections"));
        xGrid.appendChild(xBox3);
        xCard.appendChild(xGrid);
        main.appendChild(xCard);
      }
    }
  }

  // ═══ RISKS ═══
  if(S.view==="risks"){
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 300px",gap:"16px"}});

    // ─── LEFT SIDEBAR: Risk list ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    sbHead.appendChild(h("span",{style:{fontSize:"14px",fontWeight:700,flexShrink:0}},"⚠"));
    sbHead.appendChild(h("input",{id:"risk-search-input",className:"input",style:{flex:1,fontSize:"12px",padding:"6px 10px"},placeholder:"Search risks...",value:S.riskSearch||"",onInput:e=>{S.riskSearch=e.target.value;render();}}));
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addRisk,title:"Add risk"},"+"));
    sidebar.appendChild(sbHead);

    // Risk sidebar filters
    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const rCatSel=h("select",{id:"risk-filter-cat",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.riskFilterCat=e.target.value;render();}});
    rCatSel.appendChild(h("option",{value:"All"},"All Categories"));
    RISK_CATEGORIES.forEach(c=>rCatSel.appendChild(h("option",{value:c},c)));
    rCatSel.value=S.riskFilterCat;
    sbFilters.appendChild(rCatSel);
    const rStatSel=h("select",{id:"risk-filter-stat",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.riskFilterStat=e.target.value;render();}});
    rStatSel.appendChild(h("option",{value:"All"},"All Status"));
    RISK_STATUS.forEach(s=>rStatSel.appendChild(h("option",{value:s},s)));
    rStatSel.value=S.riskFilterStat;
    sbFilters.appendChild(rStatSel);
    sidebar.appendChild(sbFilters);

    const filteredRisks=S.risks.filter(r=>{
      if(S.riskFilterCat!=="All"&&r.category!==S.riskFilterCat)return false;
      if(S.riskFilterStat!=="All"&&r.status!==S.riskFilterStat)return false;
      if(S.riskSearch){
        const q=S.riskSearch.toLowerCase();
        if(!r.id.toLowerCase().includes(q)&&!(r.title||"").toLowerCase().includes(q)&&!r.category.toLowerCase().includes(q))return false;
      }
      return true;
    });

    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredRisks.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.riskSearch?"No matches":"No risks yet"));
    }
    filteredRisks.forEach(risk=>{
      const score=riskScore(risk.likelihood,risk.impact);
      const rl=riskLevel(score);
      const isSel=S.selRiskId===risk.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selRiskId=risk.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)"}},risk.id));
      const itemBadge=h("div",{style:{display:"flex",alignItems:"center",gap:"5px"}});
      itemBadge.appendChild(h("span",{style:{fontSize:"10px",padding:"2px 6px",borderRadius:"4px",background:rl.color+"22",color:rl.color,fontWeight:700}},rl.level));
      itemTop.appendChild(itemBadge);
      item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",lineHeight:"1.4",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},risk.title||"(No title)"));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"11px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredRisks.length+(S.riskSearch?" of "+S.risks.length:"")+" risk"+(filteredRisks.length!==1?"s":"");
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Risk editor ───
    const center=h("div",{});
    const selRisk=S.risks.find(r=>r.id===S.selRiskId);
    if(selRisk){
      const risk=selRisk;
      const score=riskScore(risk.likelihood,risk.impact);
      const rl=riskLevel(score);

      // Header
      const edCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const edHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      const edLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      edLeft.appendChild(h("span",{className:"mono",style:{fontSize:"14px",color:"var(--accent)",fontWeight:600}},risk.id));
      edLeft.appendChild(h("span",{className:"badge",style:{background:rl.color+"22",color:rl.color}},rl.level+" ("+score+")"));
      edLeft.appendChild(h("span",{className:"badge",style:{background:"var(--surface)",color:"var(--textMid)"}},risk.status));
      edHdr.appendChild(edLeft);
      edHdr.appendChild(h("button",{className:"btn btn-danger",style:{padding:"5px 12px",fontSize:"12px"},onClick:()=>{if(confirm("Delete "+risk.id+"?"))deleteRisk(risk.id);}},"✕ Delete"));
      edCard.appendChild(edHdr);

      // Title
      const r1=h("div",{style:{marginBottom:"12px"}});
      r1.appendChild(h("label",{className:"label"},"Risk Title"));
      r1.appendChild(h("input",{className:"input",value:risk.title||"",placeholder:"Brief title for this risk",onInput:e=>updateRiskSilent(risk.id,{title:e.target.value})}));
      edCard.appendChild(r1);

      // Description
      const r2=h("div",{style:{marginBottom:"12px"}});
      r2.appendChild(h("label",{className:"label"},"Description"));
      r2.appendChild(h("textarea",{className:"input",style:{minHeight:"80px",resize:"vertical",fontFamily:"inherit",lineHeight:"1.6"},value:risk.description||"",placeholder:"Detailed description of the risk...",onInput:e=>updateRiskSilent(risk.id,{description:e.target.value})}));
      edCard.appendChild(r2);

      // Category, Likelihood, Impact, Status
      const r3=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"12px",marginBottom:"12px"}});
      const catDiv=h("div",{});catDiv.appendChild(h("label",{className:"label"},"Category"));
      const catSel=h("select",{className:"input",value:risk.category,onChange:e=>updateRisk(risk.id,{category:e.target.value})});
      RISK_CATEGORIES.forEach(c=>catSel.appendChild(h("option",{value:c},c)));
      catDiv.appendChild(catSel);r3.appendChild(catDiv);
      const likDiv=h("div",{});likDiv.appendChild(h("label",{className:"label"},"Likelihood (1-5)"));
      const likSel=h("select",{className:"input",value:risk.likelihood,onChange:e=>updateRisk(risk.id,{likelihood:parseInt(e.target.value)})});
      LIKELIHOOD.forEach((l,i)=>likSel.appendChild(h("option",{value:i+1},l)));
      likDiv.appendChild(likSel);r3.appendChild(likDiv);
      const impDiv=h("div",{});impDiv.appendChild(h("label",{className:"label"},"Impact (1-5)"));
      const impSel=h("select",{className:"input",value:risk.impact,onChange:e=>updateRisk(risk.id,{impact:parseInt(e.target.value)})});
      IMPACT.forEach((im,i)=>impSel.appendChild(h("option",{value:i+1},im)));
      impDiv.appendChild(impSel);r3.appendChild(impDiv);
      const statDiv=h("div",{});statDiv.appendChild(h("label",{className:"label"},"Status"));
      const statSel=h("select",{className:"input",value:risk.status,onChange:e=>updateRisk(risk.id,{status:e.target.value})});
      RISK_STATUS.forEach(st=>statSel.appendChild(h("option",{value:st},st)));
      statDiv.appendChild(statSel);r3.appendChild(statDiv);
      edCard.appendChild(r3);
      center.appendChild(edCard);

      // Mitigations card
      const mitCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      mitCard.appendChild(h("label",{className:"label"},"Mitigation Requirements"));
      if(S.reqs.length===0){
        mitCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",padding:"8px",background:"var(--surface)",borderRadius:"6px"}},"No requirements defined yet. Create requirements first to link them as mitigations."));
      }else{
        const mitList=h("div",{style:{maxHeight:"180px",overflowY:"auto",border:"1px solid var(--border)",borderRadius:"8px",background:"var(--surface)"}});
        S.reqs.forEach(req=>{
          const isChecked=(risk.mitigations||[]).includes(req.id);
          const item=h("label",{style:{display:"flex",alignItems:"flex-start",gap:"8px",padding:"8px 10px",cursor:"pointer",borderBottom:"1px solid var(--border)",fontSize:"12px"}});
          const cb=h("input",{type:"checkbox",checked:isChecked,style:{marginTop:"2px"},onChange:e=>{
            e.stopPropagation();
            let mits=[...(risk.mitigations||[])];
            if(e.target.checked){if(!mits.includes(req.id))mits.push(req.id);}
            else{mits=mits.filter(m=>m!==req.id);}
            updateRisk(risk.id,{mitigations:mits});
          }});
          item.appendChild(cb);
          const label=h("div",{style:{flex:1}});
          label.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},req.id));
          label.appendChild(h("span",{style:{color:"var(--textMid)",marginLeft:"8px"}},(req.text||"").substring(0,60)+(req.text&&req.text.length>60?"...":"")));
          item.appendChild(label);
          mitList.appendChild(item);
        });
        mitCard.appendChild(mitList);
      }
      if(risk.mitigations&&risk.mitigations.length>0){
        const linked=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"8px"}});
        linked.appendChild(h("span",{style:{fontSize:"12px",color:"var(--textDim)",marginRight:"4px"}},"Linked:"));
        risk.mitigations.forEach(mid=>{
          const req=S.reqs.find(r=>r.id===mid);
          if(req)linked.appendChild(h("span",{className:"badge",style:{background:"var(--accent)22",color:"var(--accent)",cursor:"pointer"},onClick:()=>{S.selId=req.id;setState({view:"editor"});}},mid));
        });
        mitCard.appendChild(linked);
      }
      center.appendChild(mitCard);

      // Owner, Due Date, Notes
      const metaCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const r5=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",marginBottom:"12px"}});
      const ownDiv=h("div",{});ownDiv.appendChild(h("label",{className:"label"},"Owner"));
      ownDiv.appendChild(h("input",{className:"input",value:risk.owner||"",placeholder:"Responsible person",onInput:e=>updateRiskSilent(risk.id,{owner:e.target.value})}));
      r5.appendChild(ownDiv);
      const dueDiv=h("div",{});dueDiv.appendChild(h("label",{className:"label"},"Due Date"));
      dueDiv.appendChild(h("input",{className:"input",type:"date",value:risk.dueDate||"",onChange:e=>updateRisk(risk.id,{dueDate:e.target.value})}));
      r5.appendChild(dueDiv);
      metaCard.appendChild(r5);
      const r6=h("div",{});r6.appendChild(h("label",{className:"label"},"Notes"));
      r6.appendChild(h("textarea",{className:"input",style:{minHeight:"60px",resize:"vertical",fontFamily:"inherit",lineHeight:"1.6"},value:risk.notes||"",placeholder:"Additional notes...",onInput:e=>updateRiskSilent(risk.id,{notes:e.target.value})}));
      metaCard.appendChild(r6);
      center.appendChild(metaCard);
    }else{
      const empty=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      empty.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"16px"}},"⚠"));
      empty.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"16px",fontWeight:600,marginBottom:"8px"}},"Select a Risk"));
      empty.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",maxWidth:"360px",margin:"0 auto 20px"}},"Choose a risk from the sidebar to view and edit its details, or create a new one."));
      empty.appendChild(h("button",{className:"btn btn-pri",style:{padding:"10px 24px",fontSize:"14px"},onClick:addRisk},"+ Add Risk"));
      center.appendChild(empty);
    }
    grid.appendChild(center);

    // ─── RIGHT: Risk Matrix Summary ───
    const right=h("div",{});
    const matrixPanel=h("div",{style:{position:"sticky",top:"80px"}});
    const matrixCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    matrixCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"12px"}},"Risk Matrix Summary"));
    const matrixGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}});
    const critical=S.risks.filter(r=>riskScore(r.likelihood,r.impact)>=15).length;
    const high=S.risks.filter(r=>{const s=riskScore(r.likelihood,r.impact);return s>=10&&s<15;}).length;
    const medium=S.risks.filter(r=>{const s=riskScore(r.likelihood,r.impact);return s>=5&&s<10;}).length;
    const low=S.risks.filter(r=>riskScore(r.likelihood,r.impact)<5).length;
    [{l:"Critical",c:critical,clr:"var(--danger)"},{l:"High",c:high,clr:"var(--orange)"},{l:"Medium",c:medium,clr:"var(--warn)"},{l:"Low",c:low,clr:"var(--success)"}].forEach(x=>{
      const box=h("div",{style:{background:x.clr+"22",border:"1px solid "+x.clr+"44",borderRadius:"8px",padding:"14px",textAlign:"center"}});
      box.appendChild(h("div",{style:{fontSize:"28px",fontWeight:700,color:x.clr}},String(x.c)));
      box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textMid)",marginTop:"2px",textTransform:"uppercase",fontWeight:600}},x.l));
      matrixGrid.appendChild(box);
    });
    matrixCard.appendChild(matrixGrid);
    matrixPanel.appendChild(matrixCard);

    // Status breakdown
    if(S.risks.length>0){
      const statusCard=h("div",{className:"card"});
      statusCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"12px"}},"By Status"));
      const statusCounts={};RISK_STATUS.forEach(st=>statusCounts[st]=S.risks.filter(r=>r.status===st).length);
      Object.entries(statusCounts).filter(([,v])=>v>0).forEach(([st,count])=>{
        const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid var(--border)",fontSize:"13px"}});
        row.appendChild(h("span",{style:{color:"var(--textMid)"}},st));
        row.appendChild(h("span",{className:"mono",style:{fontWeight:700,color:"var(--text)"}},String(count)));
        statusCard.appendChild(row);
      });
      // Category breakdown
      statusCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginTop:"16px",marginBottom:"12px"}},"By Category"));
      const catCounts={};S.risks.forEach(r=>{catCounts[r.category]=(catCounts[r.category]||0)+1;});
      Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).forEach(([cat,count])=>{
        const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid var(--border)",fontSize:"13px"}});
        row.appendChild(h("span",{style:{color:"var(--textMid)"}},cat));
        row.appendChild(h("span",{className:"mono",style:{fontWeight:700,color:"var(--text)"}},String(count)));
        statusCard.appendChild(row);
      });
      matrixPanel.appendChild(statusCard);
    }
    right.appendChild(matrixPanel);
    grid.appendChild(right);
    main.appendChild(grid);
  }

  // ═══ DECISION LOG ═══
  if(S.view==="decisions"){
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 300px",gap:"16px"}});

    // ─── LEFT SIDEBAR: Decision list ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    sbHead.appendChild(h("span",{style:{fontSize:"14px",fontWeight:700,flexShrink:0}},"📋"));
    sbHead.appendChild(h("input",{id:"dec-search-input",className:"input",style:{flex:1,fontSize:"12px",padding:"6px 10px"},placeholder:"Search decisions...",value:S.decSearch||"",onInput:e=>{S.decSearch=e.target.value;render();}}));
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addDec,title:"Add decision"},"+"));
    sidebar.appendChild(sbHead);

    // Decision sidebar filters
    const decStatusClr={Proposed:"var(--warn)",Approved:"var(--success)",Superseded:"var(--textDim)",Rejected:"var(--danger)",Deferred:"var(--purple)"};
    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const dCatSel=h("select",{id:"dec-filter-cat",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.decFilterCat=e.target.value;render();}});
    dCatSel.appendChild(h("option",{value:"All"},"All Categories"));
    DEC_CATEGORIES.forEach(c=>dCatSel.appendChild(h("option",{value:c},c)));
    dCatSel.value=S.decFilterCat;
    sbFilters.appendChild(dCatSel);
    const dStatSel=h("select",{id:"dec-filter-stat",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.decFilterStat=e.target.value;render();}});
    dStatSel.appendChild(h("option",{value:"All"},"All Status"));
    DEC_STATUSES.forEach(s=>dStatSel.appendChild(h("option",{value:s},s)));
    dStatSel.value=S.decFilterStat;
    sbFilters.appendChild(dStatSel);
    sidebar.appendChild(sbFilters);

    const filteredDecs=S.decisions.filter(d=>{
      if(S.decFilterCat!=="All"&&d.category!==S.decFilterCat)return false;
      if(S.decFilterStat!=="All"&&d.status!==S.decFilterStat)return false;
      if(S.decSearch){
        const q=S.decSearch.toLowerCase();
        if(!d.id.toLowerCase().includes(q)&&!(d.title||"").toLowerCase().includes(q)&&!d.category.toLowerCase().includes(q)&&!d.status.toLowerCase().includes(q))return false;
      }
      return true;
    });

    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredDecs.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.decSearch?"No matches":"No decisions yet"));
    }
    filteredDecs.forEach(dec=>{
      const stClr=decStatusClr[dec.status]||"var(--textDim)";
      const isSel=S.selDecId===dec.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selDecId=dec.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)"}},dec.id));
      itemTop.appendChild(h("span",{style:{fontSize:"10px",padding:"2px 6px",borderRadius:"4px",background:stClr+"22",color:stClr,fontWeight:600}},dec.status));
      item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",lineHeight:"1.4",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},dec.title||"Untitled"));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"11px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredDecs.length+(S.decSearch?" of "+S.decisions.length:"")+" decision"+(filteredDecs.length!==1?"s":"");
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Decision editor ───
    const center=h("div",{});
    const selDec=S.decisions.find(d=>d.id===S.selDecId);
    if(selDec){
      const dec=selDec;
      const stClr=decStatusClr[dec.status]||"var(--textDim)";

      // Header card
      const edCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const edHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}});
      const edLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      edLeft.appendChild(h("span",{className:"mono",style:{fontSize:"14px",color:"var(--accent)",fontWeight:600}},dec.id));
      edLeft.appendChild(h("span",{className:"badge",style:{background:stClr+"22",color:stClr}},dec.status));
      edLeft.appendChild(h("span",{className:"badge",style:{background:"var(--surface)",color:"var(--textMid)"}},dec.category));
      edHdr.appendChild(edLeft);
      const edBtns=h("div",{style:{display:"flex",gap:"6px"}});
      edBtns.appendChild(h("button",{className:"btn btn-sec",style:{fontSize:"12px",padding:"5px 12px"},onClick:()=>{
        const txt=`${dec.id}: ${dec.title}\nDate: ${dec.date}\nStatus: ${dec.status}\nCategory: ${dec.category}\nDecision Maker: ${dec.decisionMaker||"N/A"}\n\nDecision: ${dec.decision}\n\nRationale: ${dec.rationale}\n\nAlternatives: ${dec.alternatives||"N/A"}\n\nAffected Requirements: ${(dec.affectedReqs||[]).join(", ")||"None"}`;
        navigator.clipboard.writeText(txt).then(()=>toast("Copied to clipboard","success")).catch(()=>toast("Copy failed","danger"));
      }},"📋 Copy"));
      edBtns.appendChild(h("button",{className:"btn btn-danger",style:{fontSize:"12px",padding:"5px 12px"},onClick:()=>{if(confirm("Delete "+dec.id+"?"))deleteDec(dec.id);}},"✕"));
      edHdr.appendChild(edBtns);
      edCard.appendChild(edHdr);

      // Title + Date + Decision Maker
      const r1=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 160px 200px",gap:"12px",marginBottom:"12px"}});
      const titleGrp=h("div",{});titleGrp.appendChild(h("label",{className:"label"},"Title"));
      titleGrp.appendChild(h("input",{className:"input",value:dec.title,placeholder:"Decision title",onInput:e=>updateDecSilent(dec.id,{title:e.target.value})}));
      r1.appendChild(titleGrp);
      const dateGrp=h("div",{});dateGrp.appendChild(h("label",{className:"label"},"Date"));
      dateGrp.appendChild(h("input",{className:"input",type:"date",value:dec.date,onChange:e=>updateDec(dec.id,{date:e.target.value})}));
      r1.appendChild(dateGrp);
      const makerGrp=h("div",{});makerGrp.appendChild(h("label",{className:"label"},"Decision Maker"));
      makerGrp.appendChild(h("input",{className:"input",value:dec.decisionMaker||"",placeholder:"Who decided",onInput:e=>updateDecSilent(dec.id,{decisionMaker:e.target.value})}));
      r1.appendChild(makerGrp);
      edCard.appendChild(r1);

      // Category + Status
      const r2=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"12px",marginBottom:"12px"}});
      const catGrp=h("div",{});catGrp.appendChild(h("label",{className:"label"},"Category"));
      const catSel=h("select",{className:"input",value:dec.category,onChange:e=>updateDec(dec.id,{category:e.target.value})});
      DEC_CATEGORIES.forEach(c=>{const o=h("option",{value:c},c);if(c===dec.category)o.selected=true;catSel.appendChild(o);});
      catGrp.appendChild(catSel);r2.appendChild(catGrp);
      const statGrp=h("div",{});statGrp.appendChild(h("label",{className:"label"},"Status"));
      const statSel=h("select",{className:"input",value:dec.status,onChange:e=>updateDec(dec.id,{status:e.target.value})});
      DEC_STATUSES.forEach(s=>{const o=h("option",{value:s},s);if(s===dec.status)o.selected=true;statSel.appendChild(o);});
      statGrp.appendChild(statSel);r2.appendChild(statGrp);
      r2.appendChild(h("div",{}));
      edCard.appendChild(r2);
      center.appendChild(edCard);

      // Decision + Rationale + Alternatives card
      const textCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      const decGrp=h("div",{style:{marginBottom:"12px"}});decGrp.appendChild(h("label",{className:"label"},"Decision"));
      decGrp.appendChild(h("textarea",{className:"input",style:{minHeight:"80px",resize:"vertical",fontFamily:"inherit",lineHeight:"1.6"},value:dec.decision,placeholder:"Describe the decision made...",onInput:e=>updateDecSilent(dec.id,{decision:e.target.value})}));
      textCard.appendChild(decGrp);
      const ratGrp=h("div",{style:{marginBottom:"12px"}});ratGrp.appendChild(h("label",{className:"label"},"Rationale"));
      ratGrp.appendChild(h("textarea",{className:"input",style:{minHeight:"60px",resize:"vertical",fontFamily:"inherit",lineHeight:"1.6"},value:dec.rationale,placeholder:"Why was this decision made?",onInput:e=>updateDecSilent(dec.id,{rationale:e.target.value})}));
      textCard.appendChild(ratGrp);
      const altGrp=h("div",{});altGrp.appendChild(h("label",{className:"label"},"Alternatives Considered"));
      altGrp.appendChild(h("textarea",{className:"input",style:{minHeight:"50px",resize:"vertical",fontFamily:"inherit",lineHeight:"1.6"},value:dec.alternatives||"",placeholder:"What other options were evaluated?",onInput:e=>updateDecSilent(dec.id,{alternatives:e.target.value})}));
      textCard.appendChild(altGrp);
      center.appendChild(textCard);

      // Affected Requirements card
      const reqCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      reqCard.appendChild(h("label",{className:"label"},"Affected Requirements"));
      if(S.reqs.length===0){
        reqCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",padding:"8px 0"}},"No requirements to link. Add requirements first."));
      }else{
        const reqBox=h("div",{style:{maxHeight:"180px",overflowY:"auto",background:"var(--surface)",borderRadius:"8px",border:"1px solid var(--border)",padding:"8px"}});
        S.reqs.forEach(r=>{
          const isChecked=(dec.affectedReqs||[]).includes(r.id);
          const row=h("label",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 6px",borderRadius:"4px",cursor:"pointer",fontSize:"12px"}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--surfAlt)");row.addEventListener("mouseleave",()=>row.style.background="transparent");
          const cb=h("input",{type:"checkbox",checked:isChecked,onChange:e=>{
            const cur=dec.affectedReqs||[];
            const updated=e.target.checked?[...cur,r.id]:cur.filter(x=>x!==r.id);
            updateDec(dec.id,{affectedReqs:updated});
          }});
          row.appendChild(cb);
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600,minWidth:"72px"}},r.id));
          row.appendChild(h("span",{style:{color:"var(--textMid)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.text?r.text.substring(0,80)+(r.text.length>80?"...":""):"(empty)"));
          reqBox.appendChild(row);
        });
        reqCard.appendChild(reqBox);
      }
      if(dec.affectedReqs&&dec.affectedReqs.length>0){
        const linkedBadges=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginTop:"8px"}});
        dec.affectedReqs.forEach(rid=>{
          const linkedReq=S.reqs.find(r=>r.id===rid);
          if(linkedReq)linkedBadges.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)",cursor:"pointer"},onClick:()=>{S.selId=rid;setState({view:"editor"});}},rid));
        });
        reqCard.appendChild(linkedBadges);
      }
      center.appendChild(reqCard);
    }else{
      const empty=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      empty.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"16px"}},"📋"));
      empty.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"16px",fontWeight:600,marginBottom:"8px"}},"Select a Decision"));
      empty.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",maxWidth:"360px",margin:"0 auto 20px"}},"Choose a decision from the sidebar to view and edit its details, or create a new one."));
      empty.appendChild(h("button",{className:"btn btn-pri",style:{padding:"10px 24px",fontSize:"14px"},onClick:addDec},"+ Add Decision"));
      center.appendChild(empty);
    }
    grid.appendChild(center);

    // ─── RIGHT: Status summary ───
    const right=h("div",{});
    const summaryPanel=h("div",{style:{position:"sticky",top:"80px"}});

    // Status counts
    const statusCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    statusCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"12px"}},"Status Overview"));
    const statusGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}});
    const allCount=S.decisions.length;
    const statusCounts={};DEC_STATUSES.forEach(s=>statusCounts[s]=S.decisions.filter(d=>d.status===s).length);
    [{l:"Total",v:allCount,c:"var(--accent)"}, ...DEC_STATUSES.map(s=>({l:s,v:statusCounts[s],c:decStatusClr[s]}))].filter(x=>x.v>0).forEach(s=>{
      const box=h("div",{style:{background:s.c+"15",border:"1px solid "+s.c+"33",borderRadius:"8px",padding:"12px",textAlign:"center"}});
      box.appendChild(h("div",{style:{fontSize:"24px",fontWeight:700,color:s.c}},String(s.v)));
      box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textMid)",marginTop:"2px",textTransform:"uppercase",fontWeight:600}},s.l));
      statusGrid.appendChild(box);
    });
    statusCard.appendChild(statusGrid);
    summaryPanel.appendChild(statusCard);

    // Category breakdown
    if(S.decisions.length>0){
      const catCard=h("div",{className:"card"});
      catCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"12px"}},"By Category"));
      const catCounts={};S.decisions.forEach(d=>{catCounts[d.category]=(catCounts[d.category]||0)+1;});
      Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).forEach(([cat,count])=>{
        const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:"1px solid var(--border)",fontSize:"13px"}});
        row.appendChild(h("span",{style:{color:"var(--textMid)"}},cat));
        row.appendChild(h("span",{className:"mono",style:{fontWeight:700,color:"var(--text)"}},String(count)));
        catCard.appendChild(row);
      });
      // Recent decisions
      catCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginTop:"16px",marginBottom:"12px"}},"Recent Decisions"));
      S.decisions.slice().sort((a,b)=>(b.modified||b.date).localeCompare(a.modified||a.date)).slice(0,5).forEach(d=>{
        const row=h("div",{style:{padding:"6px 0",borderBottom:"1px solid var(--border)"}});
        row.appendChild(h("div",{className:"mono",style:{fontSize:"11px",color:"var(--accent)",fontWeight:600}},d.id));
        row.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textMid)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},d.title||"Untitled"));
        catCard.appendChild(row);
      });
      summaryPanel.appendChild(catCard);
    }
    right.appendChild(summaryPanel);
    grid.appendChild(right);
    main.appendChild(grid);
  }

  // ═══ STAKEHOLDERS ═══
  if(S.view==="stakeholders"){
    main.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"20px"}},"Stakeholder Register"));
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 300px",gap:"16px"}});

    // ─── LEFT SIDEBAR ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    sbHead.appendChild(h("span",{style:{fontSize:"14px",fontWeight:700,flexShrink:0}},"👥"));
    sbHead.appendChild(h("input",{id:"stk-search-input",className:"input",style:{flex:1,fontSize:"12px",padding:"6px 10px"},placeholder:"Search stakeholders...",value:S.stkSearch||"",onInput:e=>{S.stkSearch=e.target.value;render();}}));
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addStk,title:"Add stakeholder"},"+"));
    sidebar.appendChild(sbHead);

    // Sidebar filters
    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const sRoleSel=h("select",{id:"stk-filter-role",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.stkFilterRole=e.target.value;render();}});
    sRoleSel.appendChild(h("option",{value:"All"},"All Roles"));
    STK_ROLES.forEach(r=>sRoleSel.appendChild(h("option",{value:r},r)));
    sRoleSel.value=S.stkFilterRole;
    sbFilters.appendChild(sRoleSel);
    const sInflSel=h("select",{id:"stk-filter-infl",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.stkFilterInfluence=e.target.value;render();}});
    sInflSel.appendChild(h("option",{value:"All"},"All Influence"));
    STK_INFLUENCE.forEach(i=>sInflSel.appendChild(h("option",{value:i},i)));
    sInflSel.value=S.stkFilterInfluence;
    sbFilters.appendChild(sInflSel);
    sidebar.appendChild(sbFilters);

    const stkInflClr={Critical:"var(--danger)",High:"var(--orange)",Medium:"var(--warn)",Low:"var(--success)"};

    const filteredStks=S.stakeholders.filter(s=>{
      if(S.stkFilterRole!=="All"&&s.role!==S.stkFilterRole)return false;
      if(S.stkFilterInfluence!=="All"&&s.influence!==S.stkFilterInfluence)return false;
      if(S.stkSearch){
        const q=S.stkSearch.toLowerCase();
        if(!s.id.toLowerCase().includes(q)&&!(s.name||"").toLowerCase().includes(q)&&!s.role.toLowerCase().includes(q)&&!(s.organization||"").toLowerCase().includes(q))return false;
      }
      return true;
    });

    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredStks.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.stkSearch||S.stkFilterRole!=="All"||S.stkFilterInfluence!=="All"?"No matches":"No stakeholders yet"));
    }
    filteredStks.forEach(stk=>{
      const isSel=S.selStkId===stk.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selStkId=stk.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)"}},stk.id));
      const ic=stkInflClr[stk.influence]||"var(--textDim)";
      itemTop.appendChild(h("span",{className:"badge",style:{background:ic+"22",color:ic,fontSize:"10px"}},stk.influence));
      item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"13px",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:"1.4"}},stk.name||"Unnamed Stakeholder"));
      item.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"2px"}},stk.role+(stk.organization?" · "+stk.organization:"")));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"12px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredStks.length+(S.stkSearch||S.stkFilterRole!=="All"||S.stkFilterInfluence!=="All"?" of "+S.stakeholders.length:"")+" stakeholder"+(filteredStks.length!==1?"s":"");
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Editor ───
    const center=h("div",{});
    const selStk=S.stakeholders.find(s=>s.id===S.selStkId);
    if(!selStk){
      const emptyS=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      emptyS.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"12px"}},"👥"));
      emptyS.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"Select a Stakeholder"));
      emptyS.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Choose from the sidebar or create a new stakeholder to define who has interest in your system requirements."));
      emptyS.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:addStk},"+ Add Stakeholder"));
      center.appendChild(emptyS);
    }else{
      // Header
      const eHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"}});
      const eHeadLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      eHeadLeft.appendChild(h("span",{className:"mono",style:{fontSize:"16px",fontWeight:700,color:"var(--accent)"}},selStk.id));
      const ic=stkInflClr[selStk.influence]||"var(--textDim)";
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:ic+"22",color:ic}},selStk.influence+" Influence"));
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)"}},selStk.category));
      eHead.appendChild(eHeadLeft);
      eHead.appendChild(h("button",{className:"btn btn-danger",style:{padding:"6px 14px",fontSize:"12px"},onClick:()=>deleteStk(selStk.id)},"🗑 Delete"));
      center.appendChild(eHead);

      // Identity card
      const idCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      idCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Identity"));
      const idGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}});
      // Name
      const nameG=h("div",{});nameG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Name *"));
      nameG.appendChild(h("input",{id:"stk-name",className:"input",value:selStk.name||"",placeholder:"Stakeholder name",onInput:e=>updateStkSilent(selStk.id,{name:e.target.value})}));
      idGrid.appendChild(nameG);
      // Organization
      const orgG=h("div",{});orgG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Organization"));
      orgG.appendChild(h("input",{id:"stk-org",className:"input",value:selStk.organization||"",placeholder:"Company / department",onInput:e=>updateStkSilent(selStk.id,{organization:e.target.value})}));
      idGrid.appendChild(orgG);
      idCard.appendChild(idGrid);
      // Row 2: Role, Influence, Category
      const row2=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"10px",marginTop:"10px"}});
      const roleG=h("div",{});roleG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Role"));
      const roleSel=h("select",{id:"stk-role",className:"input",onChange:e=>updateStk(selStk.id,{role:e.target.value})});
      STK_ROLES.forEach(r=>roleSel.appendChild(h("option",{value:r},r)));roleSel.value=selStk.role;
      roleG.appendChild(roleSel);row2.appendChild(roleG);
      const inflG=h("div",{});inflG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Influence"));
      const inflSel=h("select",{id:"stk-infl",className:"input",onChange:e=>updateStk(selStk.id,{influence:e.target.value})});
      STK_INFLUENCE.forEach(i=>inflSel.appendChild(h("option",{value:i},i)));inflSel.value=selStk.influence;
      inflG.appendChild(inflSel);row2.appendChild(inflG);
      const catG=h("div",{});catG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Category"));
      const catSel=h("select",{id:"stk-cat",className:"input",onChange:e=>updateStk(selStk.id,{category:e.target.value})});
      STK_CATEGORIES.forEach(c=>catSel.appendChild(h("option",{value:c},c)));catSel.value=selStk.category;
      catG.appendChild(catSel);row2.appendChild(catG);
      idCard.appendChild(row2);
      // Contact
      const contactG=h("div",{style:{marginTop:"10px"}});contactG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Contact Info"));
      contactG.appendChild(h("input",{id:"stk-contact",className:"input",value:selStk.contactInfo||"",placeholder:"Email, phone, or other contact details",onInput:e=>updateStkSilent(selStk.id,{contactInfo:e.target.value})}));
      idCard.appendChild(contactG);
      center.appendChild(idCard);

      // Concerns & Expectations card
      const ceCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      ceCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Concerns & Expectations"));
      ceCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Key Concerns"));
      ceCard.appendChild(h("textarea",{id:"stk-concerns",className:"input",style:{minHeight:"80px",resize:"vertical"},value:selStk.concerns||"",placeholder:"What matters most to this stakeholder? Safety, cost, schedule, usability...",onInput:e=>updateStkSilent(selStk.id,{concerns:e.target.value})}));
      ceCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px",marginTop:"10px"}},"Expectations"));
      ceCard.appendChild(h("textarea",{id:"stk-expectations",className:"input",style:{minHeight:"80px",resize:"vertical"},value:selStk.expectations||"",placeholder:"What does this stakeholder expect from the system?",onInput:e=>updateStkSilent(selStk.id,{expectations:e.target.value})}));
      center.appendChild(ceCard);

      // Linked Stakeholder Needs card
      const lnCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      lnCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Linked Stakeholder Needs"));
      const stkNeeds=S.reqs.filter(r=>r.level==="Stakeholder Need");
      if(stkNeeds.length===0){
        lnCard.appendChild(h("div",{style:{padding:"16px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},"No stakeholder needs defined yet. Create requirements with level \"Stakeholder Need\" in the Author view."));
      }else{
        const lnList=h("div",{style:{maxHeight:"200px",overflowY:"auto"}});
        stkNeeds.forEach(r=>{
          const isLinked=(selStk.linkedNeeds||[]).includes(r.id);
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 8px",borderRadius:"6px",marginBottom:"2px",background:isLinked?"var(--accentDim)22":"transparent"}});
          row.appendChild(h("input",{type:"checkbox",checked:isLinked,onChange:()=>{
            const needs=[...(selStk.linkedNeeds||[])];
            if(isLinked)needs.splice(needs.indexOf(r.id),1);else needs.push(r.id);
            updateStk(selStk.id,{linkedNeeds:needs});
          }}));
          const lbl=h("span",{style:{flex:1,fontSize:"13px",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}});
          lbl.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600,marginRight:"8px"}},r.id));
          lbl.appendChild(document.createTextNode(r.text?r.text.substring(0,80)+(r.text.length>80?"...":""):"(empty)"));
          row.appendChild(lbl);
          lnList.appendChild(row);
        });
        lnCard.appendChild(lnList);
      }
      const linkedCount=(selStk.linkedNeeds||[]).length;
      if(linkedCount>0){
        lnCard.appendChild(h("div",{style:{marginTop:"8px",fontSize:"12px",color:"var(--accent)"}},linkedCount+" linked need"+(linkedCount!==1?"s":"")));
      }
      center.appendChild(lnCard);

      // Notes card
      const notesCard=h("div",{className:"card"});
      notesCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Notes"));
      notesCard.appendChild(h("textarea",{id:"stk-notes",className:"input",style:{minHeight:"60px",resize:"vertical"},value:selStk.notes||"",placeholder:"Additional notes about this stakeholder...",onInput:e=>updateStkSilent(selStk.id,{notes:e.target.value})}));
      center.appendChild(notesCard);
    }
    grid.appendChild(center);

    // ─── RIGHT: Summary Panel ───
    const right=h("div",{});
    const summaryPanel=h("div",{style:{position:"sticky",top:"80px"}});

    // Influence Overview
    const inflCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    inflCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"Influence Overview"));
    const inflGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"}});
    STK_INFLUENCE.forEach(level=>{
      const cnt=S.stakeholders.filter(s=>s.influence===level).length;
      const clr=stkInflClr[level]||"var(--textDim)";
      const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"10px",textAlign:"center"}});
      box.appendChild(h("div",{className:"mono",style:{fontSize:"20px",fontWeight:700,color:clr}},String(cnt)));
      box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)"}},level));
      inflGrid.appendChild(box);
    });
    inflCard.appendChild(inflGrid);
    summaryPanel.appendChild(inflCard);

    // Role Breakdown
    const roleCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    roleCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Role"));
    const roleCounts={};S.stakeholders.forEach(s=>{roleCounts[s.role]=(roleCounts[s.role]||0)+1;});
    const sortedRoles=Object.entries(roleCounts).sort((a,b)=>b[1]-a[1]);
    if(sortedRoles.length===0){
      roleCard.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",textAlign:"center",padding:"8px"}},"No data"));
    }
    sortedRoles.forEach(([role,cnt])=>{
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},role));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      roleCard.appendChild(row);
    });
    summaryPanel.appendChild(roleCard);

    // Category Breakdown
    const catCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    catCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Category"));
    const catCounts={};S.stakeholders.forEach(s=>{catCounts[s.category]=(catCounts[s.category]||0)+1;});
    const sortedCats=Object.entries(catCounts).sort((a,b)=>b[1]-a[1]);
    if(sortedCats.length===0){
      catCard.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",textAlign:"center",padding:"8px"}},"No data"));
    }
    sortedCats.forEach(([cat,cnt])=>{
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},cat));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      catCard.appendChild(row);
    });
    summaryPanel.appendChild(catCard);

    // Coverage — stakeholder needs without linked stakeholders
    const stkNeeds2=S.reqs.filter(r=>r.level==="Stakeholder Need");
    const linkedNeedIds=new Set();S.stakeholders.forEach(s=>(s.linkedNeeds||[]).forEach(id=>linkedNeedIds.add(id)));
    const unlinked=stkNeeds2.filter(r=>!linkedNeedIds.has(r.id));
    if(unlinked.length>0){
      const covCard=h("div",{className:"card",style:{background:"var(--warn)11",borderColor:"var(--warn)33"}});
      covCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--warn)",marginBottom:"8px"}},"⚠ Unlinked Needs ("+unlinked.length+")"));
      covCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",marginBottom:"8px"}},"Stakeholder needs not linked to any stakeholder:"));
      const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
      unlinked.forEach(r=>tags.appendChild(h("span",{className:"badge",style:{background:"var(--warn)22",color:"var(--warn)",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}},r.id)));
      covCard.appendChild(tags);
      summaryPanel.appendChild(covCard);
    }else if(stkNeeds2.length>0){
      const covOk=h("div",{className:"card",style:{background:"var(--success)11",borderColor:"var(--success)33"}});
      covOk.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--success)"}},"✓ All "+stkNeeds2.length+" stakeholder needs linked"));
      summaryPanel.appendChild(covOk);
    }

    right.appendChild(summaryPanel);
    grid.appendChild(right);
    main.appendChild(grid);
  }

  // ═══ INTERFACES ═══
  if(S.view==="interfaces"){
    main.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"20px"}},"Interface Definitions"));
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 300px",gap:"16px"}});
    const ifcStatusClr={Draft:"var(--textDim)",Defined:"var(--accent)",Agreed:"var(--success)",Verified:"var(--success)",Deprecated:"var(--danger)"};
    const ifcDirIcon={"Unidirectional →":"→","Bidirectional ↔":"↔","Broadcast ⇉":"⇉"};

    // ─── LEFT SIDEBAR ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    sbHead.appendChild(h("span",{style:{fontSize:"14px",fontWeight:700,flexShrink:0}},"🔌"));
    sbHead.appendChild(h("input",{id:"ifc-search-input",className:"input",style:{flex:1,fontSize:"12px",padding:"6px 10px"},placeholder:"Search interfaces...",value:S.ifcSearch||"",onInput:e=>{S.ifcSearch=e.target.value;render();}}));
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addIfc,title:"Add interface"},"+"));
    sidebar.appendChild(sbHead);

    // Sidebar filters
    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const iTypeSel=h("select",{id:"ifc-filter-type",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.ifcFilterType=e.target.value;render();}});
    iTypeSel.appendChild(h("option",{value:"All"},"All Types"));
    IFC_TYPES.forEach(t=>iTypeSel.appendChild(h("option",{value:t},t)));
    iTypeSel.value=S.ifcFilterType;
    sbFilters.appendChild(iTypeSel);
    const iStatSel=h("select",{id:"ifc-filter-status",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.ifcFilterStatus=e.target.value;render();}});
    iStatSel.appendChild(h("option",{value:"All"},"All Status"));
    IFC_STATUSES.forEach(s=>iStatSel.appendChild(h("option",{value:s},s)));
    iStatSel.value=S.ifcFilterStatus;
    sbFilters.appendChild(iStatSel);
    sidebar.appendChild(sbFilters);

    const filteredIfcs=S.interfaces.filter(i=>{
      if(S.ifcFilterType!=="All"&&i.type!==S.ifcFilterType)return false;
      if(S.ifcFilterStatus!=="All"&&i.status!==S.ifcFilterStatus)return false;
      if(S.ifcSearch){
        const q=S.ifcSearch.toLowerCase();
        if(!i.id.toLowerCase().includes(q)&&!(i.name||"").toLowerCase().includes(q)&&!(i.source||"").toLowerCase().includes(q)&&!(i.destination||"").toLowerCase().includes(q))return false;
      }
      return true;
    });

    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredIfcs.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.ifcSearch||S.ifcFilterType!=="All"||S.ifcFilterStatus!=="All"?"No matches":"No interfaces yet"));
    }
    filteredIfcs.forEach(ifc=>{
      const isSel=S.selIfcId===ifc.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selIfcId=ifc.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)"}},ifc.id));
      const sc=ifcStatusClr[ifc.status]||"var(--textDim)";
      itemTop.appendChild(h("span",{className:"badge",style:{background:sc+"22",color:sc,fontSize:"10px"}},ifc.status));
      item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"13px",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:"1.4"}},ifc.name||"Unnamed Interface"));
      const dirTxt=(ifcDirIcon[ifc.direction]||"↔")+" "+(ifc.source||"?")+" — "+(ifc.destination||"?");
      item.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"2px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},ifc.type+" · "+dirTxt));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"12px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredIfcs.length+(S.ifcSearch||S.ifcFilterType!=="All"||S.ifcFilterStatus!=="All"?" of "+S.interfaces.length:"")+" interface"+(filteredIfcs.length!==1?"s":"");
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Editor ───
    const center=h("div",{});
    const selIfc=S.interfaces.find(i=>i.id===S.selIfcId);
    if(!selIfc){
      const emptyI=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      emptyI.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"12px"}},"🔌"));
      emptyI.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"Select an Interface"));
      emptyI.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Choose from the sidebar or create a new interface definition to specify how system elements communicate and interact."));
      emptyI.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:addIfc},"+ Add Interface"));
      center.appendChild(emptyI);
    }else{
      // Header
      const eHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"}});
      const eHeadLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      eHeadLeft.appendChild(h("span",{className:"mono",style:{fontSize:"16px",fontWeight:700,color:"var(--accent)"}},selIfc.id));
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)"}},selIfc.type));
      const sc=ifcStatusClr[selIfc.status]||"var(--textDim)";
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:sc+"22",color:sc}},selIfc.status));
      eHeadLeft.appendChild(h("span",{style:{fontSize:"18px"}},ifcDirIcon[selIfc.direction]||"↔"));
      eHead.appendChild(eHeadLeft);
      eHead.appendChild(h("button",{className:"btn btn-danger",style:{padding:"6px 14px",fontSize:"12px"},onClick:()=>deleteIfc(selIfc.id)},"🗑 Delete"));
      center.appendChild(eHead);

      // Identity card
      const idCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      idCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Interface Identity"));
      const nameG=h("div",{style:{marginBottom:"10px"}});nameG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Interface Name *"));
      nameG.appendChild(h("input",{id:"ifc-name",className:"input",value:selIfc.name||"",placeholder:"e.g. Sensor Hub ↔ Control Panel Data Link",onInput:e=>updateIfcSilent(selIfc.id,{name:e.target.value})}));
      idCard.appendChild(nameG);
      // Type, Direction, Status row
      const row1=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"10px",marginBottom:"10px"}});
      const typeG=h("div",{});typeG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Type"));
      const typeSel=h("select",{id:"ifc-type",className:"input",onChange:e=>updateIfc(selIfc.id,{type:e.target.value})});
      IFC_TYPES.forEach(t=>typeSel.appendChild(h("option",{value:t},t)));typeSel.value=selIfc.type;
      typeG.appendChild(typeSel);row1.appendChild(typeG);
      const dirG=h("div",{});dirG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Direction"));
      const dirSel=h("select",{id:"ifc-dir",className:"input",onChange:e=>updateIfc(selIfc.id,{direction:e.target.value})});
      IFC_DIRECTIONS.forEach(d=>dirSel.appendChild(h("option",{value:d},d)));dirSel.value=selIfc.direction;
      dirG.appendChild(dirSel);row1.appendChild(dirG);
      const statG=h("div",{});statG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Status"));
      const statSel=h("select",{id:"ifc-stat",className:"input",onChange:e=>updateIfc(selIfc.id,{status:e.target.value})});
      IFC_STATUSES.forEach(s=>statSel.appendChild(h("option",{value:s},s)));statSel.value=selIfc.status;
      statG.appendChild(statSel);row1.appendChild(statG);
      idCard.appendChild(row1);
      center.appendChild(idCard);

      // Endpoints card
      const epCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      epCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Endpoints"));
      const epGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr auto 1fr",gap:"10px",alignItems:"end"}});
      const srcG=h("div",{});srcG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Source"));
      srcG.appendChild(h("input",{id:"ifc-src",className:"input",value:selIfc.source||"",placeholder:"e.g. Sensor Hub Module",onInput:e=>updateIfcSilent(selIfc.id,{source:e.target.value})}));
      epGrid.appendChild(srcG);
      epGrid.appendChild(h("div",{style:{fontSize:"24px",textAlign:"center",padding:"0 8px 8px",color:"var(--accent)"}},ifcDirIcon[selIfc.direction]||"↔"));
      const dstG=h("div",{});dstG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Destination"));
      dstG.appendChild(h("input",{id:"ifc-dst",className:"input",value:selIfc.destination||"",placeholder:"e.g. Central Control Panel",onInput:e=>updateIfcSilent(selIfc.id,{destination:e.target.value})}));
      epGrid.appendChild(dstG);
      epCard.appendChild(epGrid);
      // Protocol
      const protoG=h("div",{style:{marginTop:"10px"}});protoG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Protocol / Standard"));
      const protoSel=h("select",{id:"ifc-proto",className:"input",onChange:e=>updateIfc(selIfc.id,{protocol:e.target.value})});
      protoSel.appendChild(h("option",{value:""},"— Select Protocol —"));
      IFC_PROTOCOLS.forEach(p=>protoSel.appendChild(h("option",{value:p},p)));protoSel.value=selIfc.protocol||"";
      protoG.appendChild(protoSel);epCard.appendChild(protoG);
      center.appendChild(epCard);

      // Technical Specs card
      const specCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      specCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Technical Specifications"));
      specCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Data Items / Signals"));
      specCard.appendChild(h("textarea",{id:"ifc-data",className:"input",style:{minHeight:"80px",resize:"vertical"},value:selIfc.dataItems||"",placeholder:"List the data items, signals, or messages exchanged:\ne.g. sensor_reading (float32), timestamp (uint64), alert_flag (bool)",onInput:e=>updateIfcSilent(selIfc.id,{dataItems:e.target.value})}));
      const specRow=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px",marginTop:"10px"}});
      const rateG=h("div",{});rateG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Data Rate / Bandwidth"));
      rateG.appendChild(h("input",{id:"ifc-rate",className:"input",value:selIfc.dataRate||"",placeholder:"e.g. 115200 baud, 100 Mbps",onInput:e=>updateIfcSilent(selIfc.id,{dataRate:e.target.value})}));
      specRow.appendChild(rateG);
      const physG=h("div",{});physG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Physical Characteristics"));
      physG.appendChild(h("input",{id:"ifc-phys",className:"input",value:selIfc.physicalChar||"",placeholder:"e.g. RJ-45, 9-pin D-Sub, 2.4GHz",onInput:e=>updateIfcSilent(selIfc.id,{physicalChar:e.target.value})}));
      specRow.appendChild(physG);
      specCard.appendChild(specRow);
      center.appendChild(specCard);

      // Linked Requirements card
      const lrCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      lrCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Linked Requirements"));
      const ifcReqs=S.reqs.filter(r=>r.type==="Interface");
      if(S.reqs.length===0){
        lrCard.appendChild(h("div",{style:{padding:"16px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},"No requirements defined yet."));
      }else{
        const lrList=h("div",{style:{maxHeight:"200px",overflowY:"auto"}});
        // Show interface-type reqs first, then others
        const sortedReqs=[...ifcReqs,...S.reqs.filter(r=>r.type!=="Interface")];
        sortedReqs.forEach(r=>{
          const isLinked=(selIfc.linkedReqs||[]).includes(r.id);
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 8px",borderRadius:"6px",marginBottom:"2px",background:isLinked?"var(--accentDim)22":"transparent"}});
          row.appendChild(h("input",{type:"checkbox",checked:isLinked,onChange:()=>{
            const reqs=[...(selIfc.linkedReqs||[])];
            if(isLinked)reqs.splice(reqs.indexOf(r.id),1);else reqs.push(r.id);
            updateIfc(selIfc.id,{linkedReqs:reqs});
          }}));
          const lbl=h("span",{style:{flex:1,fontSize:"13px",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}});
          lbl.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600,marginRight:"8px"}},r.id));
          lbl.appendChild(document.createTextNode(r.text?r.text.substring(0,70)+(r.text.length>70?"...":""):"(empty)"));
          if(r.type==="Interface")lbl.appendChild(h("span",{className:"badge",style:{marginLeft:"6px",background:"var(--accentDim)",color:"var(--accent)",fontSize:"9px"}},"INTERFACE"));
          row.appendChild(lbl);
          lrList.appendChild(row);
        });
        lrCard.appendChild(lrList);
      }
      const linkedCnt=(selIfc.linkedReqs||[]).length;
      if(linkedCnt>0)lrCard.appendChild(h("div",{style:{marginTop:"8px",fontSize:"12px",color:"var(--accent)"}},linkedCnt+" linked requirement"+(linkedCnt!==1?"s":"")));
      center.appendChild(lrCard);

      // Notes card
      const notesCard=h("div",{className:"card"});
      notesCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Notes"));
      notesCard.appendChild(h("textarea",{id:"ifc-notes",className:"input",style:{minHeight:"60px",resize:"vertical"},value:selIfc.notes||"",placeholder:"Additional notes, constraints, or references (e.g. ICD document number)...",onInput:e=>updateIfcSilent(selIfc.id,{notes:e.target.value})}));
      center.appendChild(notesCard);
    }
    grid.appendChild(center);

    // ─── RIGHT: Summary Panel ───
    const right=h("div",{});
    const summaryPanel=h("div",{style:{position:"sticky",top:"80px"}});

    // Type Overview
    const typeCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    typeCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Type"));
    const typeCounts={};S.interfaces.forEach(i=>{typeCounts[i.type]=(typeCounts[i.type]||0)+1;});
    const sortedTypes=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
    if(sortedTypes.length===0){
      typeCard.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",textAlign:"center",padding:"8px"}},"No data"));
    }
    sortedTypes.forEach(([type,cnt])=>{
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},type));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      typeCard.appendChild(row);
    });
    summaryPanel.appendChild(typeCard);

    // Status Breakdown
    const statCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    statCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Status"));
    const sGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"}});
    IFC_STATUSES.forEach(st=>{
      const cnt=S.interfaces.filter(i=>i.status===st).length;
      const clr=ifcStatusClr[st]||"var(--textDim)";
      const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"8px",textAlign:"center"}});
      box.appendChild(h("div",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:clr}},String(cnt)));
      box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)"}},st));
      sGrid.appendChild(box);
    });
    statCard.appendChild(sGrid);
    summaryPanel.appendChild(statCard);

    // Direction Breakdown
    const dirCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    dirCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Direction"));
    IFC_DIRECTIONS.forEach(dir=>{
      const cnt=S.interfaces.filter(i=>i.direction===dir).length;
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},dir));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      dirCard.appendChild(row);
    });
    summaryPanel.appendChild(dirCard);

    // Interface-type reqs without linked interfaces
    const ifcTypeReqs=S.reqs.filter(r=>r.type==="Interface");
    const linkedReqIds=new Set();S.interfaces.forEach(i=>(i.linkedReqs||[]).forEach(id=>linkedReqIds.add(id)));
    const unlinkedIfcReqs=ifcTypeReqs.filter(r=>!linkedReqIds.has(r.id));
    if(unlinkedIfcReqs.length>0){
      const covCard=h("div",{className:"card",style:{background:"var(--warn)11",borderColor:"var(--warn)33"}});
      covCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--warn)",marginBottom:"8px"}},"⚠ Unlinked Interface Reqs ("+unlinkedIfcReqs.length+")"));
      covCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",marginBottom:"8px"}},"Interface-type requirements not linked to any interface definition:"));
      const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
      unlinkedIfcReqs.forEach(r=>tags.appendChild(h("span",{className:"badge",style:{background:"var(--warn)22",color:"var(--warn)",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}},r.id)));
      covCard.appendChild(tags);
      summaryPanel.appendChild(covCard);
    }else if(ifcTypeReqs.length>0){
      const covOk=h("div",{className:"card",style:{background:"var(--success)11",borderColor:"var(--success)33"}});
      covOk.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--success)"}},"✓ All "+ifcTypeReqs.length+" interface requirements linked"));
      summaryPanel.appendChild(covOk);
    }

    right.appendChild(summaryPanel);
    grid.appendChild(right);
    main.appendChild(grid);
  }

  // ═══ USE CASES ═══
  if(S.view==="usecases"){
    main.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"20px"}},"Use Cases & Scenarios"));
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"260px 1fr 300px",gap:"16px"}});
    const ucStatClr={Draft:"var(--textDim)",Reviewed:"var(--accent)",Validated:"var(--success)",Approved:"var(--success)",Deprecated:"var(--danger)"};
    const ucPriClr={Critical:"var(--danger)",High:"var(--orange)",Medium:"var(--warn)",Low:"var(--success)"};

    // ─── LEFT SIDEBAR ───
    const sidebar=h("div",{style:{background:"var(--card)",borderRadius:"12px",border:"1px solid var(--border)",overflow:"hidden",display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 120px)",position:"sticky",top:"80px"}});
    const sbHead=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px",alignItems:"center"}});
    sbHead.appendChild(h("span",{style:{fontSize:"14px",fontWeight:700,flexShrink:0}},"📐"));
    sbHead.appendChild(h("input",{id:"uc-search-input",className:"input",style:{flex:1,fontSize:"12px",padding:"6px 10px"},placeholder:"Search use cases...",value:S.ucSearch||"",onInput:e=>{S.ucSearch=e.target.value;render();}}));
    sbHead.appendChild(h("button",{className:"btn btn-pri",style:{padding:"6px 12px",fontSize:"14px",lineHeight:1,flexShrink:0},onClick:addUc,title:"Add use case"},"+"));
    sidebar.appendChild(sbHead);

    const sbFilters=h("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:"4px"}});
    const uTypeSel=h("select",{id:"uc-filter-type",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.ucFilterType=e.target.value;render();}});
    uTypeSel.appendChild(h("option",{value:"All"},"All Types"));
    UC_TYPES.forEach(t=>uTypeSel.appendChild(h("option",{value:t},t)));
    uTypeSel.value=S.ucFilterType;
    sbFilters.appendChild(uTypeSel);
    const uStatSel=h("select",{id:"uc-filter-stat",className:"input",style:{flex:1,fontSize:"11px",padding:"4px 6px"},onChange:e=>{S.ucFilterStat=e.target.value;render();}});
    uStatSel.appendChild(h("option",{value:"All"},"All Status"));
    UC_STATUSES.forEach(s=>uStatSel.appendChild(h("option",{value:s},s)));
    uStatSel.value=S.ucFilterStat;
    sbFilters.appendChild(uStatSel);
    sidebar.appendChild(sbFilters);

    const filteredUcs=S.useCases.filter(u=>{
      if(S.ucFilterType!=="All"&&u.type!==S.ucFilterType)return false;
      if(S.ucFilterStat!=="All"&&u.status!==S.ucFilterStat)return false;
      if(S.ucSearch){
        const q=S.ucSearch.toLowerCase();
        if(!u.id.toLowerCase().includes(q)&&!(u.title||"").toLowerCase().includes(q)&&!(u.actor||"").toLowerCase().includes(q))return false;
      }
      return true;
    });

    const sbList=h("div",{style:{flex:1,overflowY:"auto"}});
    if(filteredUcs.length===0){
      sbList.appendChild(h("div",{style:{padding:"24px 12px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},S.ucSearch||S.ucFilterType!=="All"||S.ucFilterStat!=="All"?"No matches":"No use cases yet"));
    }
    filteredUcs.forEach(uc=>{
      const isSel=S.selUcId===uc.id;
      const item=h("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--border)",borderLeft:isSel?"3px solid var(--accent)":"3px solid transparent",background:isSel?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"background .1s"},onClick:()=>{S.selUcId=uc.id;render();}});
      item.addEventListener("mouseenter",()=>{if(!isSel)item.style.background="var(--cardHov)";});
      item.addEventListener("mouseleave",()=>{item.style.background=isSel?"var(--accentDim)22":"transparent";});
      const itemTop=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"3px"}});
      itemTop.appendChild(h("span",{className:"mono",style:{fontSize:"12px",fontWeight:600,color:isSel?"var(--accent)":"var(--textMid)"}},uc.id));
      const pc=ucPriClr[uc.priority]||"var(--textDim)";
      itemTop.appendChild(h("span",{className:"badge",style:{background:pc+"22",color:pc,fontSize:"10px"}},uc.priority));
      item.appendChild(itemTop);
      item.appendChild(h("div",{style:{fontSize:"13px",color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:"1.4"}},uc.title||"Untitled Use Case"));
      item.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)",marginTop:"2px"}},uc.type+(uc.actor?" · "+uc.actor:"")));
      sbList.appendChild(item);
    });
    sidebar.appendChild(sbList);
    const sbFoot=h("div",{style:{padding:"8px 12px",borderTop:"1px solid var(--border)",fontSize:"12px",color:"var(--textDim)",textAlign:"center"}});
    sbFoot.textContent=filteredUcs.length+(S.ucSearch||S.ucFilterType!=="All"||S.ucFilterStat!=="All"?" of "+S.useCases.length:"")+" use case"+(filteredUcs.length!==1?"s":"");
    sidebar.appendChild(sbFoot);
    grid.appendChild(sidebar);

    // ─── CENTER: Editor ───
    const center=h("div",{});
    const selUc=S.useCases.find(u=>u.id===S.selUcId);
    if(!selUc){
      const emptyU=h("div",{className:"card",style:{textAlign:"center",padding:"64px 32px"}});
      emptyU.appendChild(h("div",{style:{fontSize:"48px",opacity:".1",marginBottom:"12px"}},"📐"));
      emptyU.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"Select a Use Case"));
      emptyU.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Choose from the sidebar or create a new use case to capture how actors interact with your system in specific scenarios."));
      emptyU.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:addUc},"+ Add Use Case"));
      center.appendChild(emptyU);
    }else{
      // Header
      const eHead=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"}});
      const eHeadLeft=h("div",{style:{display:"flex",alignItems:"center",gap:"10px"}});
      eHeadLeft.appendChild(h("span",{className:"mono",style:{fontSize:"16px",fontWeight:700,color:"var(--accent)"}},selUc.id));
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:"var(--accentDim)",color:"var(--accent)"}},selUc.type));
      const sc=ucStatClr[selUc.status]||"var(--textDim)";
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:sc+"22",color:sc}},selUc.status));
      const pc=ucPriClr[selUc.priority]||"var(--textDim)";
      eHeadLeft.appendChild(h("span",{className:"badge",style:{background:pc+"22",color:pc}},selUc.priority));
      eHead.appendChild(eHeadLeft);
      eHead.appendChild(h("button",{className:"btn btn-danger",style:{padding:"6px 14px",fontSize:"12px"},onClick:()=>deleteUc(selUc.id)},"🗑 Delete"));
      center.appendChild(eHead);

      // Identity card
      const idCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      idCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Use Case Identity"));
      const titleG=h("div",{style:{marginBottom:"10px"}});titleG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Title *"));
      titleG.appendChild(h("input",{id:"uc-title",className:"input",value:selUc.title||"",placeholder:"e.g. Homeowner Arms System Remotely",onInput:e=>updateUcSilent(selUc.id,{title:e.target.value})}));
      idCard.appendChild(titleG);
      const row1=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"10px",marginBottom:"10px"}});
      const typeG=h("div",{});typeG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Type"));
      const typeSel=h("select",{id:"uc-type",className:"input",onChange:e=>updateUc(selUc.id,{type:e.target.value})});
      UC_TYPES.forEach(t=>typeSel.appendChild(h("option",{value:t},t)));typeSel.value=selUc.type;
      typeG.appendChild(typeSel);row1.appendChild(typeG);
      const priG=h("div",{});priG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Priority"));
      const priSel=h("select",{id:"uc-pri",className:"input",onChange:e=>updateUc(selUc.id,{priority:e.target.value})});
      UC_PRIORITIES.forEach(p=>priSel.appendChild(h("option",{value:p},p)));priSel.value=selUc.priority;
      priG.appendChild(priSel);row1.appendChild(priG);
      const statG=h("div",{});statG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Status"));
      const statSel=h("select",{id:"uc-stat",className:"input",onChange:e=>updateUc(selUc.id,{status:e.target.value})});
      UC_STATUSES.forEach(s=>statSel.appendChild(h("option",{value:s},s)));statSel.value=selUc.status;
      statG.appendChild(statSel);row1.appendChild(statG);
      const actG=h("div",{});actG.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Primary Actor"));
      actG.appendChild(h("input",{id:"uc-actor",className:"input",value:selUc.actor||"",placeholder:"e.g. Homeowner",onInput:e=>updateUcSilent(selUc.id,{actor:e.target.value})}));
      row1.appendChild(actG);
      idCard.appendChild(row1);
      center.appendChild(idCard);

      // Scenario card
      const scCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      scCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Scenario"));
      scCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Trigger"));
      scCard.appendChild(h("input",{id:"uc-trigger",className:"input",style:{marginBottom:"10px"},value:selUc.trigger||"",placeholder:"What initiates this use case? e.g. Homeowner opens mobile app",onInput:e=>updateUcSilent(selUc.id,{trigger:e.target.value})}));
      scCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Preconditions"));
      scCard.appendChild(h("textarea",{id:"uc-pre",className:"input",style:{minHeight:"60px",resize:"vertical",marginBottom:"10px"},value:selUc.preconditions||"",placeholder:"What must be true before this use case begins?\ne.g. System is in Armed state, User has valid credentials",onInput:e=>updateUcSilent(selUc.id,{preconditions:e.target.value})}));
      scCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Main Flow (step by step)"));
      scCard.appendChild(h("textarea",{id:"uc-flow",className:"input",style:{minHeight:"120px",resize:"vertical",fontFamily:"var(--mono)",fontSize:"12px",marginBottom:"10px"},value:selUc.mainFlow||"",placeholder:"1. Actor opens the mobile application\n2. System displays current arm/disarm status\n3. Actor taps 'Arm Away' button\n4. System verifies all sensors are in ready state\n5. System arms and confirms via push notification",onInput:e=>updateUcSilent(selUc.id,{mainFlow:e.target.value})}));
      scCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Alternative / Exception Flows"));
      scCard.appendChild(h("textarea",{id:"uc-alt",className:"input",style:{minHeight:"80px",resize:"vertical",fontFamily:"var(--mono)",fontSize:"12px",marginBottom:"10px"},value:selUc.alternativeFlows||"",placeholder:"4a. If sensor not ready: System displays which sensor is open\n4b. If network unavailable: System queues command for retry",onInput:e=>updateUcSilent(selUc.id,{alternativeFlows:e.target.value})}));
      scCard.appendChild(h("label",{style:{fontSize:"11px",color:"var(--textDim)",display:"block",marginBottom:"4px"}},"Postconditions"));
      scCard.appendChild(h("textarea",{id:"uc-post",className:"input",style:{minHeight:"60px",resize:"vertical"},value:selUc.postconditions||"",placeholder:"What is true after this use case completes?\ne.g. System is in Armed Away mode, all sensors actively monitored",onInput:e=>updateUcSilent(selUc.id,{postconditions:e.target.value})}));
      center.appendChild(scCard);

      // Derived Requirements card
      const drCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      drCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Derived Requirements"));
      if(S.reqs.length===0){
        drCard.appendChild(h("div",{style:{padding:"16px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},"No requirements defined yet."));
      }else{
        const drList=h("div",{style:{maxHeight:"200px",overflowY:"auto"}});
        S.reqs.forEach(r=>{
          const isLinked=(selUc.derivedReqs||[]).includes(r.id);
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 8px",borderRadius:"6px",marginBottom:"2px",background:isLinked?"var(--accentDim)22":"transparent"}});
          row.appendChild(h("input",{type:"checkbox",checked:isLinked,onChange:()=>{
            const reqs=[...(selUc.derivedReqs||[])];
            if(isLinked)reqs.splice(reqs.indexOf(r.id),1);else reqs.push(r.id);
            updateUc(selUc.id,{derivedReqs:reqs});
          }}));
          const lbl=h("span",{style:{flex:1,fontSize:"13px",cursor:"pointer"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}});
          lbl.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600,marginRight:"8px"}},r.id));
          lbl.appendChild(document.createTextNode(r.text?r.text.substring(0,70)+(r.text.length>70?"...":""):"(empty)"));
          row.appendChild(lbl);
          drList.appendChild(row);
        });
        drCard.appendChild(drList);
      }
      const drCnt=(selUc.derivedReqs||[]).length;
      if(drCnt>0)drCard.appendChild(h("div",{style:{marginTop:"8px",fontSize:"12px",color:"var(--accent)"}},drCnt+" derived requirement"+(drCnt!==1?"s":"")));
      center.appendChild(drCard);

      // Linked Stakeholders card
      const lsCard=h("div",{className:"card",style:{marginBottom:"14px"}});
      lsCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Linked Stakeholders"));
      if(S.stakeholders.length===0){
        lsCard.appendChild(h("div",{style:{padding:"16px",textAlign:"center",color:"var(--textDim)",fontSize:"13px"}},"No stakeholders defined yet. Add stakeholders in the Stakeholder Register."));
      }else{
        const lsList=h("div",{style:{maxHeight:"160px",overflowY:"auto"}});
        S.stakeholders.forEach(s=>{
          const isLinked=(selUc.linkedStakeholders||[]).includes(s.id);
          const row=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 8px",borderRadius:"6px",marginBottom:"2px",background:isLinked?"var(--accentDim)22":"transparent"}});
          row.appendChild(h("input",{type:"checkbox",checked:isLinked,onChange:()=>{
            const stks=[...(selUc.linkedStakeholders||[])];
            if(isLinked)stks.splice(stks.indexOf(s.id),1);else stks.push(s.id);
            updateUc(selUc.id,{linkedStakeholders:stks});
          }}));
          row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600,fontSize:"12px",minWidth:"60px"}},s.id));
          row.appendChild(h("span",{style:{flex:1,fontSize:"13px"}},s.name||"Unnamed"));
          row.appendChild(h("span",{className:"badge",style:{fontSize:"10px",background:"var(--accentDim)",color:"var(--accent)"}},s.role));
          lsList.appendChild(row);
        });
        lsCard.appendChild(lsList);
      }
      center.appendChild(lsCard);

      // Notes card
      const notesCard=h("div",{className:"card"});
      notesCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--textDim)",marginBottom:"10px",textTransform:"uppercase",letterSpacing:".06em"}},"Notes"));
      notesCard.appendChild(h("textarea",{id:"uc-notes",className:"input",style:{minHeight:"60px",resize:"vertical"},value:selUc.notes||"",placeholder:"Additional notes, assumptions, or open questions...",onInput:e=>updateUcSilent(selUc.id,{notes:e.target.value})}));
      center.appendChild(notesCard);
    }
    grid.appendChild(center);

    // ─── RIGHT: Summary Panel ───
    const right=h("div",{});
    const summaryPanel=h("div",{style:{position:"sticky",top:"80px"}});

    // Type Overview
    const typeCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    typeCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Type"));
    const ucTypeCounts={};S.useCases.forEach(u=>{ucTypeCounts[u.type]=(ucTypeCounts[u.type]||0)+1;});
    const sortedUcTypes=Object.entries(ucTypeCounts).sort((a,b)=>b[1]-a[1]);
    if(sortedUcTypes.length===0){
      typeCard.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",textAlign:"center",padding:"8px"}},"No data"));
    }
    sortedUcTypes.forEach(([type,cnt])=>{
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},type));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      typeCard.appendChild(row);
    });
    summaryPanel.appendChild(typeCard);

    // Status grid
    const statCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    statCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Status"));
    const sGrid=h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"}});
    UC_STATUSES.forEach(st=>{
      const cnt=S.useCases.filter(u=>u.status===st).length;
      const clr=ucStatClr[st]||"var(--textDim)";
      const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"8px",textAlign:"center"}});
      box.appendChild(h("div",{className:"mono",style:{fontSize:"18px",fontWeight:700,color:clr}},String(cnt)));
      box.appendChild(h("div",{style:{fontSize:"11px",color:"var(--textDim)"}},st));
      sGrid.appendChild(box);
    });
    statCard.appendChild(sGrid);
    summaryPanel.appendChild(statCard);

    // Priority grid
    const priCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    priCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"By Priority"));
    const pGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"6px"}});
    UC_PRIORITIES.forEach(p=>{
      const cnt=S.useCases.filter(u=>u.priority===p).length;
      const clr=ucPriClr[p]||"var(--textDim)";
      const box=h("div",{style:{background:clr+"15",borderRadius:"8px",padding:"8px",textAlign:"center"}});
      box.appendChild(h("div",{className:"mono",style:{fontSize:"16px",fontWeight:700,color:clr}},String(cnt)));
      box.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)"}},p));
      pGrid.appendChild(box);
    });
    priCard.appendChild(pGrid);
    summaryPanel.appendChild(priCard);

    // Actor summary
    const actorCard=h("div",{className:"card",style:{marginBottom:"14px"}});
    actorCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,marginBottom:"10px"}},"Actors"));
    const actorCounts={};S.useCases.forEach(u=>{if(u.actor)actorCounts[u.actor]=(actorCounts[u.actor]||0)+1;});
    const sortedActors=Object.entries(actorCounts).sort((a,b)=>b[1]-a[1]);
    if(sortedActors.length===0){
      actorCard.appendChild(h("div",{style:{color:"var(--textDim)",fontSize:"12px",textAlign:"center",padding:"8px"}},"No actors defined"));
    }
    sortedActors.forEach(([actor,cnt])=>{
      const row=h("div",{style:{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:"12px"}});
      row.appendChild(h("span",{style:{color:"var(--text)"}},actor));
      row.appendChild(h("span",{className:"mono",style:{color:"var(--accent)",fontWeight:600}},String(cnt)));
      actorCard.appendChild(row);
    });
    summaryPanel.appendChild(actorCard);

    // Coverage — use cases without derived requirements
    const noReqUcs=S.useCases.filter(u=>(u.derivedReqs||[]).length===0);
    if(noReqUcs.length>0){
      const covCard=h("div",{className:"card",style:{background:"var(--warn)11",borderColor:"var(--warn)33"}});
      covCard.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--warn)",marginBottom:"8px"}},"⚠ No Derived Reqs ("+noReqUcs.length+")"));
      covCard.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",marginBottom:"8px"}},"Use cases not linked to any requirements:"));
      const tags=h("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"}});
      noReqUcs.forEach(u=>tags.appendChild(h("span",{className:"badge",style:{background:"var(--warn)22",color:"var(--warn)",cursor:"pointer"},onClick:()=>{S.selUcId=u.id;render();}},u.id)));
      covCard.appendChild(tags);
      summaryPanel.appendChild(covCard);
    }else if(S.useCases.length>0){
      const covOk=h("div",{className:"card",style:{background:"var(--success)11",borderColor:"var(--success)33"}});
      covOk.appendChild(h("div",{style:{fontSize:"12px",fontWeight:600,color:"var(--success)"}},"✓ All "+S.useCases.length+" use cases have derived requirements"));
      summaryPanel.appendChild(covOk);
    }

    right.appendChild(summaryPanel);
    grid.appendChild(right);
    main.appendChild(grid);
  }

  // ═══ V&V ═══
  if(S.view==="vv"){
    main.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"20px"}},"Verification & Validation Planning"));
    if(S.reqs.length===0){
      const emptyVV=h("div",{className:"card",style:{textAlign:"center",padding:"48px 32px"}});
      emptyVV.appendChild(h("div",{style:{fontSize:"40px",opacity:".1",marginBottom:"12px"}},"✓"));
      emptyVV.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"15px",fontWeight:600,marginBottom:"8px"}},"No V&V Data"));
      emptyVV.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.6",marginBottom:"16px"}},"Add requirements with verification methods to plan your Verification & Validation activities."));
      emptyVV.appendChild(h("button",{className:"btn btn-pri",style:{padding:"8px 20px"},onClick:()=>setState({view:"editor"})},"Go to Author →"));
      main.appendChild(emptyVV);
    }
    else{
      const vGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"14px",marginBottom:"24px"}});
      const vClrs={Test:"var(--accent)",Analysis:"var(--purple)",Inspection:"var(--warn)",Demonstration:"var(--teal)"};
      const vIcons={Test:"🧪",Analysis:"📐",Inspection:"🔍",Demonstration:"▶"};
      V_METHODS.forEach(m=>{
        const cnt=S.reqs.filter(r=>r.verification===m).length;
        const card=h("div",{className:"card",style:{textAlign:"center"}});
        card.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",textTransform:"uppercase",fontWeight:600}},vIcons[m]+" "+m));
        card.appendChild(h("div",{className:"mono",style:{fontSize:"36px",fontWeight:700,color:vClrs[m],marginTop:"6px"}},String(cnt)));
        card.appendChild(h("div",{style:{fontSize:"12px",color:"var(--textDim)",marginTop:"2px"}},(S.reqs.length?Math.round(cnt/S.reqs.length*100):0)+"% of total"));
        vGrid.appendChild(card);
      });
      main.appendChild(vGrid);

      // Requirements grouped by verification method
      V_METHODS.forEach(m=>{
        const mReqs=S.reqs.filter(r=>r.verification===m);
        if(!mReqs.length)return;
        const sec=h("div",{className:"card",style:{marginBottom:"14px"}});
        const secHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}});
        secHdr.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},
          h("div",{style:{width:"4px",height:"20px",borderRadius:"2px",background:vClrs[m]}}),
          h("h3",{style:{fontSize:"14px",fontWeight:600}},vIcons[m]+" "+m),
          h("span",{className:"mono",style:{fontSize:"12px",color:"var(--textDim)"}},mReqs.length+" requirement"+(mReqs.length!==1?"s":""))));
        sec.appendChild(secHdr);
        mReqs.forEach((r,idx)=>{
          const a=analyze(r.text);const sc=a.score>=80?"var(--success)":a.score>=60?"var(--warn)":"var(--danger)";
          const stC=r.status==="Approved"?"var(--success)":r.status==="Reviewed"?"var(--purple)":"var(--warn)";
          const row=h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 80px 70px 55px",gap:"8px",padding:"10px 12px",background:idx%2===0?"var(--surface)":"transparent",borderRadius:"6px",alignItems:"center",cursor:"pointer",transition:"background .1s",fontSize:"13px"},onClick:()=>{S.selId=r.id;setState({view:"editor"});}});
          row.addEventListener("mouseenter",()=>row.style.background="var(--cardHov)");
          row.addEventListener("mouseleave",()=>row.style.background=idx%2===0?"var(--surface)":"transparent");
          row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--accent)",fontWeight:600}},r.id));
          row.appendChild(h("span",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"var(--text)"}},r.text||"(empty)"));
          row.appendChild(h("span",{style:{fontSize:"12px",color:"var(--textMid)"}},r.level.replace(" Requirement","").replace("Stakeholder ","STK ")));
          row.appendChild(h("span",{className:"badge",style:{background:stC+"22",color:stC}},r.status));
          row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:sc,fontWeight:700,textAlign:"right"}},a.score+"%"));
          sec.appendChild(row);
        });
        main.appendChild(sec);
      });

      // Unassigned (requirements with default "Test" that might need review)
      const noVerif=S.reqs.filter(r=>!r.verification||r.verification==="Test");
      if(noVerif.length>0){
        const hint=h("div",{style:{padding:"12px 16px",background:"var(--warn)11",borderRadius:"10px",border:"1px solid var(--warn)33",fontSize:"13px",color:"var(--textMid)",lineHeight:"1.5"}});
        hint.textContent="💡 "+noVerif.length+" requirement"+(noVerif.length!==1?"s":"")+" use the default \"Test\" method. Review these in the Author view to confirm the appropriate verification approach.";
        main.appendChild(hint);
      }
    }
  }

  // ═══ RULES REF ═══
  if(S.view==="rules"){
    const rulesHdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"20px"}});
    const rulesLeft=h("div",{});
    rulesLeft.appendChild(h("h2",{style:{fontSize:"20px",fontWeight:700,marginBottom:"4px"}},"INCOSE GtWR v4 — 42 Rules Reference"));
    rulesLeft.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"13px"}},"14 categories · Adjust weights to prioritize rules for your project context."));
    rulesHdr.appendChild(rulesLeft);

    // Active/disabled count
    const activeCount=RULES.filter(r=>(S.ruleWeights[r.id]||0)>0).length;
    const customCount=RULES.filter(r=>S.ruleWeights[r.id]!==1).length;
    const statBadges=h("div",{style:{display:"flex",gap:"6px",alignItems:"center"}});
    statBadges.appendChild(h("span",{className:"badge",style:{background:"var(--accent)22",color:"var(--accent)"}},activeCount+"/42 active"));
    if(customCount>0)statBadges.appendChild(h("span",{className:"badge",style:{background:"var(--purple)22",color:"var(--purple)"}},customCount+" customized"));
    rulesHdr.appendChild(statBadges);
    main.appendChild(rulesHdr);

    // Preset profiles card
    const presetCard=h("div",{className:"card",style:{marginBottom:"16px"}});
    presetCard.appendChild(h("div",{style:{fontSize:"13px",fontWeight:600,marginBottom:"10px",color:"var(--accent)"}},"⚡ Weight Presets"));
    const presetGrid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:"8px"}});
    Object.entries(WEIGHT_PRESETS).forEach(([key,preset])=>{
      const isActive=JSON.stringify(S.ruleWeights)===JSON.stringify(preset.weights);
      const pBtn=h("div",{style:{padding:"12px",borderRadius:"10px",border:"1px solid "+(isActive?"var(--accent)":"var(--border)"),background:isActive?"var(--accentDim)22":"transparent",cursor:"pointer",transition:"all .15s"},onClick:()=>{S.ruleWeights={...preset.weights};saveRuleWeights();render();}});
      pBtn.addEventListener("mouseenter",()=>{if(!isActive)pBtn.style.borderColor="var(--accent)";});
      pBtn.addEventListener("mouseleave",()=>{if(!isActive)pBtn.style.borderColor="var(--border)";});
      pBtn.appendChild(h("div",{style:{fontSize:"12px",fontWeight:700,color:isActive?"var(--accent)":"var(--text)",marginBottom:"4px"}},preset.name));
      pBtn.appendChild(h("div",{style:{fontSize:"10px",color:"var(--textDim)",lineHeight:"1.4"}},preset.desc));
      presetGrid.appendChild(pBtn);
    });
    presetCard.appendChild(presetGrid);
    main.appendChild(presetCard);

    // Legend
    const legend=h("div",{style:{display:"flex",gap:"12px",marginBottom:"16px",fontSize:"11px",alignItems:"center"}});
    legend.appendChild(h("span",{style:{color:"var(--textDim)",fontWeight:600}},"Weights:"));
    Object.entries(WEIGHT_LABELS).forEach(([val,label])=>{
      const lItem=h("div",{style:{display:"flex",alignItems:"center",gap:"4px"}});
      lItem.appendChild(h("div",{style:{width:"8px",height:"8px",borderRadius:"2px",background:WEIGHT_COLORS[val]}}));
      lItem.appendChild(h("span",{style:{color:WEIGHT_COLORS[val]}},label+" ("+val+"×)"));
      legend.appendChild(lItem);
    });
    main.appendChild(legend);

    // Rules by category
    CATS.forEach(cat=>{
      const cr=RULES.filter(r=>r.cat===cat.nm);if(!cr.length)return;
      const card=h("div",{className:"card",style:{marginBottom:"12px"}});
      const ch=h("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"14px"}});
      ch.appendChild(h("div",{style:{width:"3px",height:"22px",borderRadius:"2px",background:cat.c}}));
      ch.appendChild(h("h3",{style:{fontSize:"15px",fontWeight:700}},cat.nm));
      ch.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:"var(--textDim)"}},cat.r));
      // Category avg weight
      const catAvg=cr.reduce((s,r)=>s+(S.ruleWeights[r.id]??1),0)/cr.length;
      ch.appendChild(h("span",{className:"badge",style:{fontSize:"9px",background:catAvg>1.5?"var(--accent)22":catAvg===0?"var(--textDim)22":"var(--text)22",color:catAvg>1.5?"var(--accent)":catAvg===0?"var(--textDim)":"var(--text)"}},catAvg.toFixed(1)+"× avg"));
      card.appendChild(ch);
      cr.forEach(rule=>{
        const rw=S.ruleWeights[rule.id]??1;
        const row=h("div",{style:{display:"grid",gridTemplateColumns:"50px 150px 1fr 180px",gap:"10px",padding:"8px 14px",background:rw===0?"var(--surface)55":"var(--surface)",borderRadius:"8px",alignItems:"center",marginBottom:"4px",opacity:rw===0?.5:1,transition:"opacity .15s"}});
        row.appendChild(h("span",{className:"mono",style:{fontSize:"12px",color:cat.c,fontWeight:700}},rule.id));
        row.appendChild(h("span",{style:{fontSize:"12px",fontWeight:600,color:"var(--text)"}},rule.nm));
        row.appendChild(h("span",{style:{fontSize:"12px",color:"var(--textMid)"}},rule.desc));
        // Weight selector
        const wSel=h("div",{style:{display:"flex",gap:"2px"}});
        [0,0.5,1,2,3].forEach(wv=>{
          const isW=rw===wv;
          const btn=h("button",{style:{padding:"3px 8px",borderRadius:"5px",border:"1px solid "+(isW?WEIGHT_COLORS[wv]+"88":"var(--border)"),background:isW?WEIGHT_COLORS[wv]+"22":"transparent",color:isW?WEIGHT_COLORS[wv]:"var(--textDim)",fontSize:"10px",fontWeight:isW?700:400,cursor:"pointer",transition:"all .1s",fontFamily:"inherit"},onClick:()=>{S.ruleWeights[rule.id]=wv;saveRuleWeights();render();}},WEIGHT_LABELS[wv]);
          if(!isW){btn.addEventListener("mouseenter",()=>{btn.style.borderColor=WEIGHT_COLORS[wv];});btn.addEventListener("mouseleave",()=>{btn.style.borderColor="var(--border)";});}
          wSel.appendChild(btn);
        });
        row.appendChild(wSel);
        card.appendChild(row);
      });
      main.appendChild(card);
    });
  }

  // ═══ GLOSSARY ═══
  if(S.view==="glossary"){
    const ghdr=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}});
    ghdr.appendChild(h("div",{},h("h2",{style:{fontSize:"20px",fontWeight:700}},"Project Glossary"),h("p",{style:{color:"var(--textDim)",fontSize:"13px",marginTop:"2px"}},"Per R4 (Defined Terms) & R36 (Consistent Terms) · "+S.glossary.length+" term"+(S.glossary.length!==1?"s":""))));
    const ghdrRight=h("div",{style:{display:"flex",gap:"8px",alignItems:"center"}});
    ghdrRight.appendChild(h("input",{id:"gloss-search-input",className:"input",style:{width:"200px",fontSize:"13px"},placeholder:"🔍 Search terms...",value:S.glossSearch||"",onInput:e=>{S.glossSearch=e.target.value;render();}}));
    ghdrRight.appendChild(h("button",{className:"btn btn-pri",onClick:()=>{History.save();S.glossary.push({term:"",def:""});render();}},"+ Add Term"));
    ghdr.appendChild(ghdrRight);
    main.appendChild(ghdr);

    // Filter and sort
    const filteredGloss=S.glossSearch?S.glossary.map((g,i)=>({...g,idx:i})).filter(g=>
      g.term.toLowerCase().includes(S.glossSearch.toLowerCase())||
      g.def.toLowerCase().includes(S.glossSearch.toLowerCase())
    ):S.glossary.map((g,i)=>({...g,idx:i}));
    const sortedGloss=[...filteredGloss].sort((a,b)=>{
      if(!a.term&&!b.term)return 0;if(!a.term)return 1;if(!b.term)return -1;
      return a.term.toLowerCase().localeCompare(b.term.toLowerCase());
    });

    const gCard=h("div",{className:"card",style:{padding:0,overflow:"hidden"}});
    const gHdr=h("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr 50px",gap:"14px",padding:"12px 20px",background:"var(--surface)",fontSize:"12px",fontWeight:700,color:"var(--textDim)",textTransform:"uppercase",letterSpacing:".06em"}});
    ["Term","Definition",""].forEach(t=>gHdr.appendChild(h("div",{},t)));gCard.appendChild(gHdr);
    sortedGloss.forEach(g=>{
      const row=h("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr 50px",gap:"14px",padding:"10px 20px",borderTop:"1px solid var(--border)",alignItems:"center"}});
      row.appendChild(h("input",{className:"input",style:{fontWeight:600},value:g.term,placeholder:"Term",onInput:e=>{S.glossary[g.idx].term=e.target.value;autoSave();}}));
      row.appendChild(h("input",{className:"input",value:g.def,placeholder:"Definition",onInput:e=>{S.glossary[g.idx].def=e.target.value;autoSave();}}));
      row.appendChild(h("button",{className:"btn btn-danger",style:{padding:"4px 8px",fontSize:"12px"},onClick:()=>{History.save();S.glossary.splice(g.idx,1);autoSave();render();}},"✕"));
      gCard.appendChild(row);
    });
    if(sortedGloss.length===0){
      const emptyG=h("div",{style:{padding:"36px 20px",textAlign:"center"}});
      if(S.glossSearch){
        emptyG.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px"}},"No terms match \""+S.glossSearch+"\"."));
      }else{
        emptyG.appendChild(h("div",{style:{fontSize:"32px",opacity:".1",marginBottom:"8px"}},"📖"));
        emptyG.appendChild(h("p",{style:{color:"var(--textMid)",fontSize:"14px",fontWeight:600,marginBottom:"6px"}},"No Glossary Terms"));
        emptyG.appendChild(h("p",{style:{color:"var(--textDim)",fontSize:"13px",lineHeight:"1.5"}},"Define project-specific terms to ensure consistency across your requirements (INCOSE R4, R36)."));
      }
      gCard.appendChild(emptyG);
    }
    main.appendChild(gCard);
  }

  app.appendChild(main);

  // Footer
  if(S.view!=="welcome"){
    const footer=h("footer",{style:{padding:"14px 28px",borderTop:"1px solid var(--borderHi)",display:"flex",justifyContent:"space-between",fontSize:"12px",color:"var(--textMid)"}});
    const footerLeft=h("div",{});
    footerLeft.appendChild(document.createTextNode("ReqRight v2.6.0 · Based on INCOSE® GtWR v4 · ISO/IEC/IEEE 29148 · 15288 · "));
    const helpLink=h("a",{href:"https://github.com/ssaleem74/reqright#readme",target:"_blank",style:{color:"var(--accent)",textDecoration:"none"}},"Help & Tutorial");
    footerLeft.appendChild(helpLink);
    footerLeft.appendChild(document.createTextNode(" · "));
    const discLink=h("a",{href:"https://github.com/ssaleem74/reqright/blob/main/DISCLAIMER.md",target:"_blank",style:{color:"var(--textMid)",textDecoration:"none"}},"Disclaimer");
    footerLeft.appendChild(discLink);
    footerLeft.appendChild(document.createTextNode(" · "));
    const privLink=h("a",{href:"https://github.com/ssaleem74/reqright/blob/main/PRIVACY.md",target:"_blank",style:{color:"var(--textMid)",textDecoration:"none"}},"Privacy");
    footerLeft.appendChild(privLink);
    footer.appendChild(footerLeft);
    footer.appendChild(h("div",{},S.reqs.length+" requirement"+(S.reqs.length!==1?"s":"")+(S.risks.length?" · "+S.risks.length+" risk"+(S.risks.length!==1?"s":""):"")+(S.decisions.length?" · "+S.decisions.length+" decision"+(S.decisions.length!==1?"s":""):"")+(S.stakeholders.length?" · "+S.stakeholders.length+" stakeholder"+(S.stakeholders.length!==1?"s":""):"")+(S.interfaces.length?" · "+S.interfaces.length+" interface"+(S.interfaces.length!==1?"s":""):"")+(S.useCases.length?" · "+S.useCases.length+" use case"+(S.useCases.length!==1?"s":""):"")+" · Auto-saved in browser"));
    app.appendChild(footer);
  }

  // Restore focus after DOM rebuild
  if(_fId){const el=document.getElementById(_fId);if(el){el.focus();try{if(typeof _fStart==="number"&&el.setSelectionRange)el.setSelectionRange(_fStart,_fEnd);}catch(e){}}}
}

// ─── INIT ─────────────────────────────────────────────────
render();
</script>
</body>
</html>
